<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-12 MySQL构架设计与容量规划]]></title>
      <url>/2017/04/13/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/12-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="用sysbench压测mysql通过orzdba监控工具分析机器的容量"><a href="#用sysbench压测MySQL，通过orzdba监控工具分析机器的容量" class="headerlink" title="用sysbench压测MySQL，通过orzdba监控工具分析机器的容量"></a>用sysbench压测MySQL，通过orzdba监控工具分析机器的容量</h2><h3 id="编译安装sysbench"><a href="#编译安装sysbench" class="headerlink" title="编译安装sysbench"></a>编译安装sysbench</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装依赖包（在上节中的mha机器上安装）</span></span>
<span class="line">yum -<span class="keyword">y</span> install make automake libtool pkgconfig libaio-devel vim-common</span>
<span class="line">yum -<span class="keyword">y</span> install mysql-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译源码安装，下载地址：https://codeload.github.com/akopytov/Sysbench/zip/1.0.5</span></span>
<span class="line">unzip sysbench-<span class="number">1.0</span>.<span class="number">5</span>.zip</span>
<span class="line">cd sysbench-<span class="number">1.0</span>.<span class="number">5</span></span>
<span class="line">./autogen.sh</span>
<span class="line">./configure --with-mysql-includes=<span class="regexp">/usr/include</span><span class="regexp">/mysql --with-mysql-libs=/usr</span><span class="regexp">/lib64/mysql</span>   <span class="comment"># 注意修改路径</span></span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="在压测的mysql上创建一个空的test数据库"><a href="#在压测的MySQL上创建一个空的test数据库" class="headerlink" title="在压测的MySQL上创建一个空的test数据库"></a>在压测的MySQL上创建一个空的test数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 已有test库的话先drop掉</span></span>
<span class="line">drop database test;</span>
<span class="line">create database test;</span>
</pre></td></tr></table></figure>
<h3 id="在压测的mysql机开启orzdba监控工具"><a href="#在压测的MySQL机开启orzdba监控工具" class="headerlink" title="在压测的MySQL机开启orzdba监控工具"></a>在压测的MySQL机开启orzdba监控工具</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建压测MySQL用户（不要加密码）</span></span>
<span class="line">grant all privileges on *.* to <span class="string">'lyj'</span>@'localhost<span class="string">' identified by '</span><span class="string">';</span>
<span class="line">grant all privileges on *.* to '</span>lyj<span class="string">'@'</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' identified by '</span><span class="string">';</span>
<span class="line"></span>
<span class="line"># orzdba下载地址：http://pan.baidu.com/S/1migCOa8</span>
<span class="line">vi orzdba</span>
<span class="line">#---------------------------------------------------------</span>
<span class="line">my $user = '</span>lyj<span class="string">';     # -u   : mysql user</span>
<span class="line">my $MYSQL    = qq&#123;mysql -s --skip-column-names -u$user -P$port &#125;;</span>
<span class="line">#---------------------------------------------------------</span>
<span class="line">chmod +x orzdba</span>
<span class="line"></span>
<span class="line">./orzdba -lazy</span>
<span class="line">#-------------------------------------------------------------------------------------------------------------------------------</span>
<span class="line">.=================================================.</span>
<span class="line">|       Welcome to use the orzdba tool !          | </span>
<span class="line">|          Yep...Chinese English~                 |</span>
<span class="line">'</span>=============== Date : <span class="number">2017</span>-<span class="number">04</span>-<span class="number">13</span> ===============<span class="string">'</span>
<span class="line"></span>
<span class="line">HOST: mydb1   IP: 10.245.231.202</span>
<span class="line">DB  : edu|lyj|lyj1|performance_schema</span>
<span class="line">Var : port[3306] read_only[OFF] version[5.6.35-log] </span>
<span class="line">      </span>
<span class="line">      binlog_format[ROW] max_binlog_cache_size[2G] max_binlog_size[500M] </span>
<span class="line">      max_connect_errors[100] max_connections[214] max_user_connections[2800] </span>
<span class="line">      open_files_limit[1024] sync_binlog[100] table_definition_cache[600] </span>
<span class="line">      table_open_cache[400] thread_cache_size[10] </span>
<span class="line"></span>
<span class="line">      innodb_adaptive_flushing[ON] innodb_adaptive_hash_index[ON] innodb_buffer_pool_instances[8] </span>
<span class="line">      innodb_buffer_pool_size[128M] innodb_file_per_table[ON] innodb_flush_log_at_trx_commit[1] </span>
<span class="line">      innodb_flush_method[O_DIRECT] innodb_io_capacity[1000] innodb_lock_wait_timeout[10] </span>
<span class="line">      innodb_log_buffer_size[64M] innodb_log_file_size[1000M] innodb_log_files_in_group[4] </span>
<span class="line">      innodb_max_dirty_pages_pct[60] innodb_open_files[400] innodb_read_io_threads[4] </span>
<span class="line">      innodb_stats_on_metadata[OFF] innodb_thread_concurrency[0] innodb_write_io_threads[10] </span>
<span class="line">      </span>
<span class="line"></span>
<span class="line">-------- -----load-avg---- ---cpu-usage--- ---swap---                     -QPS- -TPS-         -Hit%- ------threads------ </span>
<span class="line">  time  |  1m    5m   15m |usr sys idl iow|   si   so|  ins   upd   del    sel   iud|     lor    hit| run  con  cre  cac|</span>
<span class="line">15:02:05| 0.00  0.01  0.05|  0   0 100   0|    0    0|    0     0     0      0     0|       0 100.00|   0    0    0    0|</span>
<span class="line">#-------------------------------------------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="在装sysbench机上执行压测命令"><a href="#在装sysbench机上执行压测命令" class="headerlink" title="在装sysbench机上执行压测命令"></a>在装sysbench机上执行压测命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># prepare准备阶段，构建压测环境</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/Share/Sysbench/tests/include/oltp_legacy/Select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">20000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Creating table <span class="string">'sbtest1'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest1'</span></span>
<span class="line">Creating secondary indexes on <span class="string">'sbtest1'</span>...</span>
<span class="line">Creating table <span class="string">'sbtest2'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest2'</span></span>
<span class="line">Creating secondary indexes on <span class="string">'sbtest2'</span>...</span>
<span class="line">Creating table <span class="string">'sbtest3'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest3'</span></span>
<span class="line">......</span>
<span class="line">Creating table <span class="string">'sbtest20'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest20'</span></span>
<span class="line">Creating secondary indexes on <span class="string">'sbtest20'</span>...</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 开始压测</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/Share/Sysbench/tests/include/oltp_legacy/Select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">20000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> run</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Running the test with following options:</span>
<span class="line">Number of threads: <span class="number">2</span></span>
<span class="line">Report intermediate results every <span class="number">10</span> second(<span class="keyword">s</span>)</span>
<span class="line">Initializing random number generator from current <span class="keyword">time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Initializing worker threads...</span>
<span class="line"></span>
<span class="line">Threads started!</span>
<span class="line"></span>
<span class="line">[ <span class="number">10</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">5987.78</span> qps: <span class="number">5987.78</span> (r/w/o: <span class="number">5987.78</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">41</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">20</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7711.35</span> qps: <span class="number">7711.35</span> (r/w/o: <span class="number">7711.35</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">35</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">30</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7751.22</span> qps: <span class="number">7751.22</span> (r/w/o: <span class="number">7751.22</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">35</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">40</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7710.81</span> qps: <span class="number">7710.81</span> (r/w/o: <span class="number">7710.81</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">39</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">50</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">10138.07</span> qps: <span class="number">10138.07</span> (r/w/o: <span class="number">10138.07</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">31</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">60</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">8729.18</span> qps: <span class="number">8729.18</span> (r/w/o: <span class="number">8729.18</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">33</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line"></span>
<span class="line">SQL statistics:</span>
<span class="line">    queries performed:</span>
<span class="line">        <span class="keyword">read</span>:                            <span class="number">480290</span></span>
<span class="line">        <span class="keyword">write</span>:                           <span class="number">0</span></span>
<span class="line">        other:                           <span class="number">0</span></span>
<span class="line">        total:                           <span class="number">480290</span></span>
<span class="line">    transactions:                        <span class="number">480290</span> (<span class="number">8004.05</span> per sec.)</span>
<span class="line">    queries:                             <span class="number">480290</span> (<span class="number">8004.05</span> per sec.)</span>
<span class="line">    ignored errors:                      <span class="number">0</span>      (<span class="number">0</span>.<span class="number">00</span> per sec.)</span>
<span class="line">    reconnects:                          <span class="number">0</span>      (<span class="number">0</span>.<span class="number">00</span> per sec.)</span>
<span class="line"></span>
<span class="line">General statistics:</span>
<span class="line">    total <span class="keyword">time</span>:                          <span class="number">60.0012</span><span class="keyword">s</span></span>
<span class="line">    total number of events:              <span class="number">480290</span></span>
<span class="line"></span>
<span class="line">Latency (ms):</span>
<span class="line">         min:                                  <span class="number">0</span>.<span class="number">12</span></span>
<span class="line">         avg:                                  <span class="number">0</span>.<span class="number">25</span></span>
<span class="line">         max:                                  <span class="number">8.10</span></span>
<span class="line">         <span class="number">95</span>th percentile:                      <span class="number">0</span>.<span class="number">38</span></span>
<span class="line">         sum:                             <span class="number">119006.64</span></span>
<span class="line"></span>
<span class="line">Threads fairness:</span>
<span class="line">    events (avg/stddev):           <span class="number">240145.0000</span>/<span class="number">594.00</span></span>
<span class="line">    execution <span class="keyword">time</span> (avg/stddev):   <span class="number">59.5033</span>/<span class="number">0</span>.<span class="number">00</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="通过orzdba监控工具分析查看机器的容量"><a href="#通过orzdba监控工具分析查看机器的容量" class="headerlink" title="通过orzdba监控工具分析查看机器的容量"></a>通过orzdba监控工具分析查看机器的容量</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/0413_sysbench_01.png" alt=""></p>
<h2 id="分库分表架构设计"><a href="#分库分表架构设计" class="headerlink" title="分库分表架构设计"></a>分库分表架构设计</h2><p>问题：在订单表中（分库分表），有70%查询是通过主键和userId字段查询(userId是分库分表策略字段)，有20%要通过order_num（订单号）查数据。</p>
<p><font color="red"><b>1. 请问order_num（订单号）要怎么设计才能快速找到订单记录是在哪个库的哪个表？</b></font><br>在订单号<code>order_num</code>中加入库序号和表序号，通过userid可以算出库序号和表序号，计算公式如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">中间变量=userId%(库数量*每个库的表数量)</span>
<span class="line">库序号=中间变量/每个库的表数量</span>
<span class="line">表序号=中间变量%每个库的表数量</span>
</pre></td></tr></table></figure></p>
<p><font color="red"><b>2. 有10%是非主键字段（比如：字段、渠道、商品，档期，品牌，收件人信息、金额等字段）去查记录，非主键字段要怎么设计才能快速定位到记录？</b></font><br>可以建立非主键字段索引表，索引表是主建与非主键字段的对应关系表，可根据非主键进行哈希取模，放到分库里面。在使用非主键字段进行查询时，先查出非主键对应的主键，再根据主键去对应的库表中查询订单数据。</p>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="容量评估4个重要指标"><a href="#容量评估4个重要指标：" class="headerlink" title="容量评估4个重要指标："></a>容量评估4个重要指标：</h3><ol>
<li>LOAD：服务器的负载，在Linux中可以通过top命令查看<code>load average</code></li>
<li>CPU：CPU的使用率，在Linux中可以通过<code>top</code>和<code>cat /proc/Stat</code>命令查看</li>
<li>QPS：<code>Queries Per Second</code>意思是“每秒查询率”，是一台服务器每秒能够相应的查询次数，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。</li>
<li>TPS：<code>Transactions PerSecond</code>，也就是事务数/秒。它是软件测试结果的测量单位。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数，最终利用这些信息来估计得分。客户机使用加权协函数平均方法来计算客户机的得分，测试软件就是利用客户机的这些信息使用加权协函数平均方法来计算服务器端的整体TPS得分。</li>
</ol>
<h3 id="容量评估-qps评估"><a href="#容量评估-QPS评估" class="headerlink" title="容量评估-QPS评估"></a>容量评估-QPS评估</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">峰值QPS=(总的PV * <span class="number">80</span>%)/(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">20</span>%)</span>
<span class="line">机器数=总的峰值QPS/压测得出的单台机器极限QPS</span>
</pre></td></tr></table></figure>
<h3 id="mysql构架设计"><a href="#MySQL构架设计" class="headerlink" title="MySQL构架设计"></a>MySQL构架设计</h3><h4 id="读写分离方案"><a href="#读写分离方案" class="headerlink" title="读写分离方案"></a>读写分离方案</h4><ul>
<li>海量数据的存储及访问，通过对数据库进行读写分离，来提升数据的处理能力。读写分离它的方案特点是数据库产生多个副本，数据库的写操作都集中到一个数据库上，而一些读的操作呢，可以分解到其它数据库上。这样，只要付出数据复制的成本，就可以使得数据库的处理压力分解到多个数据库上，从而大大提升数据处理能力。</li>
<li>优点：由于所有的数据库副本，都有数据的全拷贝，因此所有的数据库特性都可以实现，部分机器当机不影响系统的使用。</li>
<li>缺点：数据的复制同步是一个问题，要么采用数据库自身的复制方案，要么自行实现数据复制方案。需要考虑数据的迟滞性，一致性方面的问题。</li>
</ul>
<h4 id="数据分区分库方案"><a href="#数据分区（分库）方案" class="headerlink" title="数据分区（分库）方案"></a>数据分区（分库）方案</h4><ul>
<li>原来所有的数据都是在一个数据库上的，网络IO及文件IO都集中在一个数据库上的，因此CPU、内存、文件IO、网络IO都可能会成为系统瓶颈。而分区的方案就是把某一个或某几张相关的表的数据放在一个独立的数据库上，这样就可以把CPU、内存、文件IO、网络IO分解到多个机器中，从而提升系统处理能力。</li>
<li>优点：不存在数据库副本复制，性能更高。</li>
<li>缺点：分区策略必须经过充分考虑，避免多个分区之间的数据存在关联关系，每个分区都是单点，如果某个分区宕机，就会影响到系统的使用。</li>
</ul>
<h4 id="数据分表方案"><a href="#数据分表方案" class="headerlink" title="数据分表方案"></a>数据分表方案</h4><ul>
<li>不管是上面的读写分离方案还是数据分区方案，当数据量大到一定程度的时候，都会导致处理性能的不足，这个时候就没有办法了，只能进行分表处理。也就是把数据库当中数据根据按照分库原则分到多个数据表当中，这样，就可以把大表变成多个小表，不同的分表中数据不重复，从而提高处理效率。</li>
<li>优点：数据不存在多个副本，不必进行数据复制，性能更高。</li>
<li>缺点：分表之间的数据很少进行集合运算；分表都是单点，如果某个分表宕机，如果使用的数据不在此分表，不影响使用。</li>
</ul>
<p><strong>当单库单表无法满足大量写的请求时，需进行分表，分表方式有以下两种：</strong></p>
<ol>
<li><font color="red"><b>同库分表：所有的分表都在一个数据库中，由于数据库中表名不能重复，因此需要把数据表名起成不同的名字。</b></font><br>优点：由于都在一个数据库中，公共表，不必进行复制，处理更简单<br>缺点：由于还在一个数据库中，CPU、内存、文件IO、网络IO等瓶颈还是无法解决，只能降低单表中的数据记录数。表名不一致会导后续的处理复杂。</li>
<li><font color="red"><b>不同库分表：由于分表在不同的数据库中，这个时候就可以使用同样的表名。</b></font><br>优点：CPU、内存、文件IO、网络IO等瓶颈可以得到有效解决，表名相同，处理起来相对简单<br>缺点：公共表由于在所有的分表都要使用，因此要进行复制、同步。</li>
</ol>
<h3 id="开发-分库分表路线分析"><a href="#开发-分库分表路线分析" class="headerlink" title="开发-分库分表路线分析"></a>开发-分库分表路线分析</h3><ul>
<li>一种是对用户透明的方案，即用户只用像普通的JDBC数据源一样访问即可，由框架解决所有的数据访问问题。另外一种是应用层解决，具体一般是在Dao层进行封装。</li>
<li>JDBC层方案<ul>
<li>优点：开发人员使用非常方便，开发工作量比较小；可以实现数据库无关。</li>
<li>缺点：框架实现难度比较大，性能不一定能做到最优。</li>
<li>同样是JDBC方案，也有两种解决方案，一种是有代理模式，一种是无代理模式。<ul>
<li>有代理模式，有一台专门的代理服务器，来接收用户请求，然后发送请求给数据库集群中的数据，并对数据进行汇集后再提交给请求方。</li>
<li>无代理模式，就是说没有代理服务器，集群框架直接部署在应用访问端。</li>
<li>有代理模式，能够提供的功能更强大，甚至可买提供中间库进行数据处理，无代理模式处理性能较强有代理模式少一次网络访问，相对来说性能更好，但是功能性不如有代理模式。</li>
</ul>
</li>
</ul>
</li>
<li>DAO层方案<ul>
<li>优点：开发人员自由度非常大，性能调优更精准。</li>
<li>缺点：开发人员在一定程度上受影响，与具体的Dao技术实现相关，较难做到数据库无关。</li>
<li>由于需要对SQL脚本进行判断，然后进行路由，因此DAO层优化方案一般都是选用iBatis或Spring JdbcTemplate等方案进行封装，而对于Hibernate等高度封装的OR映射方案，实现起来就非常困难了。</li>
</ul>
</li>
</ul>
<h2 id="分库分表带来的限制"><a href="#分库分表带来的限制" class="headerlink" title="分库分表带来的限制"></a>分库分表带来的限制</h2><ol>
<li>条件查询、分页查询受到限制，查询必须带上分库分表所带上的id</li>
<li>事务可能跨多个库，数据一致性无法通过本地事务实现，无法使用外键</li>
<li>分库分表规则确定以后，扩展变更规则需要迁移数据</li>
</ol>
<p>业务痛点：<br><img src="http://oligvdnzp.bkt.clouddn.com/0414_fen_database_01.png" alt="业务痛点"><br>业内解决方案：<br><img src="http://oligvdnzp.bkt.clouddn.com/0414_fen_database_02.png" alt="业务痛点"><br><img src="http://oligvdnzp.bkt.clouddn.com/0414_fen_database_03.png" alt="Proxy方案对比"></p>
<h2 id="附orzdba工具使用说明"><a href="#附：orzdba工具使用说明" class="headerlink" title="附：orzdba工具使用说明"></a>附：orzdba工具使用说明</h2>

	<div class="row">
    <embed src="http://olejf7dok.bkt.clouddn.com/orzdba%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.pdf" width="100%" height="550" type="application/pdf">
	</div>



]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[ORA-27086 unable to lock file - already in use]]></title>
      <url>/2017/04/13/oracle/ORA/ORA-27086/</url>
      <content type="html"><![CDATA[<p><strong>故障现象：</strong> nas存储通过nfs挂载到Linux主机上，使用expdp直接备份到nfs上时偶尔会报以下错误<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">;;; </span>
<span class="line">Export: Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - Production on Wed Apr <span class="number">12</span> <span class="number">16</span>:<span class="number">58</span>:<span class="number">22</span> <span class="number">2017</span></span>
<span class="line">......</span>
<span class="line">ORA-<span class="number">39000</span>: bad <span class="keyword">dump</span> file specification</span>
<span class="line">ORA-<span class="number">31641</span>: unable to create <span class="keyword">dump</span> file <span class="string">"/oradata/hknfs/erpnogg_expdp/erpnogg_expdp_20170412165822_01.dmp"</span></span>
<span class="line">ORA-<span class="number">27086</span>: unable to lock file - already in <span class="keyword">use</span></span>
<span class="line">Linux-x86_64 Error: <span class="number">37</span>: No locks available</span>
<span class="line">Additional information: <span class="number">10</span></span>
</pre></td></tr></table></figure></p>
<p><strong>解决办法：</strong> 卸载nfs挂载存储，重新挂载的时候加上<code>nolock</code>参数(存储上的锁文件功能也取消)<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">umount /oradata/hknfs</span>
<span class="line">mount -t nfs -o nolock <span class="number">10.230</span>.<span class="number">51.200</span>:<span class="regexp">/cybackup /oradata</span><span class="regexp">/hknfs</span>
<span class="line"></span>
<span class="line">vi /etc</span><span class="regexp">/fstab</span>
<span class="line">#------------------------------------------------------------------------</span>
<span class="line">10.230.51.200:/cybackup</span> /oradata/hknfs          nfs     nolock       <span class="number">1</span> <span class="number">1</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<p><strong>原因分析：</strong> nas存储将逻辑卷nfs共享出去，一旦服务器挂载使用，存储就会自动将该逻辑卷锁住，保护逻辑卷内不被其他服务器挂载，达到保护数据作用，但是数据库添加挂载目录中创建数据文件，数据库需要对该数据文件获取锁，但是该锁已经被存储占用，这个时候就需要设置存储在挂载的时候不锁住，使用nolock参数。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-11 构建高可用MySQL系统]]></title>
      <url>/2017/04/06/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/11-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="mha部署"><a href="#MHA部署" class="headerlink" title="MHA部署"></a>MHA部署</h2><h3 id="主机名ip规划"><a href="#主机名-IP规划" class="headerlink" title="主机名/IP规划"></a>主机名/IP规划</h3><table>
<thead>
<tr>
<th style="text-align:center">主机名</th>
<th style="text-align:center">IP地址</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mymha</td>
<td style="text-align:center">10.245.231.201</td>
<td style="text-align:center">Master</td>
</tr>
<tr>
<td style="text-align:center">mydb1</td>
<td style="text-align:center">10.245.231.202</td>
<td style="text-align:center">Slave</td>
</tr>
<tr>
<td style="text-align:center">mydb2</td>
<td style="text-align:center">10.245.231.203</td>
<td style="text-align:center">MHA manager</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">10.245.231.204</td>
<td style="text-align:center">VIP虚拟IP</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h3 id="系统基本配置"><a href="#系统基本配置" class="headerlink" title="系统基本配置"></a>系统基本配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /etc/issue</span>
<span class="line">racle Linux Server release <span class="number">6.8</span></span>
<span class="line">Kernel \r on an \<span class="keyword">m</span></span>
<span class="line"></span>
<span class="line">service iptables stop</span>
<span class="line">chkconfig iptables off</span>
<span class="line">chkconfig ip6tables off</span>
<span class="line">chkconfig bluetooth off</span>
<span class="line">chkconfig cups off</span>
<span class="line"></span>
<span class="line">sed -i <span class="string">"s/id:5/id:3/g"</span> /etc/inittab</span>
<span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span>
<span class="line"></span>
<span class="line">echo <span class="string">"10.245.231.201  mymha"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span>
<span class="line">echo <span class="string">"10.245.231.202  mydb1"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span>
<span class="line">echo <span class="string">"10.245.231.203  mydb2"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span>
<span class="line"></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line"><span class="comment">#-------------------------------------------------</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span>      <span class="comment"># 修改原值</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#-------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">sysctl -p</span>
<span class="line"></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line"></span>
<span class="line">cp /etc/yum.repos.d/public-yum-ol6.repo /etc/yum.repos.d/public-yum-ol6.repo.bak</span>
<span class="line">vi /etc/yum.repos.d/public-yum-ol6.repo</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">[public_ol6_latest]</span>
<span class="line">name=Oracle Linux $releasever Latest ($basearch)</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span><span class="regexp">/Server</span>
<span class="line">gpgcheck=0</span>
<span class="line">enabled=1</span>
<span class="line">#------------------------------------------------</span>
<span class="line"></span>
<span class="line">yum install -y cmake gcc gcc-c++ ncurses-devel bison zlib libxml openssl openssl-devel lrzsz</span></span>
</pre></td></tr></table></figure>
<h3 id="编译安装mysql"><a href="#编译安装MySQL" class="headerlink" title="编译安装MySQL"></a>编译安装MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mydb1/mydb2</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/conf</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/data/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/run/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/tmp/<span class="number">3306</span></span>
<span class="line"></span>
<span class="line">groupadd -g <span class="number">501</span> mysql</span>
<span class="line">useradd -u <span class="number">501</span> mysql -g mysql</span>
<span class="line">echo <span class="string">"mysql123"</span> | passwd --stdin mysql</span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01</span>
<span class="line"></span>
<span class="line"><span class="comment"># 进入源码目录</span></span>
<span class="line">cd /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line"></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/u01/mysql</span> \</span>
<span class="line">-DINSTALL_DATADIR=<span class="regexp">/u01/data</span><span class="regexp">/3306  \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DEXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=1 \</span>
<span class="line">-DENABLED_LOCAL_INFILE=1 \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span>
<span class="line">-DMYSQL_UNIX_ADDR=/u</span>01/run/<span class="number">3306</span>/mysql.sock \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/etc \</span>
<span class="line">-DWITH_READLINE=on</span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span></span>
</pre></td></tr></table></figure>
<h3 id="配置mysql参数配置"><a href="#配置MySQL参数配置" class="headerlink" title="配置MySQL参数配置"></a>配置MySQL参数配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/conf</span>
<span class="line">vi my3306.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">[mysql]</span>
<span class="line">pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">0</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line">transaction_isolation=<span class="keyword">read</span>-committed</span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/u01/mysql</span></span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">max_allowed_packet=1g</span>
<span class="line">max_connections=3000</span>
<span class="line">max_user_connections=2800</span>
<span class="line">open_files_limit=65535</span>
<span class="line">pid_file=/u</span>01/run/<span class="number">3306</span>/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">101</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line"></span>
<span class="line">#binlog</span>
<span class="line">log_bin=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/slow</span>.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/log</span><span class="regexp">/3306/relaylog</span></span>
<span class="line">relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line">#innodb</span>
<span class="line">innodb_data_home_dir=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_format=Barracuda</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">#----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># server_id=101 在mydb2上修改成102</span></span>
</pre></td></tr></table></figure>
<h3 id="初始化并启动数据库"><a href="#初始化并启动数据库" class="headerlink" title="初始化并启动数据库"></a>初始化并启动数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">echo <span class="string">"export PATH=\$PATH:\$HOME/bin:/u01/mysql/bin"</span> &gt;&gt; <span class="regexp">/home/mysql</span><span class="regexp">/.bash_profile</span>
<span class="line">su - mysql</span>
<span class="line">cd /u</span>01/mysql/scripts</span>
<span class="line">./mysql_install_db --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf \</span>
<span class="line">--datadir=/u</span>01/data/<span class="number">3306</span> --basedir=<span class="regexp">/u01/mysql</span> --user=mysql</span>
<span class="line"></span>
<span class="line"><span class="comment">#启动数据库</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line">#登陆数据库</span>
<span class="line">mysql --socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭数据库</span></span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
</pre></td></tr></table></figure>
<h3 id="快速搭建mysql一主一从"><a href="#快速搭建MySQL一主一从" class="headerlink" title="快速搭建MySQL一主一从"></a>快速搭建MySQL一主一从</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mydb1 mydb2</span></span>
<span class="line">grant all privileges on *.* to <span class="string">'root'</span>@'localhost<span class="string">' identified by '</span>root123<span class="string">' with grant option;</span>
<span class="line">grant all privileges on *.* to '</span>root<span class="string">'@'</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' identified by '</span>root123<span class="string">' with grant option;</span>
<span class="line">grant all privileges on *.* to '</span>root<span class="string">'@'</span><span class="number">10.245</span>%' identified by <span class="string">'root123'</span> with grant option;</span>
<span class="line"></span>
<span class="line">grant replication slave on *.* to rep@'<span class="number">10.245</span>.<span class="number">231.202</span><span class="string">' identified by '</span>rep123<span class="string">';</span>
<span class="line">grant replication slave on *.* to rep@'</span><span class="number">10.245</span>.<span class="number">231.203</span><span class="string">' identified by '</span>rep123<span class="string">';</span>
<span class="line"></span>
<span class="line"># mydb1</span>
<span class="line">show master status\G;</span>
<span class="line">*************************** 1. row ***************************</span>
<span class="line">             File: binlog.000005</span>
<span class="line">         Position: 540</span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line">1 row in set (0.00 sec)</span>
<span class="line"></span>
<span class="line"># mydb2</span>
<span class="line">CHANGE MASTER TO </span>
<span class="line">    MASTER_HOST='</span><span class="number">10.245</span>.<span class="number">231.202</span><span class="string">',</span>
<span class="line">    MASTER_PORT=3306,</span>
<span class="line">    MASTER_USER='</span>rep<span class="string">',</span>
<span class="line">    MASTER_PASSWORD='</span>rep123<span class="string">',</span>
<span class="line">    MASTER_LOG_FILE='</span>binlog.<span class="number">000005</span><span class="string">', </span>
<span class="line">    MASTER_LOG_POS=540;</span>
<span class="line">start slave;</span>
<span class="line">show slave status\G;</span></span>
</pre></td></tr></table></figure>
<h3 id="设置ssh公钥免密码登录"><a href="#设置SSH公钥免密码登录" class="headerlink" title="设置SSH公钥免密码登录"></a>设置SSH公钥免密码登录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户在mymha/mydb1/mydb2</span></span>
<span class="line">cd ~</span>
<span class="line">ssh-keygen -t rsa</span>
<span class="line">ll /root/.ssh</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">total <span class="number">8</span></span>
<span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Apr  <span class="number">8</span> 09:<span class="number">59</span> id_rsa</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">392</span> Apr  <span class="number">8</span> 09:<span class="number">59</span> id_rsa.pub</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb1</span></span>
<span class="line">scp ~<span class="regexp">/.ssh/id</span>_rsa.pub mymha:<span class="regexp">/root/</span>.ssh/id_rsa.pub.mydb1</span>
<span class="line"><span class="comment"># mydb2</span></span>
<span class="line">scp ~<span class="regexp">/.ssh/id</span>_rsa.pub mymha:<span class="regexp">/root/</span>.ssh/id_rsa.pub.mydb2</span>
<span class="line"><span class="comment"># mymha</span></span>
<span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub &gt;&gt; ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub.mydb1 &gt;&gt; ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub.mydb2 &gt;&gt; ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line"><span class="keyword">chmod</span> <span class="number">600</span> ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line">rm -rf ~<span class="regexp">/.ssh/id</span>_rsa.pub.mydb*</span>
<span class="line">scp ~<span class="regexp">/.ssh/authorized</span>_keys mydb1:<span class="regexp">/root/</span>.ssh/</span>
<span class="line">scp ~<span class="regexp">/.ssh/authorized</span>_keys mydb2:<span class="regexp">/root/</span>.ssh/</span>
<span class="line"></span>
<span class="line">ssh mydb1</span>
<span class="line">ssh mydb2</span>
<span class="line">ssh mymha</span>
</pre></td></tr></table></figure>
<h3 id="安装mha4mysql-manager和mha4mysql-node"><a href="#安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="安装mha4mysql-manager和mha4mysql-node"></a>安装mha4mysql-manager和mha4mysql-node</h3><h4 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在三个节点（node 和 manager）安装perl-DBD-MySQL，用光盘作yum源</span></span>
<span class="line">yum -<span class="keyword">y</span> install perl-DBD-MySQL perl-DBI mysql-libs</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在管理节点安装，用光盘yum源</span></span>
<span class="line">yum install perl-Time-HiRes</span>
<span class="line"></span>
<span class="line"><span class="comment"># 下载管理节点所需依赖包并安装</span></span>
<span class="line"><span class="comment">## http://mirrors.sohu.com/centos/6.8/os/x86_64/Packages/</span></span>
<span class="line"><span class="comment">## http://dl.fedoraproject.org/pub/epel/6/x86_64/</span></span>
<span class="line"><span class="comment">## 可以从以上两个网载中找到所需依赖包，下载后打包分享地址 http://pan.baidu.com/s/1eSzfAsq</span></span>
<span class="line">rpm -ivh perl-Config-Tiny-<span class="number">2.12</span>-<span class="number">7.1</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Params-Validate-<span class="number">0</span>.<span class="number">92</span>-<span class="number">3</span>.el6.x86_64.rpm</span>
<span class="line">rpm -ivh perl-MIME-Types-<span class="number">1.28</span>-<span class="number">2</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Email-Date-Format-<span class="number">1.002</span>-<span class="number">5</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Mail-Sender-<span class="number">0</span>.<span class="number">8.16</span>-<span class="number">3</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Mail-Sendmail-<span class="number">0</span>.<span class="number">79</span>-<span class="number">12</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-TimeDate-<span class="number">1.16</span>-<span class="number">13</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-MailTools-<span class="number">2.04</span>-<span class="number">4</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-MIME-Lite-<span class="number">3.027</span>-<span class="number">2</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Log-Dispatch-<span class="number">2.27</span>-<span class="number">1</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Parallel-ForkManager-<span class="number">0</span>.<span class="number">7.9</span>-<span class="number">1</span>.el6.noarch.rpm</span>
</pre></td></tr></table></figure>
<h4 id="在所有节点安装node包"><a href="#在所有节点安装node包" class="headerlink" title="在所有节点安装node包"></a>在所有节点安装node包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载地址：http://olg2mr2vf.bkt.clouddn.com/mha4mysql-manager-0.56.tar.gz</span></span>
<span class="line">tar xzvf mha4mysql-node-<span class="number">0</span>.<span class="number">56</span>.tar.gz</span>
<span class="line">cd mha4mysql-node-<span class="number">0</span>.<span class="number">56</span></span>
<span class="line">perl Makefile.PL</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line"></span>
<span class="line">ll /usr/<span class="keyword">local</span>/bin/</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root <span class="number">16367</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> apply_diff_relay_logs</span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root  <span class="number">4807</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> filter_mysqlbinlog</span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root  <span class="number">8261</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> purge_relay_logs</span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root  <span class="number">7525</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> save_binary_logs</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="在管理节点安装manager包"><a href="#在管理节点安装manager包" class="headerlink" title="在管理节点安装manager包"></a>在管理节点安装manager包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载地址：http://olg2mr2vf.bkt.clouddn.com/mha4mysql-node-0.56.tar.gz</span></span>
<span class="line">tar xzvf mha4mysql-manager-<span class="number">0</span>.<span class="number">56</span>.tar.gz</span>
<span class="line">cd mha4mysql-manager-<span class="number">0</span>.<span class="number">56</span></span>
<span class="line">perl Makefile.PL</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line"></span>
<span class="line">ll /usr/<span class="keyword">local</span>/bin/</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root <span class="number">16367</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 apply_diff_relay_logs</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">4807</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 filter_mysqlbinlog</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1995</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_check_repl</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1779</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_check_ssh</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1865</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_check_status</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">3201</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_conf_host</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">2517</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_manager</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">2165</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_master_monitor</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">2373</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_master_switch</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">5171</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_secondary_check</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1739</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_stop</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">8261</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 purge_relay_logs</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">7525</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 save_binary_logs</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="mha-配置文件"><a href="#mha-配置文件" class="headerlink" title="mha 配置文件"></a>mha 配置文件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/mha/etc</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mha/<span class="keyword">log</span></span>
<span class="line">vi /u01/mha/etc/app.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">[server default]</span>
<span class="line">user = root</span>
<span class="line">password = root123</span>
<span class="line">ssh_user = root</span>
<span class="line">repl_user = rep</span>
<span class="line">repl_password = rep123</span>
<span class="line">ping_interval = <span class="number">1</span></span>
<span class="line">ping_type = SELECT</span>
<span class="line"></span>
<span class="line">manager_workdir=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span></span>
<span class="line">manager_log=<span class="regexp">/u01/mha</span><span class="regexp">/log/manager</span>.log</span>
<span class="line">remote_workdir=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span></span>
<span class="line">master_binlog_dir=<span class="string">"/u01/log/3306/binlog"</span></span>
<span class="line"></span>
<span class="line">master_ip_failover_script=<span class="string">"/u01/mha/etc/master_ip_failover"</span></span>
<span class="line">master_ip_online_change_script=<span class="string">"/u01/mha/etc/master_ip_failover"</span></span>
<span class="line"></span>
<span class="line">shutdown_script=<span class="string">""</span></span>
<span class="line"></span>
<span class="line">report_script=<span class="string">""</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#check_repl_delay=0</span></span>
<span class="line"></span>
<span class="line">[server1]</span>
<span class="line">hostname=mydb1</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">master_binlog_dir=<span class="string">"/u01/log/3306/binlog"</span></span>
<span class="line">candidate_master=<span class="number">1</span></span>
<span class="line">ignore_fail=<span class="number">1</span></span>
<span class="line"></span>
<span class="line">[server2]</span>
<span class="line">hostname=mydb2</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">master_binlog_dir=<span class="string">"/u01/log/3306/binlog"</span></span>
<span class="line">candidate_master=<span class="number">1</span></span>
<span class="line">ignore_fail=<span class="number">1</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="master_ip_failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/mha/etc/master_ip_failover</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"><span class="comment">#!/usr/bin/env perl</span></span>
<span class="line"><span class="keyword">use</span> strict;</span>
<span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">use</span> Getopt::Long;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">my</span> (</span>
<span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span>
<span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span>
<span class="line">);</span>
<span class="line"> </span>
<span class="line"><span class="keyword">my</span> $vip = <span class="string">'10.245.231.204/24'</span>;</span>
<span class="line"><span class="comment"># Virtual IP</span></span>
<span class="line"><span class="keyword">my</span> $key = <span class="string">"1"</span>;</span>
<span class="line"><span class="keyword">my</span> $int = <span class="string">"eth0"</span>;</span>
<span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/sbin/ifconfig $int:$key $vip"</span>;</span>
<span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/sbin/ifconfig $int:$key down"</span>;</span>
<span class="line"><span class="keyword">my</span> $arp_effect = <span class="string">"/sbin/arping -Uq -s 10.245.231.204 -I $int 10.245.231.254 -c 3"</span>;</span>
<span class="line"><span class="comment"># Virtual IP and gateway</span></span>
<span class="line"><span class="comment">#my $test = "echo successfull &gt;/tmp/test.txt";</span></span>
<span class="line">$ssh_user = <span class="string">"root"</span>;</span>
<span class="line">GetOptions(</span>
<span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span>
<span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span>
<span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span>
<span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span>
<span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span>
<span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span>
<span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span>
<span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span>
<span class="line">);</span>
<span class="line"> </span>
<span class="line"><span class="keyword">exit</span> &amp;main();</span>
<span class="line"> </span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span>
<span class="line"> </span>
<span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span>
<span class="line"> </span>
<span class="line">        <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span>
<span class="line">        <span class="comment"># If you manage master ip address at global catalog database,</span></span>
<span class="line">        <span class="comment"># invalidate orig_master_ip here.</span></span>
<span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span>
<span class="line">        <span class="keyword">eval</span> &#123;</span>
<span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span>
<span class="line">            &amp;stop_vip();</span>
<span class="line">            $exit_code = <span class="number">0</span>;</span>
<span class="line">        &#125;;</span>
<span class="line">        <span class="keyword">if</span> ($@) &#123;</span>
<span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span>
<span class="line">            <span class="keyword">exit</span> $exit_code;</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">exit</span> $exit_code;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span>
<span class="line"> </span>
<span class="line">        <span class="comment"># all arguments are passed.</span></span>
<span class="line">        <span class="comment"># If you manage master ip address at global catalog database,</span></span>
<span class="line">        <span class="comment"># activate new_master_ip here.</span></span>
<span class="line">        <span class="comment"># You can also grant write access (create user, set read_only=0, etc) here.</span></span>
<span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span>
<span class="line">        <span class="keyword">eval</span> &#123;</span>
<span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span>
<span class="line">            &amp;start_vip();</span>
<span class="line">            $exit_code = <span class="number">0</span>;</span>
<span class="line">        &#125;;</span>
<span class="line">        <span class="keyword">if</span> ($@) &#123;</span>
<span class="line">            <span class="keyword">warn</span> $@;</span>
<span class="line">            <span class="keyword">exit</span> $exit_code;</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">exit</span> $exit_code;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span>
<span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span>
<span class="line">        <span class="comment">#`ssh $ssh_user\@cluster1 \" $ssh_start_vip \"`;</span></span>
<span class="line">        &amp;status();</span>
<span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">else</span> &#123;</span>
<span class="line">        &amp;usage();</span>
<span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"> </span>
<span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span>
<span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span>
<span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $arp_effect \"`</span>;</span>
<span class="line"><span class="comment">#    `ssh $ssh_user\@$new_master_host \" $test \"`;</span></span>
<span class="line">&#125;</span>
<span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span>
<span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">status</span>() </span>&#123;</span>
<span class="line">    <span class="keyword">print</span> <span class="string">`ssh $ssh_user\@$orig_master_host \" ip add show $int \"`</span>;</span>
<span class="line">&#125;</span>
<span class="line"> </span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span>
<span class="line">    <span class="keyword">print</span></span>
<span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_maste</span>
<span class="line">r_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span>
<span class="line">&#125;</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">chmod</span> +<span class="keyword">x</span> /u01/mha/etc/master_ip_failover</span>
</pre></td></tr></table></figure>
<h4 id="vip-add-配置"><a href="#vip-add-配置" class="headerlink" title="vip add 配置"></a>vip add 配置</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在master mydb1上执行下面命令（第一次启用可以手动配置vip address，不配置的话，自动切换后可生成）</span></span>
<span class="line">ifconfig eth<span class="number">0</span>:<span class="number">1</span> <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span></span>
</pre></td></tr></table></figure>
<h4 id="检测启动关闭mha"><a href="#检测-启动-关闭MHA" class="headerlink" title="检测/启动/关闭MHA"></a>检测/启动/关闭MHA</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_ssh --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_repl --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检测ssh等价性配置</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_ssh --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [info] Reading application default configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [info] Reading server configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [info] Starting SSH connection tests..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [debug]  Connecting via SSH from root@mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">22</span>) to root@mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">22</span>)..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug]   ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug]  Connecting via SSH from root@mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">22</span>) to root@mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">22</span>)..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug]   ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [info] All SSH connection tests passed successfully.   <span class="comment"># successfully代表SSH等价性配置成功</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 检测MHA</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_repl --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">## 检测问题和解决办法</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"><span class="comment"># 问题1：</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">15</span> <span class="number">2017</span> - [info]  read_only=<span class="number">1</span> is <span class="keyword">not</span> set on slave mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>).</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">15</span> <span class="number">2017</span> - [warning]  relay_log_purge=<span class="number">0</span> is <span class="keyword">not</span> set on slave mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line"><span class="comment"># 问题2：</span></span>
<span class="line">Can <span class="keyword">not</span> <span class="keyword">exec</span> <span class="string">"mysqlbinlog"</span>: No such file <span class="keyword">or</span> directory at /usr/<span class="keyword">local</span>/share/perl5/MHA/BinlogManager.pm line <span class="number">106</span>.</span>
<span class="line">mysqlbinlog version command failed with rc <span class="number">1</span>:<span class="number">0</span>, please verify PATH, LD_LIBRARY_PATH, <span class="keyword">and</span> client options  at /usr/<span class="keyword">local</span>/bin/apply_diff_relay_logs line <span class="number">493</span></span>
<span class="line"><span class="comment"># 问题3：</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln205] Slaves settings check failed!</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln413] Slave configuration failed.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln424] Error happened on checking configurations.  at /usr/<span class="keyword">local</span>/bin/masterha_check_repl line <span class="number">48</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln523] Error happened on monitoring servers.</span>
<span class="line">....</span>
<span class="line">MySQL Replication Health is NOT OK!   <span class="comment"># NOT OK，MHA有问题需要解决，以下是解决步骤</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb2</span></span>
<span class="line">set global read_only=<span class="number">1</span>;  </span>
<span class="line">set global relay_log_purge=<span class="number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb1/mydb2</span></span>
<span class="line">ln -<span class="keyword">s</span> /u01/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span>
<span class="line">ln -<span class="keyword">s</span> /u01/mysql/bin/mysql /usr/bin/mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 解决问题后再检测时状态是OK</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  OK.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">33</span> <span class="number">2017</span> - [warning] shutdown_script is <span class="keyword">not</span> defined.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Got <span class="keyword">exit</span> code <span class="number">0</span> (Not master dead).</span>
<span class="line"></span>
<span class="line">MySQL Replication Health is OK.</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动MHA后查看状态</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">app (pid:<span class="number">10163</span>) is running(<span class="number">0</span>:PING_OK), master:mydb1</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
</pre></td></tr></table></figure>
<h2 id="mha-failover故障切换"><a href="#MHA-failover故障切换" class="headerlink" title="MHA failover故障切换"></a>MHA failover故障切换</h2><h3 id="模拟主库宕机"><a href="#模拟主库宕机" class="headerlink" title="模拟主库宕机"></a>模拟主库宕机</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ssh mydb1 <span class="string">"killall -r mysqld"</span></span>
</pre></td></tr></table></figure>
<h3 id="查看管理节点日志可以看到vip已经漂移"><a href="#查看管理节点日志，可以看到VIP已经漂移" class="headerlink" title="查看管理节点日志，可以看到VIP已经漂移"></a>查看管理节点日志，可以看到VIP已经漂移</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /u01/mha/<span class="keyword">log</span>/manager.log |<span class="keyword">grep</span> -i vip</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Disabling the VIP on old master: mydb1 </span>
<span class="line">Enabling the VIP - <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span> on the new master - mydb2 </span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="验证vip是否位于节点mydb2"><a href="#验证VIP是否位于节点mydb2" class="headerlink" title="验证VIP是否位于节点mydb2"></a>验证VIP是否位于节点mydb2</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ssh mydb2 <span class="string">"ifconfig |grep 231.204 -B1"</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">eth<span class="number">0</span>:<span class="number">1</span>    Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:A<span class="number">0</span>:<span class="number">35</span>:C<span class="number">0</span>  </span>
<span class="line">          inet addr:<span class="number">10.245</span>.<span class="number">231.204</span>  Bcast:<span class="number">10.245</span>.<span class="number">231.255</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 若VIP没有自动切换，可以使用以下命令手动切换（不建议）</span></span>
<span class="line">ifconfig eth<span class="number">0</span>:<span class="number">1</span> <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span></span>
<span class="line">arping -Uq -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.204</span> -I eth<span class="number">0</span> <span class="number">10.245</span>.<span class="number">231.254</span> -c <span class="number">3</span></span>
<span class="line">ifconfig eth<span class="number">0</span>:<span class="number">1</span> down</span>
</pre></td></tr></table></figure>
<h3 id="查看管理节点mha切换日志"><a href="#查看管理节点MHA切换日志" class="headerlink" title="查看管理节点MHA切换日志"></a>查看管理节点MHA切换日志</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">tail /u01/mha/<span class="keyword">log</span>/manager.log</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Started automated(non-interactive) failover.</span>
<span class="line">Invalidated master IP address on mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)</span>
<span class="line">The latest slave mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</span>
<span class="line">Selected mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) as a new master.</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>): OK: Applying all logs succeeded.</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>): OK: Activated master IP address.</span>
<span class="line">Generating relay diff files from the latest slave succeeded.</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>): Resetting slave info succeeded.</span>
<span class="line">Master failover to mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) completed successfully.</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="new-masterold-slave"><a href="#new-master-old-slave" class="headerlink" title="new master(old slave)"></a>new master(old slave)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show master status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000007</span></span>
<span class="line">         Position: <span class="number">120</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure>
<h3 id="new-slaveoldmaster"><a href="#new-slave-old-master" class="headerlink" title="new slave(old:master)"></a>new slave(old:master)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开MySQL</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line">mysql -uroot -proot123 --socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检查数据库</span></span>
<span class="line">mysql&gt; show master status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000013</span></span>
<span class="line">         Position: <span class="number">120</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show slave  status\G</span>
<span class="line">Empty set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在管理节点日志中查主库的日志文件和位置</span></span>
<span class="line">cat /u01/mha/<span class="keyword">log</span>/manager.log |<span class="keyword">grep</span> -i change</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">14</span>:<span class="number">55</span>:<span class="number">24</span> <span class="number">2017</span> - [info]  All other slaves should start replication from here. </span>
<span class="line">Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">'mydb2 or 10.245.231.203'</span>, MASTER_PORT=<span class="number">3306</span>, </span>
<span class="line">MASTER_LOG_FILE=<span class="string">'binlog.000007'</span>, MASTER_LOG_POS=<span class="number">120</span>, MASTER_USER=<span class="string">'rep'</span>, MASTER_PASSWORD=<span class="string">'xxx'</span>;</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 在slave连接master</span></span>
<span class="line">CHANGE MASTER TO</span>
<span class="line">  MASTER_HOST=<span class="string">'10.245.231.203'</span>,</span>
<span class="line">  MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">  MASTER_LOG_FILE=<span class="string">'binlog.000007'</span>,</span>
<span class="line">  MASTER_LOG_POS=<span class="number">120</span>,</span>
<span class="line">  MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">  MASTER_PASSWORD=<span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line">start slave;</span>
</pre></td></tr></table></figure>
<h3 id="启动管理节点"><a href="#启动管理节点" class="headerlink" title="启动管理节点"></a>启动管理节点</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf  --ignore_last_failover &amp;</span>
</pre></td></tr></table></figure>
<h2 id="mha-switchover线上切换"><a href="#MHA-switchover线上切换" class="headerlink" title="MHA switchover线上切换"></a>MHA switchover线上切换</h2><h3 id="master关闭event_scheduler"><a href="#master：关闭event-scheduler" class="headerlink" title="master：关闭event_scheduler"></a>master：关闭event_scheduler</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master mydb2</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">app (pid:<span class="number">3793</span>) is running(<span class="number">0</span>:PING_OK), master:mydb2</span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb2</span></span>
<span class="line">set global event_scheduler=off;</span>
</pre></td></tr></table></figure>
<h3 id="manager关闭管理进程"><a href="#manager：关闭管理进程" class="headerlink" title="manager：关闭管理进程"></a>manager：关闭管理进程</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
</pre></td></tr></table></figure>
<h3 id="manager检查配置文件"><a href="#manager：检查配置文件" class="headerlink" title="manager：检查配置文件"></a>manager：检查配置文件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 有没有被修改破坏。如果破坏需要重新编辑正确配置文件：/u01/mha/etc/app.cnf</span></span>
<span class="line">cp /u01/mha/etc/app.cnf.bak /u01/mha/etc/app.cnf</span>
</pre></td></tr></table></figure>
<h3 id="开始切换"><a href="#开始切换" class="headerlink" title="开始切换"></a>开始切换</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_master_switch --master_state=alive --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"></span>
<span class="line">at Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] MHA::MasterRotate version <span class="number">0</span>.<span class="number">56</span>.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Starting online master switch..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Reading application default configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Reading server configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Current Alive Master: mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Alive Slaves:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)  Version=<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> (oldest major version between slaves) <span class="keyword">log</span>-bin:enabled</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">10.245</span>.<span class="number">231.203</span>(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span>
<span class="line"></span>
<span class="line">It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)? (YES/<span class="keyword">no</span>): yes  <span class="comment"># 输yes</span></span>
<span class="line"></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take long time..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Checking MHA is <span class="keyword">not</span> monitoring <span class="keyword">or</span> doing failover..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Checking replication health on mydb1..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Searching new master from slaves..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  Candidate masters from the configuration file:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)  Version=<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> (oldest major version between slaves) <span class="keyword">log</span>-bin:enabled</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">10.245</span>.<span class="number">231.203</span>(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)  Version=<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> <span class="keyword">log</span>-bin:enabled</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  Non-candidate masters:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay <span class="keyword">log</span> events..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] </span>
<span class="line">From:</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) (current master)</span>
<span class="line"> +--mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)</span>
<span class="line"></span>
<span class="line">To:</span>
<span class="line">mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>) (new master)</span>
<span class="line"></span>
<span class="line">Starting master switch from mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) to mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)? (yes/NO): yes   <span class="comment"># 输yes</span></span>
<span class="line">......</span>
<span class="line">IN SCRIPT TEST====<span class="regexp">/sbin/ifconfig</span> eth<span class="number">0</span>:<span class="number">1</span> down==<span class="regexp">/sbin/ifconfig</span> eth<span class="number">0</span>:<span class="number">1</span> <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span>===</span>
<span class="line"></span>
<span class="line">Enabling the VIP - <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span> on the new master - mydb1 </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] * Switching slaves in parallel..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Unlocking all tables on the orig master:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing UNLOCK TABLES..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] All new slave servers switched successfully.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  mydb1: Resetting slave info succeeded.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Switching master to mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>) completed successfully.</span>
</pre></td></tr></table></figure>
<h3 id="new-masterold-slave"><a href="#new-master-old-slave-1" class="headerlink" title="new master(old slave)"></a>new master(old slave)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show master status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000013</span></span>
<span class="line">         Position: <span class="number">936</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show slave status\G</span>
<span class="line">Empty set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure>
<h3 id="new-slaveold-master"><a href="#new-slave-old-master-1" class="headerlink" title="new slave(old master)"></a>new slave(old master)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">CHANGE MASTER TO</span>
<span class="line">  MASTER_HOST=<span class="string">'10.245.231.202'</span>,</span>
<span class="line">  MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">  MASTER_LOG_FILE=<span class="string">'binlog.000013'</span>,</span>
<span class="line">  MASTER_LOG_POS=<span class="number">936</span>,</span>
<span class="line">  MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">  MASTER_PASSWORD=<span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line">mysql&gt; start slave;</span>
<span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">01</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show slave status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000013</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">936</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">280</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000013</span></span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
</pre></td></tr></table></figure>
<h3 id="启动管理节点"><a href="#启动管理节点-1" class="headerlink" title="启动管理节点"></a>启动管理节点</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf --remove_dead_master_conf --ignore_last_failover &amp;</span>
<span class="line"></span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">app (pid:<span class="number">4463</span>) is running(<span class="number">0</span>:PING_OK), master:mydb1</span>
</pre></td></tr></table></figure>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><p>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，是日本的一位MySQL专家采用Perl语言编写的一个脚本管理工具，目的在于维持MySQL Replication中<font color="red">Master库的高可用性</font>，其最大特点是可以修复多个Slave之间的差异日志，最终使所有Slave保持数据一致，然后从中选择一个充当新的Master，并将其它Slave指向它。</p>
<p>MHA集群架构图<br><img src="http://oligvdnzp.bkt.clouddn.com/0406_mha_01.png" alt=""></p>
<h3 id="mha监控"><a href="#MHA监控" class="headerlink" title="MHA监控"></a>MHA监控</h3><ul>
<li>MHA监控最主要的就是监控master，每<code>ping_interval</code>秒监控master一次。</li>
<li>MHA自身提供了两种监控方式：SELECT和CONNECT，控制参数<code>ping_type</code></li>
<li>MHA调用SSH脚本对所有Node执行检查，包括：<ul>
<li>Master服务器是否可以SSH连通</li>
<li>MySQL实例是否可以连接</li>
<li>检查SQL Thread的状态</li>
<li>检查哪些Server死掉了，哪些Server是活动的，以及活动的Slave实例</li>
<li>检查Slave实例的配置及复制过滤规则</li>
</ul>
</li>
<li>MHA监控检查Master Node异常时操作：<ol>
<li>SQL Thread alive? NO: Restart it</li>
<li>调用<code>master_ip_failover_script</code>关闭VIP</li>
<li>检查各个Slave，获取最近的和最旧的<code>binary log file</code>和<code>position</code>，并检查各个Slave成为Master的优先级</li>
<li>若dead master所在服务器依然可以通过SSH连通，则提取dead master的binary log。另外，MHA还要对各个Slave节点SSH连通性进行检查。</li>
<li>调用<code>apply_diff_relay_logs</code>命令恢复Slave的差异日志，即各个Slave之间的relay log</li>
<li>差异日志恢复到New Master上，然后获取New Master的binlogname和position，最后会开启New Master的写权限</li>
<li>清理New Master其实就是重置slave info，即取消原来的Slave信息</li>
</ol>
</li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-10 深入理解MySQL主从复制]]></title>
      <url>/2017/03/31/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/10-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="如何解决主从复制延迟的问题"><a href="#如何解决主从复制延迟的问题？" class="headerlink" title="如何解决主从复制延迟的问题？"></a>如何解决主从复制延迟的问题？</h2><ol>
<li>加大主从库之间网络带宽</li>
<li>使用SSD盘</li>
<li>使用缓存服务器Redis/memcached</li>
</ol>
<a id="more"></a>
<h2 id="如何判断主从复制是否同步"><a href="#如何判断主从复制是否同步？" class="headerlink" title="如何判断主从复制是否同步？"></a>如何判断主从复制是否同步？</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在从库上查看同步状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.201</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000037</span>     <span class="comment"># I/O线程 接收的binlog文件</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">1653</span>              <span class="comment"># I/O线程 binlog文件偏移量</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span>   </span>
<span class="line">                Relay_Log_Pos: <span class="number">604</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000037</span>     <span class="comment"># SQL线程 已应用的binlog文件</span></span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
<span class="line">            ......</span>
<span class="line">          Exec_Master_Log_Pos: <span class="number">1653</span>              <span class="comment"># SQL线程 已应用的binlog文件偏移量</span></span>
<span class="line">         ......</span>
<span class="line">        Seconds_Behind_Master: <span class="number">0</span>                 <span class="comment"># 从库和主库延迟时间</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 如果主库实例正常，同时查看主库状态</span></span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000037</span></span>
<span class="line">         Position: <span class="number">1653</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure>
<p>查看主库<code>File</code>和从库I/O线程<code>Master_Log_File</code>和SQL线程<code>Relay_Master_Log_File</code>是不是相同，如果不同（如<code>Relay_Master_Log_File</code>小），说明有延迟；如果相等，再比较主库的<code>Position</code>和从库的<code>Read_Master_Log_Pos</code>和<code>Exec_Master_Log_Pos</code>是不是相同，如果偏移量也相同，说明主从复制是同步的。</p>
<h2 id="sql_slave_skip_counter参数设为1怎么理解"><a href="#sql-slave-skip-counter-参数设为1怎么理解？" class="headerlink" title="[sql_slave_skip_counter]参数设为1怎么理解？"></a>[sql_slave_skip_counter]参数设为1怎么理解？</h2><blockquote>
<p>set global sql_slave_skip_counter = N</p>
<p><font color="red">This statement skips the next N events from the master.</font></p>
<p><font color="blue">即是跳过N个events，这里最重要的是理解event的含义!在mysql中,对于sql的 binary log 实际上是由一连串的event组成的一个组,即事务组。</font><br>在备库上设置<code>global sql_slave_skip_counter =N</code>会跳过当前时间来自于master的之后N个事件，这对于恢复由某条SQL语句引起的从库复制有效。<br>此语句只在当<code>slave threads</code>是停止时才有效，每忽略一个事务，N减一，直到N减为0！</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当slave threads停止时，跳过1个事务</span></span>
<span class="line">set global sql_slave_skip_counter=<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h2 id="线上快速搭建mysql主从复制流程"><a href="#线上快速搭建Mysql主从复制流程" class="headerlink" title="线上快速搭建Mysql主从复制流程"></a>线上快速搭建Mysql主从复制流程</h2><ol>
<li>初始化mysql主从库</li>
<li>主创建复制帐号，授权</li>
<li>修改主和从的<code>server_id</code>(全局中要唯一)</li>
<li>主库做全备(初始化没数据的库可以省略此步)</li>
<li>从库做恢复(初始化没数据的库可以省略此步)</li>
<li>备库执行<code>change master</code>设置复制</li>
<li>备库启动复制(I/O线程、SQL线程)</li>
<li>查看复制状态</li>
</ol>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_01.png" alt=""></p>
<h3 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">prompt my3306-&gt; </span>
<span class="line">grant replication slave,replication client on *.* to rep@'%' identified by <span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%server_id%'</span>;</span>
<span class="line">+----------------+-------+</span>
<span class="line">| Variable_name  | Value |</span>
<span class="line">+----------------+-------+</span>
<span class="line">| server_id      | <span class="number">101</span>   |   <span class="comment"># 保证全局唯一</span></span>
<span class="line">| server_id_bits | <span class="number">32</span>    |</span>
<span class="line">+----------------+-------+</span>
<span class="line"></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| jfedu              |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用mysqldump工具备份jfedu数据库</span></span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P3306 -uroot -pmysqlroot --single-transaction --master-data=<span class="number">2</span>  &gt; <span class="regexp">/tmp/all</span>.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 测试备份后DML操作</span></span>
<span class="line"><span class="keyword">use</span> jfedu</span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line">create table gyj_t3 (id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into gyj_t3 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| gyj_t3          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看从库配置复制时需用到的CHANGE MASTER内容</span></span>
<span class="line">cat /tmp/jfedu.sql | <span class="keyword">grep</span> <span class="string">'CHANGE MASTER'</span></span>
<span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'binlog.000037'</span>, MASTER_LOG_POS=<span class="number">1329</span>;</span>
</pre></td></tr></table></figure>
<h3 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/conf/my3307.cnf</span>
<span class="line">------------------------</span>
<span class="line"><span class="comment"># 修改从库server_id，确保全局唯一</span></span>
<span class="line">server_id=<span class="number">102</span></span>
<span class="line">------------------------</span>
<span class="line"></span>
<span class="line">prompt my3307-&gt; </span>
<span class="line">set global server_id=<span class="number">102</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%server_id%'</span>;</span>
<span class="line">+----------------+-------+</span>
<span class="line">| Variable_name  | Value |</span>
<span class="line">+----------------+-------+</span>
<span class="line">| server_id      | <span class="number">102</span>   |</span>
<span class="line">| server_id_bits | <span class="number">32</span>    |</span>
<span class="line">+----------------+-------+</span>
<span class="line"></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line">create database jfedu default character set utf8;</span>
<span class="line"><span class="keyword">use</span> jfedu</span>
<span class="line">source /tmp/jfedu.sql</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置复制</span></span>
<span class="line">CHANGE MASTER TO </span>
<span class="line">    MASTER_HOST=<span class="string">'10.245.231.201'</span>,</span>
<span class="line">    MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">    MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">    MASTER_PASSWORD=<span class="string">'rep123'</span>,</span>
<span class="line">    MASTER_LOG_FILE=<span class="string">'binlog.000037'</span>, </span>
<span class="line">    MASTER_LOG_POS=<span class="number">1329</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 开启slave</span></span>
<span class="line">start slave;</span>
<span class="line"><span class="comment">## 或者分两条</span></span>
<span class="line">start slave io_thread;</span>
<span class="line">start slave sql_thread;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库备份后的表已经传到从库</span></span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| gyj_t3          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看slave状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.201</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000037</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">1653</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">604</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000037</span></span>
<span class="line">             Slave_IO_Running: Yes       <span class="comment"># 状态需为YES</span></span>
<span class="line">            Slave_SQL_Running: Yes       <span class="comment"># 状态需为YES</span></span>
<span class="line">              Replicate_Do_DB: </span>
<span class="line">          Replicate_Ignore_DB: </span>
<span class="line">           Replicate_Do_Table: </span>
<span class="line">       Replicate_Ignore_Table: </span>
<span class="line">      Replicate_Wild_Do_Table: </span>
<span class="line">  Replicate_Wild_Ignore_Table: </span>
<span class="line">                   Last_Errno: <span class="number">0</span></span>
<span class="line">                   Last_Error: </span>
<span class="line">                 Skip_Counter: <span class="number">0</span></span>
<span class="line">          Exec_Master_Log_Pos: <span class="number">1653</span></span>
<span class="line">              Relay_Log_Space: <span class="number">770</span></span>
<span class="line">              Until_Condition: None</span>
<span class="line">               Until_Log_File: </span>
<span class="line">                Until_Log_Pos: <span class="number">0</span></span>
<span class="line">           Master_SSL_Allowed: No</span>
<span class="line">           Master_SSL_CA_File: </span>
<span class="line">           Master_SSL_CA_Path: </span>
<span class="line">              Master_SSL_Cert: </span>
<span class="line">            Master_SSL_Cipher: </span>
<span class="line">               Master_SSL_Key: </span>
<span class="line">        Seconds_Behind_Master: <span class="number">0</span></span>
<span class="line">Master_SSL_Verify_Server_Cert: No</span>
<span class="line">                Last_IO_Errno: <span class="number">0</span></span>
<span class="line">                Last_IO_Error: </span>
<span class="line">               Last_SQL_Errno: <span class="number">0</span></span>
<span class="line">               Last_SQL_Error: </span>
<span class="line">  Replicate_Ignore_Server_Ids: </span>
<span class="line">             Master_Server_Id: <span class="number">101</span></span>
<span class="line">                  Master_UUID: <span class="number">3049</span>e83f-fef5-<span class="number">11</span>e6-<span class="number">9165</span>-<span class="number">005056</span>a02d56</span>
<span class="line">             Master_Info_File: <span class="regexp">/u01/data</span><span class="regexp">/3307/master</span>.info</span>
<span class="line">                    SQL_Delay: <span class="number">0</span></span>
<span class="line">          SQL_Remaining_Delay: NULL</span>
<span class="line">      Slave_SQL_Running_State: Slave has <span class="keyword">read</span> all relay <span class="keyword">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span>
<span class="line">           Master_Retry_Count: <span class="number">86400</span></span>
<span class="line">                  Master_Bind: </span>
<span class="line">      Last_IO_Error_Timestamp: </span>
<span class="line">     Last_SQL_Error_Timestamp: </span>
<span class="line">               Master_SSL_Crl: </span>
<span class="line">           Master_SSL_Crlpath: </span>
<span class="line">           Retrieved_Gtid_Set: </span>
<span class="line">            Executed_Gtid_Set: </span>
<span class="line">                Auto_Position: <span class="number">0</span></span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">ERROR: </span>
<span class="line">No query specified</span>
<span class="line"></span>
<span class="line"><span class="comment"># 停用slave</span></span>
<span class="line">stop slave;</span>
</pre></td></tr></table></figure>
<h2 id="主从复制的详细过程分析"><a href="#主从复制的详细过程分析" class="headerlink" title="主从复制的详细过程分析"></a>主从复制的详细过程分析</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_02.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">my3306-&gt; show processlist\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">     Id: <span class="number">258167</span></span>
<span class="line">   User: root</span>
<span class="line">   Host: localhost</span>
<span class="line">     db: jfedu</span>
<span class="line">Command: Query</span>
<span class="line">   Time: <span class="number">0</span></span>
<span class="line">  State: init</span>
<span class="line">   Info: show processlist</span>
<span class="line">*************************** <span class="number">2</span>. row ***************************</span>
<span class="line">     Id: <span class="number">260791</span></span>
<span class="line">   User: rep</span>
<span class="line">   Host: <span class="number">10.245</span>.<span class="number">231.201</span>:<span class="number">33130</span></span>
<span class="line">     db: NULL</span>
<span class="line">Command: Binlog Dump     <span class="comment"># Dump线程会发送所有binlog日志到从库</span></span>
<span class="line">   Time: <span class="number">2101</span></span>
<span class="line">  State: Master has sent all binlog to slave; waiting <span class="keyword">for</span> binlog to be updated</span>
<span class="line">   Info: NULL</span>
<span class="line"><span class="number">2</span> rows in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">my3306-&gt; show master status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000037</span>   <span class="comment"># binlog位置</span></span>
<span class="line">         Position: <span class="number">1653</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"></span>
<span class="line">my3306-&gt; show binlog events in <span class="string">'binlog.000037'</span>;</span>
<span class="line"></span>
<span class="line">my3307-&gt; show processlist;</span>
<span class="line">+----+-------------+-----------+-------+---------+------+-----------------------------------------------------------------------------+------------------+</span>
<span class="line">| Id | User        | Host      | db    | Command | Time | State                                                                       | Info             |</span>
<span class="line">+----+-------------+-----------+-------+---------+------+-----------------------------------------------------------------------------+------------------+</span>
<span class="line">|  <span class="number">5</span> | root        | localhost | jfedu | Query   |    <span class="number">0</span> | init                                                                        | show processlist |</span>
<span class="line">|  <span class="number">6</span> | <span class="keyword">system</span> user |           | NULL  | Connect | <span class="number">2307</span> | Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event                                            | NULL             |</span>
<span class="line">|  <span class="number">7</span> | <span class="keyword">system</span> user |           | NULL  | Connect | <span class="number">4181</span> | Slave has <span class="keyword">read</span> all relay <span class="keyword">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it | NULL             |</span>
<span class="line">+----+-------------+-----------+-------+---------+------+-----------------------------------------------------------------------------+------------------+</span>
<span class="line"></span>
<span class="line">mysqlbinlog -vv /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000037</span></span>
<span class="line">mysqlbinlog -vv /u01/<span class="keyword">log</span>/<span class="number">3307</span>/binlog/binlog.<span class="number">000017</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 从库生成binlog以下参数需要开启</span></span>
<span class="line">show variables like <span class="string">'sql_log_bin'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| sql_log_bin   | ON    |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">cat /u01/data/<span class="number">3307</span>/master.info</span>
<span class="line">cat /u01/<span class="keyword">log</span>/<span class="number">3307</span>/relay-log.info</span>
</pre></td></tr></table></figure></p>
<h2 id="主从复制相关参数"><a href="#主从复制相关参数" class="headerlink" title="主从复制相关参数"></a>主从复制相关参数</h2><h3 id="master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">server_id          <span class="comment"># 全局唯一</span></span>
<span class="line">read_only=OFF      <span class="comment"># 主库设置成OFF关闭</span></span>
<span class="line">sql_log_bin=ON     <span class="comment"># 默认是开启</span></span>
<span class="line">binlog_format=ROW</span>
<span class="line">binlog_cache_size  <span class="comment"># 有大事务时设置大些</span></span>
<span class="line">max_binlog_size</span>
<span class="line">expire_logs_days   <span class="comment"># binlog日志保留时间</span></span>
<span class="line">binlog-<span class="keyword">do</span>-db</span>
<span class="line">binlog-ignore-db</span>
</pre></td></tr></table></figure>
<h3 id="slave"><a href="#Slave" class="headerlink" title="Slave"></a>Slave</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">server_id          <span class="comment"># 全局唯一</span></span>
<span class="line">read_only=ON       <span class="comment"># 非级联时设置ON</span></span>
<span class="line">sql_log_bin=ON     <span class="comment"># 默认是开启</span></span>
<span class="line">log_slave_updates</span>
<span class="line">replicate-<span class="keyword">do</span>-db</span>
<span class="line">replicate-ignore-db</span>
<span class="line">replicate-<span class="keyword">do</span>-table</span>
<span class="line">replicate-ignore-table</span>
</pre></td></tr></table></figure>
<h2 id="binlog日志格式"><a href="#Binlog日志格式" class="headerlink" title="Binlog日志格式"></a>Binlog日志格式</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_03.png" alt=""></p>
<h2 id="semi-sync半同步复制"><a href="#Semi-sync半同步复制" class="headerlink" title="Semi-sync半同步复制"></a>Semi-sync半同步复制</h2><ul>
<li>Semi-sync最早是由Google实现的一个补丁</li>
<li>Semi-sync性能比较差（尤其是在网络慢且大并发时），在主数据库宕机后，Semi-sync能减少数据丢失的可能性，但不能绝对保证数据不丢失</li>
<li>Semi-sync就是保证主库将日志先传输到备库，然后再返回给应用事务提交成功，流程如下:<br><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_04.png" alt=""></li>
</ul>
<p>开启步骤<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ll /u01/mysql/lib/plugin/semi*</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> mysql mysql <span class="number">424735</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">00</span> /u01/mysql/lib/plugin/semisync_master.so</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> mysql mysql <span class="number">247911</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">00</span> /u01/mysql/lib/plugin/semisync_slave.so</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库上执行</span></span>
<span class="line">install plugin rpl_semi_sync_master soname <span class="string">'semisync_master.so'</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%semi%'</span>;</span>
<span class="line">+------------------------------------+-------+</span>
<span class="line">| Variable_name                      | Value |</span>
<span class="line">+------------------------------------+-------+</span>
<span class="line">| rpl_semi_sync_master_enabled       | OFF   | <span class="comment"># 需要设置成ON</span></span>
<span class="line">| rpl_semi_sync_master_timeout       | <span class="number">10000</span> |</span>
<span class="line">| rpl_semi_sync_master_trace_level   | <span class="number">32</span>    |</span>
<span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span>
<span class="line">+------------------------------------+-------+</span>
<span class="line"><span class="number">4</span> rows in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">set global rpl_semi_sync_master_enabled=on;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 从库上执行</span></span>
<span class="line">install plugin rpl_semi_sync_slave soname <span class="string">'semisync_slave.so'</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%semi%'</span>;</span>
<span class="line">+---------------------------------+-------+</span>
<span class="line">| Variable_name                   | Value |</span>
<span class="line">+---------------------------------+-------+</span>
<span class="line">| rpl_semi_sync_slave_enabled     | OFF   |  <span class="comment"># 需要设置成ON</span></span>
<span class="line">| rpl_semi_sync_slave_trace_level | <span class="number">32</span>    |</span>
<span class="line">+---------------------------------+-------+</span>
<span class="line"></span>
<span class="line">set global rpl_semi_sync_slave_enabled=on;</span>
</pre></td></tr></table></figure></p>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><ol>
<li>Mysql主从复制是异步复制  问题：数据会丢失  课题：怎么解决数据丢失？</li>
<li>Mysql支持一主多从复制</li>
<li>Mysql支持级联复制</li>
<li>Mysql支持双向复制</li>
<li>Mysql 5.7开始可以多主一从，可以做多元复制，5.7以前只能有一个master</li>
<li>主服务器 写数据  binlog  –&gt;  从服务器  I/O线程（接收binlog，写到中继日志）  SQL线程（读relay log，event 应用日志写到从服务器数据库）</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[GoldenGate 12.1.2 新特性参数部分解释]]></title>
      <url>/2017/03/30/oracle/goldengate/GoldenGate%2012.1.2%20%E6%96%B0%E7%89%B9%E6%80%A7%E5%8F%82%E6%95%B0%E9%83%A8%E5%88%86%E8%A7%A3%E9%87%8A/</url>
      <content type="html"><![CDATA[<h2 id="logallsupcols"><a href="#LOGALLSUPCOLS" class="headerlink" title="LOGALLSUPCOLS"></a>LOGALLSUPCOLS</h2><p>Writes all supplementally logged columns to the trail, including those required for conflict detection and resolution and the scheduling columns required to support integrated Replicat. (Scheduling columns are primary key, unique index, and foreign key columns.) You configure the database to log these columns with GGSCI commands.<br>使用该参数可以记录所有附加日志信息并写入trail文件中。</p>
<h2 id="updaterecordformat-compact"><a href="#UPDATERECORDFORMAT-COMPACT" class="headerlink" title="UPDATERECORDFORMAT COMPACT"></a>UPDATERECORDFORMAT COMPACT</h2><p>Combines the before and after images of an UPDATE operation into a single record in the trail. This parameter is valid for Oracle databases version 12c and later to support Replicat in integrated mode. Although not a required parameter, UPDATERECORDFORMAT COMPACT is a best practice and significantly improves Replicat performance.<br>UPDATERECORDFORMAT参数可以控制抽取进程兼容更新操作的前镜像和后镜像信息并写入到一个trail文件中，但是一定要注意的是该参数必须在数据库版本是11.2.0.4或者12c版本。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Oracle expdp中INCLUDE参数限制4000个字符的解决办法]]></title>
      <url>/2017/03/29/oracle/Oracle_DataPump_INCLUDE_%E5%8F%82%E6%95%B0%E9%99%90%E5%88%B64000%E4%B8%AA%E5%AD%97%E7%AC%A6%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
      <content type="html"><![CDATA[<p>使用expdp的include参数，当需要包含大量表时，一旦字符超4000时就会报错<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">expdp DADM/passwd DIRECTORY=DMP_DIR SCHEMAS=DADM</span>
<span class="line">DUMPFILE=dadm_tables_data.dmp CONTENT=DATA_ONLY </span>
<span class="line">INCLUDE=TABLE:<span class="string">"IN ('CBTRFCC','CBTFCCN','CGTGCDD','CGDSALC',</span>
<span class="line">...</span>
<span class="line">'CGTRSGR','CBTFCCE','CGTREPD','CPDORPG')"</span></span>
<span class="line"></span>
<span class="line">UDE-<span class="number">00014</span> : invalid value <span class="keyword">for</span> parameter, <span class="string">'include'</span>.</span>
</pre></td></tr></table></figure></p>
<p>使用以下技巧可以解决<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">CREATE TABLE list_of_tables ( tbl_name VARCHAR2(<span class="number">30</span>) );</span>
<span class="line">INSERT INTO list_of_tables ( <span class="string">'CBTRFCC'</span> );</span>
<span class="line">INSERT INTO list_of_tables ( <span class="string">'CBTFCCN'</span> );</span>
<span class="line">...</span>
<span class="line">INSERT INTO list_of_tables ( <span class="string">'CPDORPG'</span> );</span>
<span class="line">COMMIT;</span>
<span class="line"></span>
<span class="line">expdp DADM/passwd DIRECTORY=DMP_DIR SCHEMAS=DADM DUMPFILE=dadm_data.dmp </span>
<span class="line">CONTENT=DATA_ONLY include=TABLE:<span class="string">"IN (SELECT tbl_name FROM list_of_tables)"</span></span>
</pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Oracle Database 11g工作中常用的命令和脚本整理]]></title>
      <url>/2017/03/28/oracle/Oracle%2011g%E5%B7%A5%E4%BD%9C%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E5%92%8C%E8%84%9A%E6%9C%AC%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="设置oracle用户密码永不过期"><a href="#设置Oracle用户密码永不过期" class="headerlink" title="设置Oracle用户密码永不过期"></a>设置Oracle用户密码永不过期</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter profile default limit PASSWORD_LIFE_TIME unlimited;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看设置</span></span>
<span class="line"><span class="keyword">select</span> * from dba_profiles where resource_name like <span class="string">'PASSWORD_LIFE_TIME%'</span>;</span>
</pre></td></tr></table></figure>
<h2 id="设置oracle用户登陆失败次数限制"><a href="#设置Oracle用户登陆失败次数限制" class="headerlink" title="设置Oracle用户登陆失败次数限制"></a>设置Oracle用户登陆失败次数限制</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置登陆失败次数限制为100，错误登陆数超过100会导致用户被锁</span></span>
<span class="line">alter profile default limit FAILED_LOGIN_ATTEMPTS <span class="number">100</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 无限制</span></span>
<span class="line">alter profile default limit FAILED_LOGIN_ATTEMPTS unlimited;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看登陆失败限制设置</span></span>
<span class="line"><span class="keyword">select</span> * from dba_profiles where resource_name like <span class="string">'FAILED_LOGIN_ATTEMPTS%'</span>;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="系统进程pid查找对应sqltext"><a href="#系统进程PID查找对应SQLTEXT" class="headerlink" title="系统进程PID查找对应SQLTEXT"></a>系统进程PID查找对应SQLTEXT</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sql_text <span class="keyword">FROM</span> v$sqltext a </span>
<span class="line">  <span class="keyword">WHERE</span> (a.hash_value, a.address) <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">DECODE</span> (sql_hash_value,<span class="number">0</span>, prev_hash_value,sql_hash_value),</span>
<span class="line">        <span class="keyword">DECODE</span> (sql_hash_value, <span class="number">0</span>, prev_sql_addr, sql_address)</span>
<span class="line">    <span class="keyword">FROM</span> v$<span class="keyword">session</span> b <span class="keyword">WHERE</span> b.paddr = (<span class="keyword">SELECT</span> addr <span class="keyword">FROM</span> v$process c <span class="keyword">WHERE</span> c.spid =&amp;pid)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> piece <span class="keyword">ASC</span>;</span>
</pre></td></tr></table></figure>
<h2 id="查找长事务对应的sqltext"><a href="#查找长事务对应的SQLTEXT" class="headerlink" title="查找长事务对应的SQLTEXT"></a>查找长事务对应的SQLTEXT</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">with ltr as ( </span>
<span class="line"><span class="keyword">select</span> to_char(<span class="keyword">sysdate</span>,<span class="string">'YYYYMMDDHH24MISS'</span>) TM, </span>
<span class="line">       s.sid, </span>
<span class="line">       s.sql_id, </span>
<span class="line">       s.sql_child_number, </span>
<span class="line">       s.prev_sql_id, </span>
<span class="line">       xid, </span>
<span class="line">       to_char(t.start_date,<span class="string">'YYYYMMDDHH24MISS'</span>) start_time, </span>
<span class="line">       e.TYPE,e.block, </span>
<span class="line">       e.ctime, </span>
<span class="line">       <span class="keyword">decode</span>(e.CTIME, <span class="number">0</span>, (<span class="keyword">sysdate</span> - t.start_date) * <span class="number">3600</span>*<span class="number">24</span>, e.ctime) el_second </span>
<span class="line">  <span class="keyword">from</span> v$<span class="keyword">transaction</span> t, v$<span class="keyword">session</span> s,v$transaction_enqueue e</span>
<span class="line"> <span class="keyword">where</span> t.start_date &lt;= <span class="keyword">sysdate</span> - <span class="built_in">interval</span> <span class="string">'200'</span> <span class="keyword">second</span></span>
<span class="line">   <span class="keyword">and</span> t.addr = s.taddr </span>
<span class="line">   <span class="keyword">and</span> t.addr = e.addr(+) ) </span>
<span class="line">  <span class="keyword">select</span> ltr.* , (<span class="keyword">select</span> q1.sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> q1 <span class="keyword">where</span> ltr.prev_sql_id = q1.sql_id(+)</span>
<span class="line">   <span class="keyword">and</span> <span class="keyword">rownum</span> = <span class="number">1</span>) prev_sql_text , </span>
<span class="line">  (<span class="keyword">select</span> q1.sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> q1 <span class="keyword">where</span> ltr.sql_id = q1.sql_id(+) </span>
<span class="line">   <span class="keyword">and</span> ltr.sql_child_number = q1.CHILD_NUMBER(+)) sql_text </span>
<span class="line">   <span class="keyword">from</span> ltr ltr;</span>
</pre></td></tr></table></figure>
<h2 id="永久设置sqlplus的环境变量"><a href="#永久设置sql-plus的环境变量" class="headerlink" title="永久设置sql*plus的环境变量"></a>永久设置sql*plus的环境变量</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">echo <span class="string">"set pagesize 9999"</span> &gt;&gt; $ORACLE_HOME/sqlplus/admin/glogin.sql</span>
<span class="line">echo <span class="string">"set line 150"</span> &gt;&gt; $ORACLE_HOME/sqlplus/admin/glogin.sql</span>
<span class="line">echo <span class="string">"set long 5000"</span> &gt;&gt; $ORACLE_HOME/sqlplus/admin/glogin.sql</span>
</pre></td></tr></table></figure>
<h2 id="查找非系统用户中无主键表"><a href="#查找非系统用户中无主键表" class="headerlink" title="查找非系统用户中无主键表"></a>查找非系统用户中无主键表</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> at.TABLE_NAME, at.OWNER, at.NUM_ROWS</span>
<span class="line"><span class="keyword">from</span> </span>
<span class="line">  (<span class="keyword">SELECT</span> owner,table_name <span class="keyword">FROM</span> all_tables <span class="keyword">WHERE</span> owner <span class="keyword">in</span> </span>
<span class="line">   (<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>))</span>
<span class="line"><span class="keyword">MINUS</span></span>
<span class="line">  <span class="keyword">SELECT</span> owner,table_name <span class="keyword">FROM</span> all_constraints <span class="keyword">WHERE</span> owner <span class="keyword">in</span> </span>
<span class="line">   (<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>)) </span>
<span class="line">  <span class="keyword">AND</span> constraint_type = <span class="string">'P'</span> ) vn, all_tables <span class="keyword">at</span></span>
<span class="line"><span class="keyword">where</span> vn.TABLE_NAME=at.TABLE_NAME <span class="keyword">and</span> vn.OWNER=at.OWNER <span class="keyword">and</span> at.TABLE_NAME <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">'%$%'</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>,<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h2 id="查询有object的schema"><a href="#查询有Object的schema" class="headerlink" title="查询有Object的schema"></a>查询有Object的schema</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> OWNER,<span class="keyword">count</span>(OBJECT_NAME) OBJECT_NUM <span class="keyword">from</span> dba_objects <span class="keyword">where</span> OWNER <span class="keyword">in</span></span>
<span class="line">    (<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>)) <span class="keyword">and</span> OBJECT_TYPE=<span class="string">'TABLE'</span></span>
<span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> OWNER;</span>
</pre></td></tr></table></figure>
<h2 id="动态性能视图授权普通用户查看权限"><a href="#动态性能视图授权普通用户查看权限" class="headerlink" title="动态性能视图授权普通用户查看权限"></a>动态性能视图授权普通用户查看权限</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> v_$<span class="keyword">session</span> <span class="keyword">to</span> &lt;<span class="keyword">schema</span>&gt;;</span>
<span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> v_$locked_object <span class="keyword">to</span> &lt;<span class="keyword">schema</span>&gt;;</span>
</pre></td></tr></table></figure>
<h2 id="查看并kill掉锁对象"><a href="#查看并kill掉锁对象" class="headerlink" title="查看并kill掉锁对象"></a>查看并kill掉锁对象</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> v$locked_object;</span>
<span class="line"><span class="keyword">select</span> object_name,object_type <span class="keyword">from</span> dba_objects <span class="keyword">where</span> object_id=&amp;object_id;</span>
<span class="line"><span class="keyword">select</span> <span class="keyword">sid</span>, <span class="built_in">serial</span>#, machine, program <span class="keyword">from</span> v$<span class="keyword">session</span> <span class="keyword">where</span> <span class="keyword">sid</span>=&amp;<span class="keyword">sid</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">set</span> line <span class="number">150</span></span>
<span class="line"><span class="keyword">col</span> OWNER <span class="keyword">for</span> a20</span>
<span class="line"><span class="keyword">col</span> OBJECT_NAME <span class="keyword">for</span> a20</span>
<span class="line"><span class="keyword">select</span> s.SID,s.SERIAL#,lo.PROCESS,lo.LOCKED_MODE,do.OWNER,do.OBJECT_NAME,do.OBJECT_TYPE</span>
<span class="line">  <span class="keyword">from</span> v$locked_object lo, dba_objects <span class="keyword">do</span>, v$<span class="keyword">session</span> s</span>
<span class="line">  <span class="keyword">where</span> lo.OBJECT_ID=do.OBJECT_ID <span class="keyword">and</span> lo.SESSION_ID=s.SID;</span>
<span class="line"></span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">kill</span> <span class="keyword">session</span> <span class="string">'&amp;sid,&amp;serial'</span>;</span>
</pre></td></tr></table></figure>
<h2 id="生成删除所有普通用户及其数据脚本"><a href="#生成删除所有普通用户及其数据脚本" class="headerlink" title="生成删除所有普通用户及其数据脚本"></a>生成删除所有普通用户及其数据脚本</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'drop user '</span> || username || <span class="string">' cascade;'</span> <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>);</span>
</pre></td></tr></table></figure>
<h2 id="启动关闭数据库"><a href="#启动-关闭数据库" class="headerlink" title="启动/关闭数据库"></a>启动/关闭数据库</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">startup</span>
<span class="line">startup nomount</span>
<span class="line">startup mount</span>
<span class="line">startup open read only;</span>
<span class="line">startup restrict</span>
</pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hexo文章的密码访问]]></title>
      <url>/2017/03/28/tools/Hexo%E6%96%87%E7%AB%A0%E7%9A%84%E5%AF%86%E7%A0%81%E8%AE%BF%E9%97%AE/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>工作中有些文档中的部分内容，虽然机密性不高，但也不便在网上直接公开发布。 这时可以通过以下的小技巧来实现<code>简单</code>的文档密码保护。</p>
<h2 id="方法实现"><a href="#方法实现" class="headerlink" title="方法实现"></a>方法实现</h2><p>因Hexo中Markdown语言和html是混用的，所以可直接在Markdown中直接插入以下这段<code>script</code>(建议放到<code>&lt;!-- more --&gt;</code>段后面)。<br>这里用到了windows对象的<code>alert()</code>方法和<code>prompt()</code>方法。<code>prompt()</code>方法的作用即是显示一个可提示用户输入的对话框，而其本身的返回值就是你输入的那个字符串。因此只需要将其与你默认的密码比较一下就好，如果不正确，则直接将当前页面的loaction属性设为上一个页面即可。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span>
<span class="line">    <span class="keyword">if</span>(<span class="string">"123"</span>==prompt(<span class="string">"请输入文档密码"</span>))</span>
<span class="line">    &#123;</span>
<span class="line">        alert(<span class="string">"密码正确"</span>);</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">else</span></span>
<span class="line">    &#123;</span>
<span class="line">        alert(<span class="string">"密码错误返回主页"</span>);</span>
<span class="line">        location=<span class="string">"/"</span>;</span>
<span class="line">    &#125;</span>
<span class="line">&lt;<span class="regexp">/script&gt;</span></span>
</pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[数据库GI PSU，SPU(CPU)，Bundle Patches 和 Patchsets 补丁号码快速参考 (文档 ID 1922396.1)]]></title>
      <url>/2017/03/28/oracle/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A5%E4%B8%81%E5%8F%B7%E7%A0%81%E5%BF%AB%E9%80%9F%E5%8F%82%E8%80%83%20(%E6%96%87%E6%A1%A3%20ID%201922396.1)/</url>
      <content type="html"><![CDATA[<p>原文件地址(需登陆MOS)：<br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=247921994816714&amp;id=1922396.1" target="_blank" rel="external">https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=247921994816714&amp;id=1922396.1 </a></p>
<h2 id="base-releases"><a href="#Base-Releases" class="headerlink" title="Base Releases"></a>Base Releases</h2><blockquote>
<p>12.2.0.1.0  12.2.0.1.0 Download Page<br>12.1.0.1.0  开一个非技术SR来获取物理介质或下载链接,根据Doc ID 1071023.1<br>11.2.0.1.0  11.2.0.1.0 Download Page<br>Older Versions  开一个非技术SR来获取物理介质或下载链接,根据Doc ID 1071023.1<br> 注意: 对于11.2.0.2或者更高的patchsets, 请参照patch的readme中”Software Availability”部分下的”Table 1 Installation Types and Associated Zip Files”来查找具体哪些zip文件需要下载。</p>
</blockquote>
<a id="more"></a>
<h2 id="patchsets"><a href="#Patchsets" class="headerlink" title="Patchsets"></a>Patchsets</h2><p> l12.1.0.2 (12.1.0.2.0 PATCH SET FOR ORACLE DATABASE SERVER)     21419221<br> 11.2.0.4 (11.2.0.4.0 PATCH SET FOR ORACLE DATABASE SERVER)  13390677<br> 11.2.0.3 (11.2.0.3.0 PATCH SET FOR ORACLE DATABASE SERVER)  10404530<br> 11.2.0.2 (11.2.0.2.0 PATCH SET FOR ORACLE DATABASE SERVER)  10098816<br> 11.1.0.7 (11.1.0.7.0 PATCH SET FOR ORACLE DATABASE SERVER)  6890831<br> 10.2.0.5 (10.2.0.5 PATCH SET FOR ORACLE DATABASE SERVER)    8202632<br> d10.2.0.4 (10.2.0.4.0 PATCH SET FOR ORACLE DATABASE SERVER)     6810189<br> e10.2.0.3 (10.2.0.3 PATCH SET FOR ORACLE DATABASE SERVER)   5337014<br> 10.2.0.2 (10.2.0.2 PATCH SET FOR ORACLE DATABASE SERVER)    4547817<br> 10.1.0.5 (10.1.0.5 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4505133<br> 10.1.0.4 (10.1.0.4 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4163362<br> 10.1.0.3 (10.1.0.3 PATCH SET FOR ORACLE DATABASE SERVER)<br> 3761843<br> 9.2.0.8 (9.2.0.8 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4547809<br> 9.2.0.7 (9.2.0.7 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4163445<br> 9.2.0.6 (9.2.0.6 PATCH SET FOR ORACLE DATABASE SERVER)<br> 3948480<br> 9.2.0.5 (ORACLE 9I DATABASE SERVER RELEASE 2 - PATCH SET 4 VERSION 9.2.0.5.0)<br> 3501955<br> 9.2.0.4 (9.2.0.4 PATCH SET FOR ORACLE DATABASE SERVER)<br> 3095277<br> 9.2.0.3 (9.2.0.3 PATCH SET FOR ORACLE DATABASE SERVER)<br> 2761332<br> 9.2.0.2 (9.2.0.2 PATCH SET FOR ORACLE DATABASE SERVER)<br> 2632931<br> 9.0.1.5 (9.0.1.5 PATCHSET)<br> 3301544<br> 9.0.1.4 (9.0.1.4 PATCH SET FOR ORACLE DATABASE SERVER)<br> 2517300<br> 9.0.1.3 (9.0.1.3. PATCH SET FOR ORACLE DATA SERVER)<br> 2271678<br> 8.1.7.4 (8.1.7.4 PATCH SET FOR ORACLE DATA SERVER)<br> 2376472<br> 8.1.7.3 (8.1.7.3 PATCH SET FOR ORACLE DATA SERVER)<br> 2189751<br> 8.1.7.2 (8.1.7.2.1 PATCH SET FOR ORACLE DATA SERVER)<br> 1909158</p>
<p>PSU, SPU(CPU), Bundle Patches</p>
<p>12.1.0.2</p>
<p> Description     PSU       GI PSU   Proactive Bundle Patch   Bundle Patch (Windows 32bit &amp; 64bit)<br> JAN2017     24732082 (12.1.0.2.170117)  24917825 (12.1.0.2.170117)  24968615 (12.1.0.2.170117)  25115951 (12.1.0.2.170117)<br> OCT2016     24006101 (12.1.0.2.161018)  24412235 (12.1.0.2.161018)  24448103 (12.1.0.2.161018)  24591642 (12.1.0.2.161018)<br> JUL2016     23054246 (12.1.0.2.160719)  23273629 (12.1.0.2.160719)  23273686 (12.1.0.2.160719)  23530387 (12.1.0.2.160719)<br> APR2016     22291127 (12.1.0.2.160419)  22646084 (12.1.0.2.160419)  22899531    22809813 (12.1.0.2.160419)<br> JAN2016     21948354 (12.1.0.2.160119)  22191349 (12.1.0.2.160119)  22243551    22310559 (12.1.0.2.160119)<br> OCT2015     21359755 (12.1.0.2.5)   21523234 (12.1.0.2.5)   21744410 (12.1.0.2.13)  21821214 (12.1.0.2.10)<br> JUL2015     20831110 (12.1.0.2.4)   20996835 (12.1.0.2.4)   21188742 (12.1.0.2.10)  21126814 (12.1.0.2.7)<br> APR2015     20299023 (12.1.0.2.3)   20485724 (12.1.0.2.3)   20698050 (12.1.0.2.7)   20684004 (12.1.0.2.4)<br> JAN2015     19769480 (12.1.0.2.2)   19954978 (12.1.0.2.2)   20141343 (12.1.0.2.4)   19720843 (12.1.0.2.1)<br> OCT2014     19303936 (12.1.0.2.1)   19392646 (12.1.0.2.1)   19404326 (12.1.0.2.1)   N/A</p>
<p>12.1.0.1</p>
<p> Description     PSU     GI PSU   Bundle Patch (Windows64bit)    Bundle Patch (Windows32bit)<br> JUL2016     23054354 (12.1.0.1.160719)  i23273935 / k23273958  (12.1.0.1.160719)   23530410 (12.1.0.1.160719)<br> APR2016     22291141 (12.1.0.1.160419)  i22654153 / k22654166 (12.1.0.1.160419)    22617408 (12.1.0.1.160419)<br> JAN2016     21951844 (12.1.0.1.160119)  j22191492 / k22191511 (12.1.0.1.160119)    22494866 (12.1.0.2.160119)<br> OCT2015     21352619 (12.1.0.1.9)   j21551666 / k21551685 (12.1.0.1.9) 21744907 (12.1.0.1.21)<br> JUL2015     20831107 (12.1.0.1.8)    j20996901 / k20996911 (12.1.0.1.8)    21076681  (12.1.0.1.20)<br> APR2015     20299016 (12.1.0.1.7)    j20485762 / k19971331 (12.1.0.1.7)    20558101 (12.1.0.1.18)<br> JAN2015     19769486 (12.1.0.1.6)   j19971324 / k19971331 (12.1.0.1.6) 20160748 (12.1.0.1.16)<br> OCT2014     19121550 (12.1.0.1.5)   j19392372 / k19392451 (12.1.0.1.5) 19542943 (12.1.0.1.14)<br> JUL2014     18522516 (12.1.0.1.4)   j18705901 / k18705972 (12.1.0.1.4) 19062327 (12.1.0.1.11)<br> APR2014     18031528 (12.1.0.1.3)   j18139660 / k18413105  (12.1.0.1.3)    18448604 (12.1.0.1.7)<br> JAN2014     17552800 (12.1.0.1.2)   17735306 (12.1.0.1.2)  17977915 (12.1.0.1.3)<br> OCT2013     17027533 (12.1.0.1.1)   17272829 (12.1.0.1.1)   17363796 (12.1.0.1.1)   17363795 (12.1.0.1.1)</p>
<p>11.2.0.4</p>
<p> Description     PSU     SPU(CPU)    GI PSU  Bundle Patch (Windows 32bit &amp; 64bit)<br> mJAN2017    N/A     N/A     N/A     N/A<br> OCT2016     24006111 (11.2.0.4.161018)  24433711 (11.2.0.4.161018)  24436338 (11.2.0.4.161018)  24922870 (11.2.0.4.161118)<br> JUL2016     23054359 (11.2.0.4.160719)  23177648 (11.2.0.4.160719)  23274134 (11.2.0.4.160719)  23530402 (11.2.0.4.160719)<br> APR2016     22502456 (11.2.0.4.160419)  22502493 (11.2.0.4.160419)  22646198 (11.2.0.4.160419)  22839608 (11.2.0.4.160419)<br> JAN2016     21948347 (11.2.0.4.160119)  21972320 (11.2.0.4.160119)  22191577 (11.2.0.4.160119)  22310544 (11.2.0.4.160119)<br> OCT2015     21352635 (11.2.0.4.8)   21352646    21523375 (11.2.0.4.8)   21821802 (11.2.0.4.20)<br> JUL2015     20760982 (11.2.0.4.7)   20803583    20996923 (11.2.0.4.7)   21469106 (11.2.0.4.18)<br> APR2015     20299013 (11.2.0.4.6)   20299015    20485808 (11.2.0.4.6)   20544696 (11.2.0.4.15)<br> JAN2015     19769489 (11.2.0.4.5)   19854503    19955028 (11.2.0.4.5)   20127071 (11.2.0.4.12)<br> OCT2014     19121551 (11.2.0.4.4)   19271443    19380115 (11.2.0.4.4)   19651773 (11.2.0.4.10)<br> JUL2014     18522509 (11.2.0.4.3)   18681862    18706472 (11.2.0.4.3)   18842982 (11.2.0.4.7)<br> APR2014     18031668 (11.2.0.4.2)   18139690    18139609 (11.2.0.4.2)   18296644 (11.2.0.4.4)<br> JAN2014     17478514 (11.2.0.4.1)   17551709    N/A     17987366 (11.2.0.4.1)</p>
<p>11.2.0.3</p>
<p> Description     PSU     SPU(CPU)    GI PSU  Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aJUL2015    20760997 (11.2.0.3.15)  20803576    20996944 (11.2.0.3.15)  21104036    21104035<br> APR2015     20299017 (11.2.0.3.14)  20299010    20485830 (11.2.0.3.14)  20420395    20420394<br> JAN2015     19769496 (11.2.0.3.13)  19854461    19971343 (11.2.0.3.13)  20233168    20233167<br> OCT2014     19121548 (11.2.0.3.12)  19271438    19440385 (11.2.0.3.12)  19618575    19618574<br> JUL2014     18522512 (11.2.0.3.11)  18681866    18706488 (11.2.0.3.11)  18940194    18940193<br> APR2014     18031683 (11.2.0.3.10)  18139695    18139678 (11.2.0.3.10)  18372244    18372243<br> JAN2014     17540582 (11.2.0.3.9)   17478415    17735354 (11.2.0.3.9)   18075406    17906981<br> OCT2013     16902043 (11.2.0.3.8)   17082364    17272731 (11.2.0.3.8)   17363850    17363844<br> JUL2013     16619892 (11.2.0.3.7)   16742095    16742216 (11.2.0.3.7)   16803775    16803774<br> APR2013     16056266 (11.2.0.3.6)   16294378    16083653 (11.2.0.3.6)   16345834    16345833<br> JAN2013     14727310 (11.2.0.3.5)   14841409    14727347 (11.2.0.3.5)   16042648    16042647<br> OCT2012     14275605 (11.2.0.3.4)   14390252    14275572 (11.2.0.3.4)   14613223    14613222<br> JUL2012     13923374 (11.2.0.3.3)   14038787    13919095 (11.2.0.3.3)   14223718    14223717<br> APR2012     13696216 (11.2.0.3.2)   13632717    13696251 (11.2.0.3.2)   13885389    13885388<br> JAN2012     13343438 (11.2.0.3.1)   13466801    13348650 (11.2.0.3.1)   13413168    13413167</p>
<p>11.2.0.2</p>
<p> Description     PSU      SPU(CPU)   GI PSU  Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aOCT2013    17082367 (11.2.0.2.12)  17082375    17272753 (11.2.0.2.12)  17363838    17363837<br> JUL2013     16619893 (11.2.0.2.11)  16742100    16742320 (11.2.0.2.11)  16345852    16345851<br> APR2013     16056267 (11.2.0.2.10)  16294412    16166868 (11.2.0.2.10)  16345846    16345845<br> JAN2013     14727315 (11.2.0.2.9)   14841437    14841385 (11.2.0.2.9)   16100399    16100398<br> OCT2012     14275621 (11.2.0.2.8)   14390377    14390437 (11.2.0.2.8)   14672268    14672267<br> JUL2012     13923804 (11.2.0.2.7)   14038791    14192201 (11.2.0.2.7)   14134043    14134042<br> APR2012     13696224 (11.2.0.2.6)   13632725    13696242 (11.2.0.2.6)   13697074    13697073<br> JAN2012     13343424 (11.2.0.2.5)   13343244    13653086 (11.2.0.2.5)   13413155    13413154<br> OCT2011     12827726 (11.2.0.2.4)   12828071    12827731 (11.2.0.2.4)   13038788    13038787<br> JUL2011     12419331 (11.2.0.2.3)   12419321    12419353 (11.2.0.2.3)   12714463    12714462<br> APR2011     11724916 (11.2.0.2.2)   11724984    12311357 (11.2.0.2.2)   11896292    11896290<br> JAN2011     10248523 (11.2.0.2.1)   N/A     N/A     10432053    10432052</p>
<p>11.2.0.1</p>
<p> Description     PSU     CPU     Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aJUL2011    12419378 (11.2.0.1.6)   12419278    12429529    12429528<br> APR2011     11724930 (11.2.0.1.5)   11724991    11731176    11883240<br> JAN2011     10248516 (11.2.0.1.4)   10249532    10432045    10432044<br> OCT2010     9952216 (11.2.0.1.3)    9952260     10100101    10100100<br> JUL2010     9654983 (11.2.0.1.2)    9655013     9736865     9736864<br> APR2010     9352237 (11.2.0.1.1)    9369797     N/A     N/A</p>
<p>11.1.0.7</p>
<p> Description     PSU     SPU(CPU)    Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br>JUL2015  20761024 (11.1.0.7.24)  20803573    21104030    21104029<br>APR2015  20299012 (11.1.0.7.23)  20299020    20420391    20420390<br>JAN2015  19769499 (11.1.0.7.22)  19854433    20126915    20126914<br>OCT2014  19152553 (11.1.0.7.21)  19274522    19609034    19609032<br>JUL2014  18522513 (11.1.0.7.20)  18681875    18944208    18944207<br>APR2014  18031726 (11.1.0.7.19)  18139703    18372258    18372257<br>JAN2014  17465583 (11.1.0.7.18)  17551415    17906936    17906935<br>OCT2013  17082366 (11.1.0.7.17)  17082374    17363760    17363759<br>JUL2013  16619896 (11.1.0.7.16)  16742110    16803788    16803787<br>APR2013  16056268 (11.1.0.7.15)  16308394    16345862    16345861<br>JAN2013  14739378 (11.1.0.7.14)  14841452    15848067    15848066<br>OCT2012  14275623 (11.1.0.7.13)  14390384    14672313    14672312<br> JUL2012     13923474 (11.1.0.7.12)  14038803    14109868    14109867<br> APR2012     13621679 (11.1.0.7.11)  13632731    13715810    13715809<br> JAN2012     13343461 (11.1.0.7.10)  13343453    13460956    13460955<br> OCT2011     12827740 (11.1.0.7.9)   12828097    12914916    12914915<br> JUL2011     12419384 (11.1.0.7.8)   12419265    12695278    12695277<br> APR2011     11724936 (11.1.0.7.7)   11724999    11741170    11741169<br> JAN2011     10248531 (11.1.0.7.6)   10249534    10350788    10350787<br> OCT2010     9952228  (11.1.0.7.5)   9952269     9773825     9773817<br> JUL2010     9654987 (11.1.0.7.4)    9655014     9869912     9869911<br> APR2010     9352179 (11.1.0.7.3)    9369783     9392335     9392331<br> JAN2010     9209238 (11.1.0.7.2)    9114072     9166861     9166858<br> OCT2009     8833297 (11.1.0.7.1)    8836375     8928977     8928976<br> JUL2009     N/A     8534338     8553515     8553512<br> APR2009     N/A     8290478     8343070     8343061</p>
<p>11.1.0.6</p>
<p> Description     CPU     Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aJUL2009    8534378     8563155     8563154<br> APR2009     8290402     8333657     8333655<br> JAN2009     7592335     7631981     7631980<br> OCT2008     7375639     7378393     7378392<br> JUL2008     7150417     7210197     7210195<br> APR2008     6864063     6867180     6867178 </p>
<p>10.2.0.5</p>
<p> Description     PSU     SPU(CPU)    Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> bJUL2015    20299014 (10.2.0.5.19)  20299021    20420387    20420386    N/A<br> APR2015     N/A     N/A     N/A     N/A     N/A<br> JAN2015     19769505 (10.2.0.5.18)  19854436    20126868    20126867    N/A<br> OCT2014     19274523 (10.2.0.5.17)  19274521    19618565    19618563    N/A<br> JUL2014     18522511 (10.2.0.5.16)  18681879    18940198    18940196    N/A<br> APR2014     18031728 (10.2.0.5.15)  18139709    18372261    18372259    N/A<br> JAN2014     17465584 (10.2.0.5.14)  17551414    17906974    17906972    N/A<br> OCT2014     17082365 (10.2.0.5.13)  17082371    N/A     17363822    N/A<br> JUL2013     16619894 (10.2.0.5.12)  16742123    16803782    16803780    16803781<br> APR2013     16056270 (10.2.0.5.11)  16270946    16345857    16345855    16345856<br> JAN2013     14727319 (10.2.0.5.10)  14841459    15848062    15848060    15848061<br> OCT2012     14275629 (10.2.0.5.9)   14390396    14553358    14553356    14553357<br> JUL2012     13923855 (10.2.0.5.8)   14038805    14134053    14134051    14134052<br> APR2012     13632743 (10.2.0.5.7)   13632738    13654815    13654814    13870404<br> JAN2012     13343471 (10.2.0.5.6)   13343467    13460968   13460967     N/A<br> OCT2011     12827745 (10.2.0.5.5)   12828105    c12914913   12914911    N/A<br> JUL2011     12419392 (10.2.0.5.4)   12419258    12429524    12429523    N/A<br> APR2011     11724962 (10.2.0.5.3)   11725006    12328269    12328268    N/A<br> JAN2011     10248542 (10.2.0.5.2)   10249537    10352673    10352672    N/A<br> OCT2010     9952230 (10.2.0.5.1)    9952270     10099855    10058290    N/A</p>
<p>10.2.0.4</p>
<p> Description     PSU     SPU(CPU)    Bundle Patch (Windows32bit)     Bundle Patch (Windows64bit)     Bundle Patch (WindowsItanium)<br> gJUL2013    16619897 (10.2.0.4.17)  16742253    N/A     N/A     N/A<br> gAPR2013    16056269 (10.2.0.4.16)  16270931    N/A     N/A     N/A<br> gJAN2013    14736542 (10.2.0.4.15)  14841471    N/A     N/A     N/A<br>gOCT2012     14275630 (10.2.0.4.14)  14390410    N/A     N/A     N/A<br>gJUL2012     13923851 (10.2.0.4.13)  14038814    N/A     N/A     N/A<br> aAPR2012    12879933 (10.2.0.4.12)  12879926    13928775    13928776    N/A<br> JAN2012     12879929 (10.2.0.4.11)  12879912    b13654060   N/A     N/A<br> OCT2011     12827778 (10.2.0.4.10)  12828112    12914908    12914910    12914909<br> JUL2011     12419397 (10.2.0.4.9)   12419249    12429519    12429521    12429520<br> APR2011     11724977 (10.2.0.4.8)   11725015    12328501    12328503    12328502<br> JAN2011     10248636 (10.2.0.4.7)   10249540    10349197    10349200    10349198<br> OCT2010     9952234 (10.2.0.4.6)    9952272     10084980    10084982    10084981<br> JUL2010     9654991 (10.2.0.4.5)    9655017     9777076     9777078     9777077<br> APR2010     9352164 (10.2.0.4.4)    9352191     9393548     9393550     9393549<br> JAN2010     9119284 (10.2.0.4.3)    9119226     9169457     9169460     9169458<br> OCT2009     8833280 (10.2.0.4.2)    8836308     8880857     8880861     8880858<br> JUL2009     8576156 (10.2.0.4.1)    8534387     8559466     8559467     8541782<br> APR2009     N/A     8290506     8307237     8307238     8333678<br> JAN2009     N/A     7592346     7584866     7584867     N/A<br> OCT2008     N/A     7375644     7386320     7386321     N/A<br> JUL2008     N/A     7150470     7218676     7218677     N/A</p>
<p>10.2.0.3</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)   Bundle Patch (Windows64bit)<br> aJAN2009    7592354     7631956     7631958     7631957<br> OCT2008     7369190     7353782     7353784     7353785<br> JUL2008     7150622     7252496     7252497     7252498<br> APR2008     6864068     6867054     6867055     6867056<br> JAN2008     6646853     6637237     6637238     6637239<br> OCT2007     6394981     6430171     6430173     6430174<br> JUL2007     6079591     6116131     6038242     6116139<br> APR2007     5901891     5948242     5916262     5948243<br> JAN2007     5881721     5846376     5846377     5846378</p>
<p>10.2.0.2</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)      Bundle Patch (Windows64bit)    Bundle Patch (WindowsItanium)<br> iJAN2009    7592355     N/A     N/A     N/A<br> hOCT2008    7375660     N/A     N/A     N/A<br> hJUL2008    7154083     N/A     N/A     N/A<br> hAPR2008    6864071     N/A     N/A     N/A<br> aJAN2008    6646850     N/A     N/A     N/A<br> fOCT2007    6394997     6397028     6397030     6397029<br> JUL2007     6079588     6013105     6013121     6013118<br> APR2007     5901881     5912173     5912179     5912176<br> JAN2007     5689957     5716143     5699839     5699824<br> OCT2006     5490848     5502226     5500921     5500894<br> JUL2006     5225799     5251025     5251028     5251026<br> APR2006     5079037     5140461     5140567     5140508</p>
<p>10.2.0.1</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (Windows64bit)     Bundle Patch (WindowsItanium)<br> APR2007     5901880     N/A     N/A     N/A<br> JAN2007     5689937     5695784     5695786     5695785<br> OCT2006     5490846     5500927     5500954     5500951<br> JUL2006     5225798     5239698     5239701     5239699<br> APR2006     5049080     5059238     5059261     5059251<br> JAN2006     4751931     4751539     4770480     4751549</p>
<p>10.1.0.5</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)      Bundle Patch (WindowsItanium)<br> JAN2012     13343482    13413002    13413003<br> OCT2011     12828135    12914905    12914906<br> JUL2011     12419228    12429517    12429518<br> APR2011     11725035    11731119    11731120<br> JAN2011     N/A     N/A     N/A<br> OCT2010     9952279     10089559    10089560<br> JUL2010     9655023     9683651     9683652<br> APR2010     9352208     9390288     9390289<br> JAN2010     9119261     9187104     9187105<br> OCT2009     8836540     8785211     8785212<br> JUL2009     8534394     8656224     8656226<br> APR2009     8290534     8300356     8300360<br> JAN2009     7592360     7486619     7586049<br> OCT2008     7375686     7367493     7367494<br> JUL2008     7154097     7047034     7047037<br> APR2008     6864078     6867107     6867108<br> JAN2008     6647005     6637274     6637275<br> OCT2007     6395024     6408393     6408394<br> JUL2007     6079585     6115804     6115818<br> APR2007     5901877     5907304     5907305<br> JAN2007     5689908     5716295     5634747<br> OCT2006     5490845     5500883     5500885<br> JUL2006     5225797     5251148     5251140<br> APR2006     5049074     5057606     5057609<br> JAN2006     4751932     4882231     4882236</p>
<p>10.1.0.4</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> APR2007     5901876     5909871     5909879<br> JAN2007     5689894     5695771     5695772<br> OCT2006     5490844     5500878     5500880<br> JUL2006     5225796     5239736     5239737<br> APR2006     5049067     5059200     5059227<br> JAN2006     4751928     4751259     4745040<br> OCT2005     4567866     4579182     4579188<br> JUL2005     4392423     4440706     4404600<br> APR2005     4210374     4287619     4287611</p>
<p>10.1.0.3</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JAN2007     5923277     N/A     N/A<br> OCT2006     5566825     N/A     N/A<br> JUL2006     5435164     N/A     N/A<br> APR2006     5158022     N/A     N/A<br> JAN2006     4751926     4741077     4741084<br> OCT2005     4567863     4567518     4567523<br> JUL2005     4392409     4389012     4389014<br> APR2005     4193286     4269715     4158888<br> JAN2005     4003062     4074232     3990812</p>
<p>10.1.0.2</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> APR2005     4193293     4181849     4213305<br> JUL2005     4400766     4388944     4388948<br> JAN2005     4003051     4104364     4083038</p>
<p>9.2.0.8</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JUL2010     9655027     9683644     9683645<br> APR2010     9352224     9390286     N/A<br> JAN2010     9119275     9187106     N/A<br> OCT2009     8836758     8785185     8785186<br> JUL2009     8534403     8427417     8427418<br> APR2009     8290549     8300340     8300346<br> JAN2009     7592365     7703210     7703212<br> OCT2008     7375695     7394394     7394402<br> JUL2008     7154111     7047026     7047029<br> APR2008     6864082     6867138     6867139<br> JAN2008     6646842     6637265     6637266<br> OCT2007     6395038     6417013     6417014<br> JUL2007     6079582     6130293     6130295<br> APR2007     5901875     5916268     5916275<br> JAN2007     N/A     N/A     N/A<br> OCT2006     5490859     5652380     5639519</p>
<p>9.2.0.7</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JUL2007     6079579     6146759     6146748<br> APR2007     5901872     5907274     5907275<br> JAN2007     5689875     5654905     5654909<br> OCT2006     5490841     5500873     5500874<br> JUL2006     5225794     5250980     5250981<br> APR2006     5049060     5064365     5064364<br> JAN2006     4751923     4751528     4741074<br> OCT2005     4567854     4579590     4579599<br> JUL2005     4547566     N/A     N/A   </p>
<p>9.2.0.6</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> OCT2006     5490840     5500865     5500871<br> JUL2006     5225793     5239794     5239793<br> APR2006     5049051     5059614     5059615<br> JAN2006     4751921     4751261     4751262<br> OCT2005     4567846     4579093     4579097<br> JUL2005     4392392     4445852     4401917<br> APR2005     4193295     4269928     4213298</p>
<p>9.2.0.5</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> OCT2006     5689708     N/A     N/A<br> JUL2006     5435138     N/A     N/A<br> APR2006     5219762     N/A     N/A<br> OCT2005     4560421     N/A     N/A<br> JUL2005     4392256     4387563     4391819<br> APR2005     4193299     4195791     4214192<br> JAN2005     4003006     4104374     3990809</p>
<p>9.2.0.4</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JAN2005     4002994     4104369     4083202</p>
<p>8.1.7.4</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)<br> JAN2007     5689799     5686514<br> OCT2006     5490835     5496067<br> JUL2006     5225788     5236412<br> APR2006     5045247     5057601<br> JAN2006     4751906     4751570<br> OCT2005     4560405     4554818<br> JUL2005     4392446     4437058<br> APR2005     4193312     4180163<br> JAN2005     4002909     3921893<br>OJVM PSU Patches</p>
<p>12.1.0.2</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)   Combo OJVM + DB PSU     Combo OJVM + GI PSU     Generic JDBC<br> JAN2017     24917972 (12.1.0.2.170117)  25112498 (12.1.0.2.170117)  24917069 (12.1.0.2.170117)  24917916 (12.1.0.2.170117)  Included in OJVM PSU<br> OCT2016     24315824 (12.1.0.2.161018)  24591630 (12.1.0.2.161018)  24433133 (12.1.0.2.161018)  24433148 (12.1.0.2.161018)  Included in OJVM PSU<br> JUL2016     23177536 (12.1.0.2.160719)  23515290 (12.1.0.2.160719)  23615289 (12.1.0.2.160719)  23615308 (12.1.0.2.160719)  23727148 (Included in OJVM PSU)<br> APR2016     22674709 (12.1.0.2.160419)  22839633 (12.1.0.2.160419)  22738582 (12.1.0.2.160419)  22738641 (12.1.0.2.160419)<br> JAN2016     22139226 (12.1.0.2.160119)  22311086 (12.1.0.2.160119)  22191659 (12.1.0.2.160119)  22191676 (12.1.0.2.160119)<br> OCT2015     21555660 (12.1.0.2.5)   21788394 (12.1.0.2.4)   21520444    21523260<br> JUL2015     21068507 (12.1.0.2.4)   21153530 (12.1.0.2.3)   21150768    21150782<br> APR2015     20415564 (12.1.0.2.3)   20391199 (12.1.0.2.2)   20834354    20834538<br> JAN2015     19877336 (12.1.0.2.2)   20225938 (12.1.0.2.1)   20132434    20132450<br> OCT2014 (12.1.0.2.1)    19282028        19791366    19791375</p>
<p>12.1.0.1</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)   Combo OJVM + DB PSU     Combo OJVM + GI PSU     Generic JDBC<br> JUL2016 (12.1.0.1.160719)   23177541    23515285    23615355    23615368<br> 23727043 (Included in OJVM PSU)</p>
<p> APR2016 (12.1.0.1.160419)   22674703    22839627    22738678    22738715    Included in OJVM PSU<br> JAN2016 (12.1.0.1.160119)   22139235    22311072    22191711    22191721<br> OCT2015 (12.1.0.1.5)    21555669    21788365    21744318    21744328<br> JUL2015 (12.1.0.1.4)    21068523    21153513    21150806    21150817<br> APR2015 (12.1.0.1.3)    20406245    20225909    20834568    20834579<br> JAN2015 (12.1.0.1.2)    19877342    20225916    20132482    20132489<br> OCT2014 (12.1.0.1.1)    19282024    19801531    19791363    19791360    19852357</p>
<p>11.2.0.4</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)    Combo OJVM + DB PSU    Combo OJVM + DB SPU     Combo OJVM + GI PSU     Generic JDBC<br> JAN2017 (11.2.0.4.170117)   24917954    25043019    24918033    25367810    24918228<br> Included in OJVM PSU</p>
<p> OCT2016 (11.2.0.4.161018)   24315821    24591637    24436313    24433791    24436346<br> Included in OJVM PSU</p>
<p> JUL2016 (11.2.0.4.160719)   23177551    23515277    23615392    23615381    23615403<br> 23727132 (Included in OJVM PSU)</p>
<p> APR2016 (11.2.0.4.160419)   22674697    22839614    22738777    22738732    22738793   Included in OJVM PSU<br> JAN2016 (11.2.0.4.160119)   22139245    22311053    22378146    22378121    22378167<br> OCT2015 (11.2.0.4.5)    21555791    21788344    21744343    21744335    21744348<br> JUL2015 (11.2.0.4.4)    21068539    21153498    21150851    21150829    21150864<br> APR2015 (11.2.0.4.3)    20406239    20225988    20834611    20834597    20834621<br> JAN2015 (11.2.0.4.2)    19877440    20225982    20132580    20132517    20132615<br> OCT2014 (11.2.0.4.1)    19282021   19799291     19791364    19791358    19791420    19852360</p>
<p>11.2.0.3</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)  Combo OJVM + DB PSU  Combo OJVM + DB SPU    Combo OJVM + GI PSU  Generic JDBC<br> JUL2015 (11.2.0.3.4)   21068553     21153470   21150891    21150885     21150904   </p>
<p> Included in OJVM PSU</p>
<p> APR2015 (11.2.0.3.3)   20406220     20391185   20834670    20834653     20834686<br> JAN2015 (11.2.0.3.2)   19877443     20227195   20132646    20132635     20132651<br> OCT2014 (11.2.0.3.1)   19282015     19806120   19791427    19791426    19791428    19852361</p>
<p>11.1.0.7</p>
<p>Description OJVM PSU (Linux/Unix)    OJVM BP (Windows)  Combo OJVM + DB PSU Combo OJVM + DB SPU  Combo OJVM + GI PSU    Generic JDBC<br> JUL2015 (11.1.0.7.4)    21068565    21153423    21150939    21150929     N/A   </p>
<p>  Included in OJVM PSU</p>
<p> APR2015 (11.1.0.7.3)    20406213    20391156    20834724    20834712     N/A<br> JAN2015 (11.1.0.7.2)    19877446    20227146    20132677    20132669     N/A<br> OCT2014 (11.1.0.7.1)    19282002    19806118    19791436    19791434     N/A    19852363</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[VMWare CentOS 虚拟机根分区磁盘扩容(基于LVM)]]></title>
      <url>/2017/03/24/linux/20170324_Vmware_centos_%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%B9%E5%88%86%E5%8C%BA%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9(%E5%9F%BA%E4%BA%8ELVM)/</url>
      <content type="html"><![CDATA[<h2 id="关闭虚拟机并修改虚拟机配置增大磁盘大小"><a href="#关闭虚拟机并修改虚拟机配置，增大磁盘大小" class="headerlink" title="关闭虚拟机并修改虚拟机配置，增大磁盘大小"></a>关闭虚拟机并修改虚拟机配置，增大磁盘大小</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/0324_lvm_resize_01.png" alt=""></p>
<a id="more"></a>
<h2 id="启动虚拟机后查看磁盘状态"><a href="#启动虚拟机后查看磁盘状态" class="headerlink" title="启动虚拟机后查看磁盘状态"></a>启动虚拟机后查看磁盘状态</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">df -hT</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Filesystem           Type   Size  Used Avail Use% Mounted on</span>
<span class="line">/dev/mapper/VolGroup-lv_root</span>
<span class="line">                     ext4    <span class="number">43</span>G  <span class="number">3.2</span>G   <span class="number">38</span>G   <span class="number">8</span>% <span class="regexp">/</span>
<span class="line">tmpfs                tmpfs  3.9G     0  3.9G   0% /dev</span><span class="regexp">/shm</span>
<span class="line">/dev</span><span class="regexp">/sda1            ext4   477M   82M  366M  19% /boot</span></span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">fdisk -l /dev/sda</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Disk /dev/sda: <span class="number">214.7</span> GB, <span class="number">214748364800</span> bytes             <span class="comment"># 磁盘sda已扩展到200G</span></span>
<span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">26108</span> cylinders</span>
<span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span>
<span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">Disk identifier: <span class="number">0x00070abb</span></span>
<span class="line"></span>
<span class="line">   Device Boot      Start         End      Blocks   Id  System</span>
<span class="line">/dev/sda1   *           <span class="number">1</span>          <span class="number">64</span>      <span class="number">512000</span>   <span class="number">83</span>  Linux</span>
<span class="line">Partition <span class="number">1</span> does <span class="keyword">not</span> end on cylinder boundary.</span>
<span class="line">/dev/sda2              <span class="number">64</span>        <span class="number">7833</span>    <span class="number">62401536</span>   <span class="number">8</span>e  Linux LVM</span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h2 id="查看lvm状态"><a href="#查看lvm状态" class="headerlink" title="查看lvm状态"></a>查看lvm状态</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pvs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  PV         VG       Fmt  Attr PSize  PFree</span>
<span class="line">  /dev/sda2  VolGroup lvm2 a--u <span class="number">59.51</span>g    <span class="number">0</span> </span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">vgs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  VG       <span class="comment">#PV #LV #SN Attr   VSize  VFree</span></span>
<span class="line">  VolGroup   <span class="number">1</span>   <span class="number">2</span>   <span class="number">0</span> wz--n- <span class="number">59.51</span>g    <span class="number">0</span> </span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">lvs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  LV      VG       Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span>
<span class="line">  lv_root VolGroup -wi-ao---- <span class="number">43.74</span>g                                                    </span>
<span class="line">  lv_swap VolGroup -wi-ao---- <span class="number">15.77</span>g </span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h2 id="创建新分区"><a href="#创建新分区" class="headerlink" title="创建新分区"></a>创建新分区</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">fdisk /dev/sda</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">WARNING: DOS-compatible mode is deprecated. Its strongly recommended to</span>
<span class="line">         switch off the mode (command <span class="string">'c'</span>) <span class="keyword">and</span> change display units to</span>
<span class="line">         sectors (command <span class="string">'u'</span>).</span>
<span class="line"></span>
<span class="line">Command (<span class="keyword">m</span> <span class="keyword">for</span> help): n       <span class="comment"># 输入n开始创建分区</span></span>
<span class="line">Command action</span>
<span class="line">   e   extended</span>
<span class="line">   p   primary partition (<span class="number">1</span>-<span class="number">4</span>)</span>
<span class="line">p</span>
<span class="line">Partition number (<span class="number">1</span>-<span class="number">4</span>): <span class="number">3</span>     <span class="comment"># 输入3创建sda3</span></span>
<span class="line">First cylinder (<span class="number">7833</span>-<span class="number">26108</span>, default <span class="number">7833</span>): </span>
<span class="line">Using default value <span class="number">7833</span></span>
<span class="line">Last cylinder, +cylinders <span class="keyword">or</span> +size&#123;K,M,G&#125; (<span class="number">7833</span>-<span class="number">26108</span>, default <span class="number">26108</span>): </span>
<span class="line">Using default value <span class="number">26108</span></span>
<span class="line"></span>
<span class="line">Command (<span class="keyword">m</span> <span class="keyword">for</span> help): w       <span class="comment"># 写入分区表</span></span>
<span class="line">The partition table has been altered!</span>
<span class="line"></span>
<span class="line">Calling ioctl() to re-<span class="keyword">read</span> partition table.</span>
<span class="line"></span>
<span class="line">WARNING: Re-reading the partition table failed with error <span class="number">16</span>: Device <span class="keyword">or</span> resource busy.</span>
<span class="line">The kernel still uses the old table. The new table will be used at</span>
<span class="line">the <span class="keyword">next</span> reboot <span class="keyword">or</span> after you run partprobe(<span class="number">8</span>) <span class="keyword">or</span> kpartx(<span class="number">8</span>)</span>
<span class="line">Syncing disks.    <span class="comment"># 需要重启后才能生效</span></span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h2 id="重启虚拟机-格式化新分区"><a href="#重启虚拟机-格式化新分区" class="headerlink" title="重启虚拟机 格式化新分区"></a>重启虚拟机 格式化新分区</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">fdisk -l /dev/sda</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Disk /dev/sda: <span class="number">214.7</span> GB, <span class="number">214748364800</span> bytes</span>
<span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">26108</span> cylinders</span>
<span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span>
<span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">Disk identifier: <span class="number">0x00070abb</span></span>
<span class="line"></span>
<span class="line">   Device Boot      Start         End      Blocks   Id  System</span>
<span class="line">/dev/sda1   *           <span class="number">1</span>          <span class="number">64</span>      <span class="number">512000</span>   <span class="number">83</span>  Linux</span>
<span class="line">Partition <span class="number">1</span> does <span class="keyword">not</span> end on cylinder boundary.</span>
<span class="line">/dev/sda2              <span class="number">64</span>        <span class="number">7833</span>    <span class="number">62401536</span>   <span class="number">8</span>e  Linux LVM</span>
<span class="line">/dev/sda3            <span class="number">7833</span>       <span class="number">26108</span>   <span class="number">146797950</span>   <span class="number">83</span>  Linux</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">mkfs.ext4 /dev/sda3</span>
</pre></td></tr></table></figure>
<h2 id="lvm扩容"><a href="#lvm扩容" class="headerlink" title="lvm扩容"></a>lvm扩容</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pvcreate /dev/sda3</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  Physical volume <span class="string">"/dev/sda3"</span> successfully created</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">pvs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  PV         VG       Fmt  Attr PSize   PFree  </span>
<span class="line">  /dev/sda2  VolGroup lvm2 a--u  <span class="number">59.51</span>g      <span class="number">0</span> </span>
<span class="line">  /dev/sda3           lvm2 ---- <span class="number">140.00</span>g <span class="number">140.00</span>g</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">ll /dev/mapper/</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">total <span class="number">0</span></span>
<span class="line">crw-rw----. <span class="number">1</span> root root <span class="number">10</span>, <span class="number">236</span> Mar <span class="number">24</span> <span class="number">11</span>:<span class="number">49</span> control</span>
<span class="line">lrwxrwxrwx. <span class="number">1</span> root root       <span class="number">7</span> Mar <span class="number">24</span> <span class="number">11</span>:<span class="number">49</span> VolGroup-lv_root -&gt; ../dm-<span class="number">0</span></span>
<span class="line">lrwxrwxrwx. <span class="number">1</span> root root       <span class="number">7</span> Mar <span class="number">24</span> <span class="number">11</span>:<span class="number">49</span> VolGroup-lv_swap -&gt; ../dm-<span class="number">1</span></span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">vgextend /dev/mapper/VolGroup /dev/sda3</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  Volume group <span class="string">"VolGroup"</span> successfully extended</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">lvextend -l +<span class="number">100</span>%FREE /dev/VolGroup/lv_root /dev/sda3</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  Size of logical volume VolGroup/lv_root changed from <span class="number">43.74</span> GiB (<span class="number">11198</span> extents) to <span class="number">183.74</span> GiB (<span class="number">47037</span> extents).</span>
<span class="line">  Logical volume lv_root successfully resized.</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">resize2fs /dev/VolGroup/lv_root</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">resize2fs <span class="number">1.43</span>-WIP (<span class="number">20</span>-Jun-<span class="number">2013</span>)</span>
<span class="line">Filesystem at /dev/VolGroup/lv_root is mounted on /; on-line resizing required</span>
<span class="line">old_desc_blocks = <span class="number">3</span>, new_desc_blocks = <span class="number">12</span></span>
<span class="line">The filesystem on /dev/VolGroup/lv_root is now <span class="number">48165888</span> blocks long.</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 扩容后查看磁盘使用情况</span></span>
<span class="line">df -h</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Filesystem            Size  Used Avail Use% Mounted on</span>
<span class="line">/dev/mapper/VolGroup-lv_root</span>
<span class="line">                      <span class="number">181</span>G  <span class="number">3.3</span>G  <span class="number">170</span>G   <span class="number">2</span>% <span class="regexp">/</span>
<span class="line">tmpfs                 3.9G     0  3.9G   0% /dev</span><span class="regexp">/shm</span>
<span class="line">/dev</span><span class="regexp">/sda1             477M   82M  366M  19% /boot</span></span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-09 MySQL性能优化的关键点]]></title>
      <url>/2017/03/20/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/09-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="服务器参数调优有哪些关键点"><a href="#服务器参数调优，有哪些关键点？" class="headerlink" title="服务器参数调优，有哪些关键点？"></a>服务器参数调优，有哪些关键点？</h2><ol>
<li>优化Linux内核参数，如关闭SWAP，调优网络参数、文件限制等</li>
<li>是否关闭NUMA</li>
<li>多网卡是否绑定</li>
<li>磁盘调度算法的选择</li>
<li>挂载磁盘时考虑添加的参数，如<code>noatime</code>和<code>nobarrier</code>等<a id="more"></a>
</li>
</ol>
<h2 id="mysql性能调优有哪些关键点经验"><a href="#MySQL性能调优有哪些关键点-经验？" class="headerlink" title="MySQL性能调优有哪些关键点/经验？"></a>MySQL性能调优有哪些关键点/经验？</h2><h3 id="应用访问的优化"><a href="#应用访问的优化" class="headerlink" title="应用访问的优化"></a>应用访问的优化</h3><ol>
<li>减少数据访问（减少磁盘访问），如尽量让应用去访问数据库的缓存服务器(Redis/Memcached)，性能提升1~1000倍，优化成本低</li>
<li>返回更少数据（减少网络传输或磁盘访问），性能提升1~100倍，优化成本低</li>
<li>减少交互次数（减少网络传输），性能提升1~10倍，优化成本低</li>
</ol>
<h3 id="服务器硬件的选型"><a href="#服务器硬件的选型" class="headerlink" title="服务器硬件的选型"></a>服务器硬件的选型</h3><p>跟据业务需求来最终选择确定MYSQL服务器的配件配置，如CPU的processor数，内存的大小，以及SSD+SAS的组合（活跃数据/随机访问的data文件放到SSD盘中，冷数据/顺序访问的binlog文件放到SAS磁盘中）等。</p>
<h3 id="操作系统优化"><a href="#操作系统优化" class="headerlink" title="操作系统优化"></a>操作系统优化</h3><h4 id="使用推荐的linux"><a href="#使用推荐的Linux" class="headerlink" title="使用推荐的Linux"></a>使用推荐的Linux</h4><ul>
<li>CentOS</li>
<li>Redhat</li>
<li>SUSE</li>
</ul>
<h4 id="关闭swap"><a href="#关闭SWAP" class="headerlink" title="关闭SWAP"></a>关闭SWAP</h4><blockquote>
<p><strong>注意：</strong> 在CentOS 6.4及更新版本的内核中设置vm.swappiness=0，有可能会导致MySQL数据库所在的系统出现内存溢出(OOM)，建议将vm.swappiness设置成1</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在CentOS 5.x/6.x中</span></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">vm.swappiness=<span class="number">1</span></span>
<span class="line">----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># CentOS 7.x中</span></span>
<span class="line"><span class="comment">## 查找到存在vm.swappiness参数的配置文件</span></span>
<span class="line">find /usr/lib/tuned -name <span class="string">'*.conf'</span> -type f -<span class="keyword">exec</span> <span class="keyword">grep</span> <span class="string">"vm.swappiness"</span> &#123;&#125; \+</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="regexp">/usr/lib</span><span class="regexp">/tuned/latency</span>-performance/tuned.conf:vm.swappiness=<span class="number">10</span></span>
<span class="line">/usr/lib/tuned/throughput-performance/tuned.conf:vm.swappiness=<span class="number">10</span></span>
<span class="line">/usr/lib/tuned/virtual-guest/tuned.conf:vm.swappiness = <span class="number">30</span></span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="comment"># 把以上3个文件中的vm.swappiness的值都修改为0或1</span></span>
</pre></td></tr></table></figure>
<h4 id="关闭numa"><a href="#关闭NUMA" class="headerlink" title="关闭NUMA"></a>关闭NUMA</h4><blockquote>
<p><strong>NUMA：</strong> 非统一内存访问架构(Non Uniform Memory Access Architecture)。<br>NUMA是一种用于多处理器的电脑记忆体设计，内存访问时间取决于处理器的内存位置。 在安装有多个CPU的计算机中，NUMA硬件可以通过将专用内存与CPU配对来显著提高性能。在NUMA下，处理器访问它自己的本地存储器的速度比非本地存储器(存储器的地方到另一个处理器之间共享的处理器或存储器)快一些。</p>
<p><strong>SMP：</strong> 共享存储型多处理机(Shared Memory mulptiProcessors), 也称为对称型多处理机(Symmetry MultiProcessors)。<br>SMP模式将多个处理器与一个集中的存储器相连。在SMP模式下，所有处理器都可以访问同一个系统物理存储器，这就意味着SMP系统只运行操作系统的一个拷贝。因此SMP系统有时也被称为一致存储器访问(UMA)结构体系，一致性意指无论在什么时候，处理器只能为内存的每个数据保持或共享唯一一个数值。很显然，SMP的缺点是可伸缩性有限，因为在存储器接口达到饱和的时候，增加处理器并不能获得更高的性能。</p>
</blockquote>
<p>SMP和NUMA架构对比图<br><img src="http://oligvdnzp.bkt.clouddn.com/0321_numa_smp.png" alt=""></p>
<p><strong><font color="red">MySQL采用了线程模式，对于NUMA特性的支持并不好，如果单机只运行一个MySQL实例，建议关闭NUMA，方法有以下几种：</font></strong><br>1.BIOS中设置关闭（推荐）<br>2.OS内核中设置关闭<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Centos 7参照以下方法</span></span>
<span class="line">grubby --update-kernel=ALL --args=<span class="string">"numa=off"</span></span>
<span class="line"><span class="comment"># 若要移除上面的修改，使用以下命令</span></span>
<span class="line">grubby --update-kernel=ALL --remove-args=<span class="string">"numa=off"</span></span>
</pre></td></tr></table></figure></p>
<p>3.启动MySQL时关闭<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">numactl --interleave=all mysqld</span>
</pre></td></tr></table></figure></p>
<blockquote>
<p>如果单机运行多个MySQL实例，可以将MySQL绑定在不同的CPU节点上，并且采用绑定的内存分配策略，强制在本节点内分配内存，这样既可以充分利用硬件的NUMA特性，又避免了单实例MySQL对多核CPU利用率不高的问题。详细可参考：<a href="http://www.hellodb.net/2011/06/mysql_multi_instance.html" target="_blank" rel="external">MySQL单机多实例方案</a></p>
</blockquote>
<h4 id="网卡优化"><a href="#网卡优化" class="headerlink" title="网卡优化"></a>网卡优化</h4><p>1.双网卡做成bond0<br>2.调整网络参数<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有可调参数命令是sysctl -a，根据服务器配置调整以下参数</span></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.ipv4.tcp_moderate_rcvbuf = <span class="number">1</span></span>
<span class="line">net.ipv4.tcp_wmem = <span class="number">4096</span>        <span class="number">16384</span>   <span class="number">4194304</span></span>
<span class="line">----------------------------------------------------------</span>
</pre></td></tr></table></figure></p>
<h4 id="磁盘调度设置"><a href="#磁盘调度设置" class="headerlink" title="磁盘调度设置"></a>磁盘调度设置</h4><p>MYSQL服务器IO调度算法一般要设置成NOOP或Deadline，推荐使用是<code>Deadline</code>算法。</p>
<ul>
<li>NOOP算法：全写为No Operation。 该算法实现了最简单的FIFO队列，所有IO请求大致按照先来后到的顺序进行操作。</li>
<li>CFQ算法：全写为Completely Fair Queuing。 该算法的特点是按照IO请求的地址进行排序，而不是按照先来后到的顺序来进行响应。</li>
<li>DEADLINE：在CFQ的基础上，解决了IO请求饿死的极端情况。除了CFQ本身具有的IO排序队列之外，DEADLINE额外分别为读IO和写IO提供了FIFO队列。</li>
<li>Anticipatory算法：CFQ和DEADLINE考虑的焦点在于满足零散IO请求上。对于连续的IO请求，比如顺序读，并没有做优化。为了满足随机IO和顺序IO混合的场景，Linux还支持ANTICIPATORY调度算法。</li>
</ul>
<p>查看和修改系统IO的调度方法<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看操作系统的IO调度方法(CentOS Linux)</span></span>
<span class="line">dmesg | <span class="keyword">grep</span> -i scheduler</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">[    <span class="number">1.508820</span>] io scheduler noop registered</span>
<span class="line">[    <span class="number">1.508827</span>] io scheduler deadline registered (default)</span>
<span class="line">[    <span class="number">1.508850</span>] io scheduler cfq registered</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">cat /sys/block/sda/queue/scheduler </span>
<span class="line"></span>
<span class="line"><span class="comment"># 临地更改I/O调度方法 </span></span>
<span class="line">echo deadline &gt; <span class="regexp">/sys/block</span><span class="regexp">/sda/queue</span><span class="regexp">/scheduler</span>
<span class="line"></span>
<span class="line"># 永久的更改I/</span>O调度方法(重启后生效)</span>
<span class="line"><span class="comment">## Centos 7参照以下方法</span></span>
<span class="line">grubby --info=ALL</span>
<span class="line">grubby --update-kernel=ALL --args=<span class="string">"elevator=deadline"</span></span>
<span class="line"></span>
<span class="line"><span class="comment">## Centos 5/6参照以下方法 </span></span>
<span class="line">vi /boot/grub/grub.conf </span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="comment"># 添加elevator=deadline到下行</span></span>
<span class="line">kernel /vmlinuz-<span class="number">2.6</span>.<span class="number">18</span>-<span class="number">274</span>.el5 ro root=LABEL=<span class="regexp">/ elevator=deadline rhgb quiet</span>
<span class="line">----------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h4 id="使用推荐的文件系统"><a href="#使用推荐的文件系统" class="headerlink" title="使用推荐的文件系统"></a>使用推荐的文件系统</h4><p>1.推荐用xfs/ext4<br>2.挂载盘时添加<code>noatime</code>和<code>nobarrier</code>参数，设置方法如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/fstab</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="regexp">/dev/mapper</span><span class="regexp">/cl-root     /</span>                       xfs     defaults,noatime,nobarrier        <span class="number">0</span> <span class="number">0</span></span>
<span class="line">----------------------------------------------------------</span>
</pre></td></tr></table></figure></p>
<blockquote>
<p>　　当文件被创建，修改和访问时，Linux系统会记录这些时间信息。当系统的读文件操作频繁时，记录文件最近一次被读取的时间信息，将是一笔不少的开销。所以，为了提高系统的性能，我们可以在读取文件时不修改文件的<code>atime</code>属性。可以通过在加载文件系统时使用<code>noatime</code>选项来做到这一点。当以<code>noatime</code>选项加载（mount）文件系统时，对文件的读取不会更新文件属性中的<code>atime</code>信息。设置<code>noatime</code>的重要性是消除了文件系统对文件的写操作，文件只是简单地被系统读取。由于写操作相对读来说要更消耗系统资源，所以这样设置可以明显提高服务器的性能。注意wtime信息仍然有效，任何时候文件被写，该信息仍被更新。</p>
<p>　　现在的很多文件系统会在数据提交时强制底层设备刷新cache，避免数据丢失，称之为<code>write barriers</code>。 但是，其实我们数据库服务器底层存储设备要么采用RAID卡，RAID卡本身的电池可以掉电保护；要么采用Flash卡，它也有自我保护机制，保证数据不会丢失。 所以我们可以安全的使用<code>nobarrier</code>挂载文件系统。对于<code>ext3</code>、<code>ext4</code>和<code>reiserfs</code>文件系统可以在mount时指定<code>barrier=0</code>；对于<code>xfs</code>可以指定<code>nobarrier</code>选项。</p>
</blockquote>
<h3 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h3><h4 id="实例优化修改参数"><a href="#实例优化，修改参数" class="headerlink" title="实例优化，修改参数"></a>实例优化，修改参数</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">innodb_buffer_pool_size        <span class="comment"># 相当于Oracle的SGA，一般设置为物理内存的70%-80%，设置的过大，会导致system的swap空间被占用，导致操作系统变慢，从而减低sql查询的效率</span></span>
<span class="line">innodb_thread_concurrency      <span class="comment"># 一般设置成小于CPU的核心数</span></span>
<span class="line">query_cache_type = <span class="number">0</span>           <span class="comment"># =0 关闭结果集缓存</span></span>
<span class="line">query_cache_size =<span class="number">0</span>            <span class="comment"># =0 关闭结果集缓存</span></span>
<span class="line">max_used_connections           <span class="comment"># 最大的连接数，根据应用实际情况来设置</span></span>
<span class="line">interactive_timeout            <span class="comment"># 应用交互超时等待</span></span>
<span class="line">wait_timeout                   <span class="comment"># 连接池超时等待</span></span>
<span class="line">innodb_io_capacity=<span class="number">20000</span>       <span class="comment"># innodb IO容量的设置，一般设置成IOPS的75%左右</span></span>
<span class="line">innodb_flush_log_at_trx_commit <span class="comment"># =1 每一次事务提交或事务外的指令都需要把日志写入（flush）硬盘</span></span>
<span class="line">sync_binlog                    <span class="comment"># =1 与innodb_flush_log_at_trx_commit=1 双1设置，提高数据安全性</span></span>
<span class="line">innodb_log_file_size           <span class="comment"># 日志文件的大小，日志放到SSD建议设4-8G，放到SAS盘建议设成1-2G</span></span>
<span class="line">innodb_log_files_in_group      <span class="comment"># 日志文件的数量</span></span>
<span class="line">innodb_flush_method            <span class="comment"># 有三个值：fdatasync(默认)，O_DSYNC，O_DIRECT，详细</span></span>
<span class="line">innodb_max_dirty_pages_pct     <span class="comment"># =50 用来控制在 InnoDB Buffer Pool 中可以不用写入数据文件中的Dirty Page的比例(已经被修但还没有从内存中写入到数据文件的脏数据)</span></span>
<span class="line">Innodb_flush_neighbors         <span class="comment"># =0或1 相邻的数据合并，SSD盘关闭此设置，SAS盘开启此设置</span></span>
<span class="line">transaction_isolation          <span class="comment"># 事务隔离级别，生产环境设置为READ-COMMITTED</span></span>
</pre></td></tr></table></figure>
<p>内存分配<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">All thread buffer =              <span class="comment"># 会话/线程级内存分配总和</span></span>
<span class="line">    max_threads * (              <span class="comment"># 当前活跃连接数</span></span>
<span class="line">      read_buffer_size           <span class="comment"># 顺序读缓冲，提高顺序读效率</span></span>
<span class="line">    + read_rnd_buffer_size       <span class="comment"># 随机读缓冲，提高随机读效率</span></span>
<span class="line">    + sort_buffer_size           <span class="comment"># 排序缓冲，提高排序效率</span></span>
<span class="line">    + join_buffer_size           <span class="comment"># 表连接缓冲，提高表连接效率</span></span>
<span class="line">    + binlog_cache_size          <span class="comment"># 二进制日志缓冲，提高二进制日志写入效率</span></span>
<span class="line">    + tmp_table_size             <span class="comment"># 内存临时表，提高临时表存储效率</span></span>
<span class="line">    + thread_stack               <span class="comment"># 线程堆栈，暂时寄存SQL语句/存储过程</span></span>
<span class="line">    + thread_cache_size          <span class="comment"># 线程缓存，降低多次反复打开线程开销</span></span>
<span class="line">    + net_buffer_length          <span class="comment"># 线程持连接缓冲以及读取结果缓冲</span></span>
<span class="line">    + bulk_insert_buffer_size    <span class="comment"># MyISAM表批量写入数据缓冲</span></span>
<span class="line">)</span>
<span class="line"></span>
<span class="line">global buffer =                  <span class="comment"># 全局内存分配总和 </span></span>
<span class="line">      innodb_buffer_pool_size    <span class="comment"># InnoDB高速缓冲，行数据、索引缓冲，以及事务锁、自适应哈希等</span></span>
<span class="line">    + innodb_additional_mem_pool_size <span class="comment"># InnoDB数据字典额外内存，缓存所有表数据字典</span></span>
<span class="line">    + innodb_log_buffer_size     <span class="comment"># InnoDB REDO日志缓冲，提高REDO日志写入效率</span></span>
<span class="line">    + key_buffer_size            <span class="comment"># MyISAM表索引高速缓冲，提高MyISAM表索引读写效率</span></span>
<span class="line">    + query_cache_size           <span class="comment"># 查询高速缓存，缓存查询结果，提高反复查询返回效率</span></span>
<span class="line">    + table_cahce                <span class="comment"># 表空间文件描述符缓存，提高数据表打开效率 </span></span>
<span class="line">    + table_definition_cache     <span class="comment"># 表定义文件描述符缓存，提高数据表打开效率</span></span>
</pre></td></tr></table></figure></p>
<p>innodb_flush_method参数<br><img src="http://oligvdnzp.bkt.clouddn.com/0322_innodb_flush_method.png" alt=""></p>
<h4 id="sql优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h4><ol>
<li><font color="red">禁止多于3表join</font>，尽量用单表查询</li>
<li>SELECT语句只获取需要的字段，禁止使用<code>select * from</code>语句，这是有效防止新增字段对应用逻辑的影响，还能减少对性能的影响</li>
<li>InnoDB表避免使用<code>COUNT(*)</code>操作，计数统计实时要求较强可以使用<code>memcache</code>或者<code>redis</code>，非实时统计可以使用单独统计表，定时更新</li>
<li>避免多余的排序。使用<code>GROUP BY</code>时，默认会进行排序，当你不需要排序时，可以使用<code>order by null</code>，例如<code>select a.OwnerUserID,count(*) cnt from DP_MessageList a group by a.OwnerUserID order by null;</code></li>
<li>新增排序要求：不鼓励在DB里排序，尽量放到app server上排序，app server有上百台，而DB仅仅个位数的服务器数量，排序都在DB，会把DB压垮</li>
<li>全模糊查询无法使用INDEX，应当尽可能避免，如：select * from table where name like ‘%hotgirl%;’，不建议使用%前缀模糊查询，例如LIKE ‘%weibo’。</li>
<li>使用IN代替OR。SQL语句中IN包含的值不应过多，应少于1000个</li>
<li>禁止隐式转换。数值类型禁止加引号；字符串类型必须加引号</li>
<li>禁止使用负向查询，例如not in、!=、not like</li>
<li><font color="red">select for update语法，必须重点review流程</font></li>
<li>尽量少用<code>or</code>，当<code>where</code>子句中存在多个条件以“或”并存的时候，MySQL的优化器并没有很好的解决其执行计划优化的问题，再加上MySQL特有的SQL与Storage分层架构方式，造成了其性能比较低下，很多时候使用<code>union all</code>或者<code>union</code>(必要的时候)的方式来代替<code>or</code>会得到更好的效果</li>
<li>尽量用<code>union all</code>代替<code>union</code>，<code>union</code>和<code>union all</code>的差异主要是前者需要将两个（或者多个）结果集合并后再进行唯一性过滤操作，这就会涉及到排序，增加大量的CPU运算，加大资源消耗及延迟。所以当我们可以确认不可能出现重复结果集或者不在乎重复结果集的时候，尽量使用union all而不是union</li>
<li>尽量早过滤，这一优化策略其实最常见于索引的优化设计中（将过滤性更好的字段放得更靠前），尽量用join代替子查询</li>
<li>禁止在主库上执行后台管理和统计类功能的QUERY，必要时申请统计类从库</li>
</ol>
<p>查看SQL执行计划示例<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain</span>
<span class="line">    -&gt; <span class="keyword">select</span> id,name from t2 where id=<span class="number">5</span>;</span>
<span class="line">+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span>
<span class="line">| id | select_type | table | type  | possible_keys | key     | key_len | <span class="keyword">ref</span>   | rows | Extra |</span>
<span class="line">+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | t2    | const | PRIMARY       | PRIMARY | <span class="number">4</span>       | const |    <span class="number">1</span> | NULL  |</span>
<span class="line">+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; explain</span>
<span class="line">    -&gt; <span class="keyword">select</span> id,name from t2 where name=<span class="string">'C'</span>;</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+</span>
<span class="line">| id | select_type | table | type | possible_keys | key  | key_len | <span class="keyword">ref</span>   | rows | Extra                    |</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | t2    | <span class="keyword">ref</span>  | name          | name | <span class="number">33</span>      | const |    <span class="number">1</span> | Using where; Using <span class="keyword">index</span> |</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure></p>
<h4 id="索引设计"><a href="#索引设计" class="headerlink" title="索引设计"></a>索引设计</h4><h5 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h5><ol>
<li>查询谓词都能够通过index进行扫描</li>
<li>排序谓词都能够利用index的有序性</li>
<li>index包含了查询所需要的所有字段</li>
</ol>
<h5 id="不能使用索引"><a href="#不能使用索引" class="headerlink" title="不能使用索引"></a>不能使用索引</h5><ol>
<li>不要给选择率低的字段建索引(通过索引扫描的记录数超过30%，变成全表扫描)</li>
<li>联合索引中：第一个索引列使用范围查询,第一个查询条件不是最左索引列</li>
<li>Like查询条件列最左以通配符% 开始</li>
<li>两个独立索引，其中一个用于检索，一个用于排序（索引不是越多越好，尽量合并索引）</li>
<li>表关联字段类型不一样（也包括长度不一样）</li>
<li>索引字段条件上使用函数</li>
<li>不要使用外健约束</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.ipcpu.com/2016/11/grub2-centos7/" target="_blank" rel="external">Grub2相对Grub的一些改进和注意事项（CentOS7）</a></li>
<li><a href="https://linux.cn/article-3479-1.html" target="_blank" rel="external">LINUX上MYSQL优化三板斧</a></li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CentOS7.3安装图解]]></title>
      <url>/2017/03/18/linux/20170318_CentOS7.3%E5%AE%89%E8%A3%85%E5%9B%BE%E8%A7%A3/</url>
      <content type="html"><![CDATA[<p>光标向上移动，选择<code>Install CentOS Linux</code>不测试安装光盘，节省安装时间<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_01.png" alt=""><br>直接回车开始<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_02.png" alt=""><br><a id="more"></a><br>选择语言，这里我就使用英文<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_03.png" alt=""><br>这里是跟CentOS6.X区别比较大的地方，所有的配置项都集中在一起，可以根据需要进行配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_05.png" alt=""><br>点击<code>DATE&amp;TIME</code>配置时区和时间<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_04.png" alt=""><br><code>KEYBOARD</code>和<code>LANGUAGE SUPPORT</code>前面已经设置过了，点击<code>SOFTWARE SELECTION</code>，选择服务器部署的类型（即都安装哪些软件包），我这里默认选择<code>Minimal Install</code>，如果你需要安装图形化界面，可以选择<code>Server with GUI</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_06.png" alt=""><br>点击<code>INSTALLATION DESTINATION</code>配置硬盘分区<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_07.png" alt=""><br>手动配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_08.png" alt=""><br>选<code>Click here to create them automatically</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_09.png" alt=""><br>在自动创建的分区上按业务(测试)需要进行修改，无误后点左上方的<code>Done</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_10.png" alt=""><br>同意变更<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_11.png" alt=""><br>点击<code>NETWORK&amp;HOSTNAME</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_12.png" alt=""><br>可在此界面进行网络和主机名配置，这里我先默认，不配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_13.png" alt=""><br>完成后，回到之前的配置集中页面，点击下方的<code>Begin Installation</code>，开始安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_14.png" alt=""><br>在安装的过程中，点击<code>ROOT PASSWORD</code>配置root用户密码<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_15.png" alt=""><br>设置完root密码后点<code>Done</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_16.png" alt=""><br>红色警告已标志已清除，等待软件包安装完成<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_17.png" alt=""><br>安装完成后，点击<code>Reboot</code>会重启服务器<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_18.png" alt=""><br>进入到字符界面，完成安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_19.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-08 MySQL监控系统之Zabbix]]></title>
      <url>/2017/03/13/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/08-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="部署zabbix监控"><a href="#部署zabbix监控" class="headerlink" title="部署zabbix监控"></a>部署zabbix监控</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>zabbix（音同 zbix）是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。<br>zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。<br>zabbix由2部分构成，zabbix server与可选组件zabbix agent。zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上。</p>
<p>为了使用最新3.2版本的Zabbix，本次部署选用的Linux OS是最新的CentOS7.3（php版本为5.4）。<br>CentOS6.X和CentOS7.X的安装和使用均有较大变化，为便于今后的学习和工作，下面将CentOS7.3的安装和基本配置也记录到本文中。</p>
<h3 id="安装centos73"><a href="#安装CentOS7-3" class="headerlink" title="安装CentOS7.3"></a>安装CentOS7.3</h3><p>详见：<a href="https://dbanote.github.io/2017/03/18/linux/20170318_CentOS7.3安装图解/" target="_blank" rel="external">CentOS7.3安装图解</a><br><a id="more"></a></p>
<h3 id="centos7x系统的基本配置和使用"><a href="#CentOS7-X系统的基本配置和使用" class="headerlink" title="CentOS7.X系统的基本配置和使用"></a>CentOS7.X系统的基本配置和使用</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看系统版本</span></span>
<span class="line">cat /etc/redhat-release</span>
<span class="line">-----------------------------------------------</span>
<span class="line">CentOS Linux release <span class="number">7.3</span>.<span class="number">1611</span> (Core) </span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置IP</span></span>
<span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens16<span class="number">0</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">TYPE=Ethernet</span>
<span class="line">BOOTPROTO=static</span>
<span class="line">DEFROUTE=yes</span>
<span class="line">PEERDNS=yes</span>
<span class="line">PEERROUTES=yes</span>
<span class="line">IPV4_FAILURE_FATAL=yes</span>
<span class="line">IPV6INIT=<span class="keyword">no</span></span>
<span class="line">NAME=ens16<span class="number">0</span></span>
<span class="line">UUID=<span class="number">38</span>e983c8-b6ad-<span class="number">40</span>cf-<span class="number">9592</span>-<span class="number">3</span>a3652cf8c6d</span>
<span class="line">DEVICE=ens16<span class="number">0</span></span>
<span class="line">ONBOOT=yes</span>
<span class="line">IPADDR=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">PREFIX=<span class="number">24</span></span>
<span class="line">GATEWAY=<span class="number">10.245</span>.<span class="number">231.254</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启网络，使配置生效</span></span>
<span class="line">service network restart</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置主机名</span></span>
<span class="line">hostnamectl status</span>
<span class="line">-----------------------------------------------</span>
<span class="line">   Static hostname: localhost.localdomain</span>
<span class="line">         Icon name: computer-vm</span>
<span class="line">           Chassis: vm</span>
<span class="line">        Machine ID: <span class="number">5</span>f66fc1b61374082a7e6e595fc7669c5</span>
<span class="line">           Boot ID: <span class="number">269679</span>da89c54fd4a736c6968b8644f3</span>
<span class="line">    Virtualization: vmware</span>
<span class="line">  Operating System: CentOS Linux <span class="number">7</span> (Core)</span>
<span class="line">       CPE OS Name: cpe:<span class="regexp">/o:centos:centos:7</span>
<span class="line">            Kernel: Linux 3.10.0-514.el7.x86_64</span>
<span class="line">      Architecture: x86-64</span>
<span class="line">-----------------------------------------------</span>
<span class="line">hostnamectl --static set-hostname zabbix</span>
<span class="line"></span>
<span class="line"># 禁用SELINUX</span>
<span class="line">setenforce 0</span>
<span class="line">vi /etc</span><span class="regexp">/selinux/config</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">SELINUX=disabled</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用防火墙</span></span>
<span class="line">systemctl disable firewalld</span>
<span class="line">systemctl status firewalld</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置内核参数(mysql需要)</span></span>
<span class="line">vi /etc/sysctl.d/<span class="number">99</span>-sysctl.conf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">kernel.shmmax = <span class="number">2199023255552</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使内核参数生效</span></span>
<span class="line">sysctl -p</span>
<span class="line"></span>
<span class="line"><span class="comment"># 常用CentOS7.x命令</span></span>
<span class="line"><span class="comment">## 查看所有系统服务状态</span></span>
<span class="line">systemctl list-unit-files -t service </span>
<span class="line"></span>
<span class="line"><span class="comment">## 查看系统启动以来的message信息(类似dmesg)</span></span>
<span class="line">journalctl -b</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看网络配置</span></span>
<span class="line">ip a</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span>
<span class="line">    <span class="keyword">link</span>/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span>
<span class="line">    inet <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/<span class="number">8</span> scope host lo</span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="number">2</span>: ens16<span class="number">0</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> UP qlen <span class="number">1000</span></span>
<span class="line">    <span class="keyword">link</span>/ether <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:a<span class="number">0</span>:<span class="number">1</span>d:b1 brd ff:ff:ff:ff:ff:ff</span>
<span class="line">    inet <span class="number">10.245</span>.<span class="number">231.202</span>/<span class="number">24</span> brd <span class="number">10.245</span>.<span class="number">231.255</span> scope global ens16<span class="number">0</span></span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 fe8<span class="number">0</span>::<span class="number">250</span>:<span class="number">56</span>ff:fea<span class="number">0</span>:<span class="number">1</span>db1/<span class="number">64</span> scope <span class="keyword">link</span> </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure>
<h3 id="源码编译安装mysql"><a href="#源码编译安装mysql" class="headerlink" title="源码编译安装mysql"></a>源码编译安装mysql</h3><p>参见博文：<a href="https://dbanote.github.io/2017/01/26/mysql/课程学习/02-MySQL-DBA从小白到大神实战/#详细描述mysql编译安装的过程截图安装步骤" target="_blank" rel="external">MySQL DBA从小白到大神实战-02 MySQL标准化、自动化部署</a></p>
<h3 id="安装和配置zabbix-server"><a href="#安装和配置zabbix-server" class="headerlink" title="安装和配置zabbix server"></a>安装和配置zabbix server</h3><h4 id="建zabbix用户-组和安装目录"><a href="#建zabbix用户、组和安装目录" class="headerlink" title="建zabbix用户、组和安装目录"></a>建zabbix用户、组和安装目录</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">groupadd zabbix</span>
<span class="line">useradd -g zabbix zabbix</span>
<span class="line">echo <span class="string">"zabbix"</span> | passwd --stdin zabbix</span>
<span class="line"></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/zabbix</span>
<span class="line"><span class="keyword">chown</span> -R zabbix:zabbix /u01/zabbix</span>
</pre></td></tr></table></figure>
<h4 id="安装编译基础依赖包"><a href="#安装编译基础依赖包" class="headerlink" title="安装编译基础依赖包"></a>安装编译基础依赖包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line"></span>
<span class="line">cd /etc/yum.repos.d/</span>
<span class="line">-----------------------------------------------</span>
<span class="line">cp CentOS-Base.repo CentOS-Base.repo.bak</span>
<span class="line">vi /etc/yum.repos.d/CentOS-Base.repo</span>
<span class="line">[base]</span>
<span class="line">name=CentOS-$releasever - Base</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span></span>
<span class="line">gpgcheck=<span class="number">0</span></span>
<span class="line">enabled=<span class="number">1</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line">yum -<span class="keyword">y</span> install wget unzip libxml2 libxml2-devel httpd php php-mysql php-common php-gd \</span>
<span class="line">php-odbc php-pear curl curl-devel net-snmp net-snmp-devel perl-DBI php-xml ntpdate  \</span>
<span class="line">zlib-devel glibc-devel curl-devel gcc automake openssl-devel net-snmp-devel rpm-devel \</span>
<span class="line">lrzsz ncurses-devel <span class="keyword">readline</span>-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># http://mirrors.sohu.com/centos/7.3.1611/os/x86_64/Packages/ 下载以下包并上传到服务器/tmp目录下</span></span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">126576</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">58</span> libidn-devel-<span class="number">1.28</span>-<span class="number">4</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">176988</span> Mar <span class="number">14</span> <span class="number">13</span>:<span class="number">46</span> OpenIPMI-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">136452</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">58</span> OpenIPMI-devel-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">513864</span> Mar <span class="number">14</span> <span class="number">13</span>:<span class="number">42</span> OpenIPMI-libs-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root  <span class="number">15440</span> Mar <span class="number">14</span> <span class="number">13</span>:<span class="number">45</span> OpenIPMI-modalias-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root  <span class="number">58488</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">57</span> php-bcmath-<span class="number">5.4</span>.<span class="number">16</span>-<span class="number">42</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">516620</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">57</span> php-mbstring-<span class="number">5.4</span>.<span class="number">16</span>-<span class="number">42</span>.el7.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 手动安装包</span></span>
<span class="line">cd /tmp</span>
<span class="line">rpm -ivh libidn*.rpm</span>
<span class="line">rpm -ivh php*.rpm</span>
<span class="line">rpm -ivh OpenIPMI-modalias-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">rpm -ivh OpenIPMI-libs-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">rpm -ivh OpenIPMI-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">rpm -ivh OpenIPMI-devel-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看php和apache版本</span></span>
<span class="line">php --version</span>
<span class="line">-----------------------------------------------</span>
<span class="line">PHP <span class="number">5.4</span>.<span class="number">16</span> (cli) (built: Nov  <span class="number">6</span> <span class="number">2016</span> <span class="number">00</span>:<span class="number">29</span>:<span class="number">02</span>) </span>
<span class="line">Copyright (c) <span class="number">1997</span>-<span class="number">2013</span> The PHP Group</span>
<span class="line">Zend Engine v2.<span class="number">4.0</span>, Copyright (c) <span class="number">1998</span>-<span class="number">2013</span> Zend Technologies</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line">httpd -version</span>
<span class="line">-----------------------------------------------</span>
<span class="line">Server version: Apache/<span class="number">2.4</span>.<span class="number">6</span> (CentOS)</span>
<span class="line">Server built:   Nov <span class="number">14</span> <span class="number">2016</span> <span class="number">18</span>:<span class="number">04</span>:<span class="number">44</span></span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure>
<h4 id="源码编译安装zabbix"><a href="#源码编译安装zabbix" class="headerlink" title="源码编译安装zabbix"></a>源码编译安装zabbix</h4><p>从官岗下载zabbix源码包：<a href="http://www.zabbix.com/download" target="_blank" rel="external">http://www.zabbix.com/download </a><br>上传到服务器/tmp目录后解压<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /tmp/</span>
<span class="line">tar -zxvf zabbix-<span class="number">3.2</span>.<span class="number">4</span>.tar.gz</span>
</pre></td></tr></table></figure></p>
<p>编译安装，相关步骤参考<a href="https://www.zabbix.com/documentation/3.2/manual/installation/install" target="_blank" rel="external">官网安装手册</a><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span></span>
<span class="line">./configure --prefix=<span class="regexp">/u01/zabbix</span> --enable-server --enable-agent \</span>
<span class="line">--with-mysql=<span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysql</span>_config \</span>
<span class="line">--with-net-snmp --with-libcurl --with-libxml2</span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure></p>
<h4 id="创建所需数据库并授权用户"><a href="#创建所需数据库并授权用户" class="headerlink" title="创建所需数据库并授权用户"></a>创建所需数据库并授权用户</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">mysql</span>
<span class="line"></span>
<span class="line">create database zabbix default character set utf8;</span>
<span class="line">grant all privileges on *.* to <span class="string">'zabbix'</span>@'%' identified by <span class="string">'zabbix'</span>;</span>
<span class="line">grant all privileges on *.* to <span class="string">'zabbix'</span>@'localhost<span class="string">' identified by '</span>zabbix<span class="string">';</span>
<span class="line"></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">| zabbix             |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line">use zabbix</span>
<span class="line">select database();</span>
<span class="line">+------------+</span>
<span class="line">| database() |</span>
<span class="line">+------------+</span>
<span class="line">| zabbix     |</span>
<span class="line">+------------+</span></span>
</pre></td></tr></table></figure>
<h4 id="导入zabbix定义的表结构和数据"><a href="#导入zabbix定义的表结构和数据" class="headerlink" title="导入zabbix定义的表结构和数据"></a>导入zabbix定义的表结构和数据</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">source /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span>/database/mysql/schema.sql</span>
<span class="line">source /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span>/database/mysql/data.sql</span>
<span class="line">source /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span>/database/mysql/images.sql</span>
</pre></td></tr></table></figure>
<h4 id="修改相关配置文件"><a href="#修改相关配置文件" class="headerlink" title="修改相关配置文件"></a>修改相关配置文件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户下</span></span>
<span class="line"><span class="comment"># 修改zabbix server配置文件</span></span>
<span class="line">vi /u01/zabbix/etc/zabbix_server.conf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">ListenPort=<span class="number">10051</span></span>
<span class="line">DBHost=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">DBName=zabbix</span>
<span class="line">DBUser=zabbix</span>
<span class="line">DBPassword=zabbix</span>
<span class="line">DBPort=<span class="number">3306</span></span>
<span class="line">PidFile=<span class="regexp">/tmp/zabbix</span>_server.pid</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改php配置文件</span></span>
<span class="line">cp /etc/php.ini /etc/php.ini.zabbixbak</span>
<span class="line">sed -i <span class="string">'s/max_execution_time = 30/max_execution_time = 300/g'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/date.timezone =/a\date.timezone = Asia/Shanghai'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/max_input_time =/s/60/300/'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/mbstring.func_overload = 0/a\mbstring.func_overload = 1'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/post_max_size =/s/8M/32M/'</span> /etc/php.ini</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改apache配置文件</span></span>
<span class="line">sed -i <span class="string">'/ServerName/a\ServerName zabbix:80'</span> /etc/httpd/conf/httpd.conf</span>
</pre></td></tr></table></figure>
<h4 id="拷贝zabbix的web界面程序文件"><a href="#拷贝zabbix的web界面程序文件" class="headerlink" title="拷贝zabbix的web界面程序文件"></a>拷贝zabbix的web界面程序文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir /var/www/html/zabbix</span>
<span class="line">cp -rf /tmp/zabbix-3.2.4/frontends/php/* /var/www/html/zabbix</span>
<span class="line">chown -R apache.apache /var/www/html/zabbix</span>
</pre></td></tr></table></figure>
<h4 id="启动apache和zabbix-server"><a href="#启动apache和zabbix-server" class="headerlink" title="启动apache和zabbix server"></a>启动apache和zabbix server</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">systemctl enable httpd.service</span>
<span class="line">systemctl start httpd.service</span>
<span class="line">systemctl status httpd.service</span>
<span class="line">-----------------------------------------------</span>
<span class="line">● httpd.service - The Apache HTTP Server</span>
<span class="line">   Loaded: loaded (<span class="regexp">/usr/lib</span><span class="regexp">/systemd/system</span><span class="regexp">/httpd.service; enabled; vendor preset: disabled)</span>
<span class="line">   Active: active (running) since Thu 2017-03-16 15:12:59 CST; 15s ago</span>
<span class="line">     Docs: man:httpd(8)</span>
<span class="line">           man:apachectl(8)</span>
<span class="line">  Process: 762 ExecStop=/bin</span><span class="regexp">/kill -WINCH $&#123;MAINPID&#125; (code=exited, status=0/</span>SUCCESS)</span>
<span class="line"> Main PID: <span class="number">773</span> (httpd)</span>
<span class="line">   Status: <span class="string">"Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec"</span></span>
<span class="line">   CGroup: <span class="regexp">/system.slice/httpd</span>.service</span>
<span class="line">           ├─<span class="number">773</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">775</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">776</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">777</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">779</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           └─<span class="number">780</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line"></span>
<span class="line">Mar <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span>:<span class="number">59</span> zabbix systemd[<span class="number">1</span>]: Starting The Apache HTTP Server...</span>
<span class="line">Mar <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span>:<span class="number">59</span> zabbix systemd[<span class="number">1</span>]: Started The Apache HTTP Server.</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动zabbix server</span></span>
<span class="line">/u01/zabbix/sbin/zabbix_server -c /u01/zabbix/etc/zabbix_server.conf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加到系统启动</span></span>
<span class="line">cd /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span></span>
<span class="line">cp misc/init.d/fedora/core/zabbix_server /etc/init.d/zabbix_server</span>
<span class="line">cp misc/init.d/fedora/core/zabbix_agentd /etc/init.d/zabbix_agentd</span>
<span class="line"></span>
<span class="line">chkconfig --add zabbix_server</span>
<span class="line">chkconfig --add zabbix_agentd</span>
<span class="line">chkconfig zabbix_server on</span>
<span class="line">chkconfig zabbix_agentd on</span>
<span class="line"></span>
<span class="line">vi /etc/init.d/zabbix_server</span>
<span class="line">-----------------------------------------------</span>
<span class="line">BASEDIR=<span class="regexp">/u01/zabbix</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line">vi /etc/init.d/zabbix_agentd</span>
<span class="line">-----------------------------------------------</span>
<span class="line">BASEDIR=<span class="regexp">/u01/zabbix</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动zabbix_server</span></span>
<span class="line">systemctl start zabbix_server.service</span>
</pre></td></tr></table></figure>
<h4 id="通过web界面安装配置zabbix"><a href="#通过WEB界面安装配置zabbix" class="headerlink" title="通过WEB界面安装配置zabbix"></a>通过WEB界面安装配置zabbix</h4><p>在浏览器中输入：<a href="http://10.245.231.202/zabbix" target="_blank" rel="external">http://10.245.231.202/zabbix</a>，打开图形界面 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_01.png" alt=""><br>确保所有项都是OK状态 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_02.png" alt=""><br>配置数据库连接 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_03.png" alt=""><br>配置zabbix server信息 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_04.png" alt=""><br>确认信息 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_05.png" alt=""><br>下载配置文件，按要求保存到指定位置<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_06.png" alt=""><br>配置文件内容如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /var/www/html/zabbix/conf/zabbix.conf.php</span>
<span class="line">-----------------------------------------------</span>
<span class="line">&lt;?php</span>
<span class="line">// Zabbix GUI configuration file.</span>
<span class="line">global $DB;</span>
<span class="line"></span>
<span class="line">$DB[<span class="string">'TYPE'</span>]     = <span class="string">'MYSQL'</span>;</span>
<span class="line">$DB[<span class="string">'SERVER'</span>]   = <span class="string">'10.245.231.202'</span>;</span>
<span class="line">$DB[<span class="string">'PORT'</span>]     = <span class="string">'3306'</span>;</span>
<span class="line">$DB[<span class="string">'DATABASE'</span>] = <span class="string">'zabbix'</span>;</span>
<span class="line">$DB[<span class="string">'USER'</span>]     = <span class="string">'zabbix'</span>;</span>
<span class="line">$DB[<span class="string">'PASSWORD'</span>] = <span class="string">'zabbix'</span>;</span>
<span class="line"></span>
<span class="line"><span class="regexp">//</span> Schema name. Used <span class="keyword">for</span> IBM DB2 <span class="keyword">and</span> PostgreSQL.</span>
<span class="line">$DB[<span class="string">'SCHEMA'</span>] = <span class="string">''</span>;</span>
<span class="line"></span>
<span class="line">$ZBX_SERVER      = <span class="string">'10.245.231.202'</span>;</span>
<span class="line">$ZBX_SERVER_PORT = <span class="string">'10051'</span>;</span>
<span class="line">$ZBX_SERVER_NAME = <span class="string">'zabbix'</span>;</span>
<span class="line"></span>
<span class="line">$IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG;</span>
<span class="line"></span>
<span class="line">systemctl restart httpd</span>
<span class="line">The default user name is Admin, password zabbix.</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure></p>
<p>结束安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_07.png" alt=""><br>默认的用户名是<code>admin</code>，密码是<code>zabbix</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_08.png" alt=""><br>登陆后，可以将显示语言设置为中文(英文好的，不建议修改，而且zabbix汉化不是很完全和准确)<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_09.png" alt=""><br>选择中文，点update<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_10.png" alt=""></p>
<h3 id="配置启动zabbix-agent"><a href="#配置启动zabbix-agent" class="headerlink" title="配置启动zabbix agent"></a>配置启动zabbix agent</h3><p>修改配置文件并启动agent<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/zabbix/etc/zabbix_agentd.conf</span>
<span class="line"><span class="comment"># 修改以下内容</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">Server=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">ServerActive=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">Hostname=zabbix</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="comment"># 启动</span></span>
<span class="line">/u01/zabbix/sbin/zabbix_agentd</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">systemctl restart zabbix_agentd.service</span>
</pre></td></tr></table></figure></p>
<p>在zabbix web界面中配置主机中，点击【停用的】<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_11.png" alt=""><br>确定，启用主机<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_12.png" alt=""><br>这时状态已变为【启用】，但可用状态异常<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_16.png" alt=""><br>点击主机名<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_14.png" alt=""><br>将主机IP变更为实际的 -&gt; 更新<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_15.png" alt=""><br>重新刷新页面，稍等一会可用性状态正常了<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_17.png" alt=""></p>
<h2 id="监控mysql实例状态"><a href="#监控MySQL实例状态" class="headerlink" title="监控MySQL实例状态"></a>监控MySQL实例状态</h2><blockquote>
<p><strong>监控思路：</strong><br>在要监控的MySQL服务器上安装zabbix agent，然后在zabbix主机web界面里配置要监控的MySQL服务器的信息，添加zabbix自带的Template App MySQL模版。</p>
</blockquote>
<h3 id="在监控的mysql服务器上安装并启动zabbix-agent"><a href="#在监控的mysql服务器上安装并启动zabbix-agent" class="headerlink" title="在监控的mysql服务器上安装并启动zabbix agent"></a>在监控的mysql服务器上安装并启动zabbix agent</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统环境</span></span>
<span class="line">yum -<span class="keyword">y</span> install gcc* make vim</span>
<span class="line">setenforce <span class="number">0</span></span>
<span class="line">systemctl stop firewalld.service</span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加zabbix帐号</span></span>
<span class="line">groupadd zabbix</span>
<span class="line">useradd zabbix -g zabbix -<span class="keyword">s</span> /sbin/nologin</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置hosts(非必须)</span></span>
<span class="line">vi /etc/hosts</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="number">10.245</span>.<span class="number">231.201</span> mysql</span>
<span class="line"><span class="number">10.245</span>.<span class="number">231.202</span> zabbix</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 上传rpm包到/tmp目录后开始安装</span></span>
<span class="line">rpm -ivh zabbix-agent-<span class="number">3.2</span>.<span class="number">4</span>-<span class="number">1</span>.el6.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 也可以按以下步骤在解压后的源码目录编译安装</span></span>
<span class="line">./configure --enable-agent</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line">cp misc/init.d/fedora/core/zabbix_agentd /etc/init.d/zabbix_agentd</span>
<span class="line">chkconfig --add zabbix_agentd</span>
<span class="line">chkconfig zabbix_agentd on</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改agent配置文件(注意下面都是zabbix_agent rpm包安装后的目录，源码安装的话请注意修改)</span></span>
<span class="line">vi /etc/zabbix/zabbix_agentd.conf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">Server=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">ServerActive=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">Hostname=zabbix</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动agent</span></span>
<span class="line">/usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf</span>
</pre></td></tr></table></figure>
<h3 id="建立mysql-host-groups组"><a href="#建立mysql-host-groups组" class="headerlink" title="建立mysql host groups组"></a>建立mysql host groups组</h3><p>模板是zabbix系统提供的，进入zabbix web后台，Configuration–&gt;Hosts groups–&gt;点击Create host group–&gt;选择template选项卡，选择模板TemplateApp MySQL，Templdate OS Linux，Group name设置成Mysql_Servers，最后点击add<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_01.png" alt=""></p>
<h3 id="建立hosts"><a href="#建立hosts" class="headerlink" title="建立hosts"></a>建立hosts</h3><p>configuration–&gt;hosts–&gt;Create hosts，然后按图配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_02.png" alt=""><br>选择template选项卡–&gt;select–&gt;选择模板Template App MySQL,Templdate OS Linux，最后点击下边的Add按钮<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_03.png" alt=""><br>确认模板已添加，点Add按钮<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_04.png" alt=""><br>稍等一会，确保状态和可用性都正常<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_05.png" alt=""></p>
<h3 id="使用自带模板监控mysql"><a href="#使用自带模板监控mysql" class="headerlink" title="使用自带模板监控mysql"></a>使用自带模板监控mysql</h3><p>在监控的mysql服务器上给zabbix agent配置数据库账号<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">GRANT PROCESS,SUPER,REPLICATION CLIENT ON *.* TO zabbix@'<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' IDENTIFIED BY '</span>zabbix123456<span class="string">';</span>
<span class="line">GRANT PROCESS,SUPER,REPLICATION CLIENT ON *.* TO zabbix@'</span>localhost<span class="string">' IDENTIFIED BY '</span>zabbix123456<span class="string">';</span></span>
</pre></td></tr></table></figure></p>
<p>创建/etc/zabbix/.my.cnf,并在里面写入mysql服务器的密码<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/zabbix/.my.cnf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">[mysql]</span>
<span class="line">user=zabbix</span>
<span class="line">password=zabbix123456</span>
<span class="line"></span>
<span class="line">[mysqladmin]</span>
<span class="line">user=zabbix</span>
<span class="line">password=zabbix123456</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure></p>
<p>修改监控mysql相关的用户参数文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /etc/zabbix/zabbix_agentd.d/</span>
<span class="line">vi userparameter_mysql.conf</span>
<span class="line"><span class="comment"># 修改以下方面：</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">HOME=<span class="regexp">/var/lib</span><span class="regexp">/zabbix    替换成     HOME=/etc</span><span class="regexp">/zabbix</span>
<span class="line">mysql                   补全路径   /u</span>01/mysql/bin/mysql</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启zabbix agent</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> <span class="string">'zabbix_agentd'</span> | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs <span class="keyword">kill</span> -<span class="number">9</span></span>
<span class="line">/usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf</span>
</pre></td></tr></table></figure></p>
<p>然后在zabbix-server服务器上测试是否可以获取到mysql的status信息<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/zabbix/bin/</span>
<span class="line">./zabbix_get -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.201</span> -p1005<span class="number">0</span> -k mysql.ping</span>
<span class="line"><span class="number">1</span></span>
<span class="line"></span>
<span class="line">./zabbix_get -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.201</span> -p1005<span class="number">0</span> -k mysql.version</span>
<span class="line">/u01/mysql/bin/mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.6</span>.<span class="number">35</span>, <span class="keyword">for</span> Linux (x86_64) using  EditLine wrapper</span>
<span class="line"></span>
<span class="line">./zabbix_get -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.201</span> -p1005<span class="number">0</span> -k mysql.status[Com_insert]</span>
<span class="line"><span class="number">3</span></span>
</pre></td></tr></table></figure></p>
<p>zabbix自带的mysql模板共可监测以下14项<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_06.png" alt=""><br>按下图可以查看监控mysql的情况，也可以图形化显示<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_08.png" alt=""></p>
<h3 id="自定义zabbix模板监控mysql"><a href="#自定义zabbix模板监控mysql" class="headerlink" title="自定义zabbix模板监控mysql"></a>自定义zabbix模板监控mysql</h3><p>点击Configuration–&gt;Templates–&gt;create template，参照下图中配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_09.png" alt=""><br>点Applications–&gt;Create Applications<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_10.png" alt=""><br>输入监控的应用名称Mysql<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_11.png" alt=""><br>添加成功，点【Items】，然后点击左上的【Create Items】<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_12.png" alt=""><br>按下图所示填写后点下方add<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_13.png" alt=""><br>创建监控脚本文件并参数文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /etc/zabbix/scripts</span>
<span class="line">vi /etc/zabbix/scripts/check_mysql_status_3306.sh</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="comment">#!/bin/bash</span></span>
<span class="line">host=localhost</span>
<span class="line">username=zabbix</span>
<span class="line">password=zabbix</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">CHECK_TIME=<span class="number">3</span></span>
<span class="line"><span class="comment">#mysql  is working MYSQL_IS_OK is 1 , mysql down MYSQL_IS_OK is 0</span></span>
<span class="line">MYSQL_IS_OK=<span class="number">1</span></span>
<span class="line">function check_mysql_status ()&#123;</span>
<span class="line">    $MYSQL -u$username -p<span class="string">"$password"</span> -P$port -e <span class="string">"select user();"</span> &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span>
<span class="line">    <span class="keyword">if</span> [ $? = <span class="number">0</span> ] ;then</span>
<span class="line">    MYSQL_IS_OK=<span class="number">1</span></span>
<span class="line">    <span class="keyword">else</span></span>
<span class="line">    MYSQL_IS_OK=<span class="number">0</span></span>
<span class="line">    fi</span>
<span class="line">    <span class="keyword">return</span> $MYSQL_IS_OK </span>
<span class="line">&#125;</span>
<span class="line"><span class="keyword">while</span> [ $CHECK_TIME -<span class="keyword">ne</span> <span class="number">0</span> ]</span>
<span class="line"><span class="keyword">do</span></span>
<span class="line">    let <span class="string">"CHECK_TIME -= 1"</span></span>
<span class="line">    </span>
<span class="line">    check_mysql_status</span>
<span class="line"><span class="keyword">if</span> [ $MYSQL_IS_OK = <span class="number">1</span> ] ; then</span>
<span class="line">    CHECK_TIME=<span class="number">0</span></span>
<span class="line">    echo <span class="number">0</span></span>
<span class="line">    <span class="keyword">exit</span> <span class="number">0</span></span>
<span class="line">fi</span>
<span class="line"><span class="keyword">if</span> [ $MYSQL_IS_OK -eq <span class="number">0</span> ] &amp;&amp;  [ $CHECK_TIME -eq <span class="number">0</span> ]</span>
<span class="line">then</span>
<span class="line">    echo <span class="number">1</span></span>
<span class="line">    <span class="keyword">exit</span> <span class="number">1</span></span>
<span class="line">fi</span>
<span class="line"><span class="keyword">sleep</span> <span class="number">3</span></span>
<span class="line">done</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="keyword">chmod</span> +<span class="keyword">x</span> /etc/zabbix/scripts/check_mysql_status_3306.sh</span>
<span class="line">cd /etc/zabbix/zabbix_agentd.d/</span>
<span class="line">vi userparameter_mysql.conf</span>
<span class="line"><span class="comment"># 添加以下内容</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">UserParameter=my3306.check_mysql_status,<span class="regexp">/etc/zabbix</span><span class="regexp">/scripts/check</span>_mysql_status_3306.sh</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure></p>
<p>参考：<a href="http://www.iyunv.com/forum.php?mod=viewthread&amp;tid=351608&amp;highlight=zabbix" target="_blank" rel="external">Centos7.2下搭建Zabbix3.2</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-07 MySQL锁机制与事务机制实现]]></title>
      <url>/2017/03/10/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/07-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="mysql参数autocommit生产环境设1还是0为什么"><a href="#MySQL参数autocommit生产环境设1还是0？为什么？" class="headerlink" title="MySQL参数autocommit生产环境设1还是0？为什么？"></a>MySQL参数autocommit生产环境设1还是0？为什么？</h2><p>MySQL参数autocommit生产环境设成0，即不自动提交。 设置成不自动提交，事务能做rollback，以满足事务的原子性Atomicity的要求，设置方法：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set autocommit=<span class="number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 也可以修改my.cnf配置文件</span></span>
<span class="line">autocommit=<span class="number">0</span></span>
</pre></td></tr></table></figure></p>
<h2 id="mysql参数tx_isolation生产环境上大多数是设什么值为什么"><a href="#MySQL参数tx-isolation生产环境上大多数是设什么值，为什么？" class="headerlink" title="MySQL参数tx_isolation生产环境上大多数是设什么值，为什么？"></a>MySQL参数tx_isolation生产环境上大多数是设什么值，为什么？</h2><p>MySQL参数<code>tx_isolation</code>生产环境上大多数是设成<code>READ-COMMITED</code>。事务的隔离级别设置为<code>READ-COMMITED</code>时不会发生脏读现象，虽会出现不可重复读和幻读问题，但不会对业务应用造成影响。而设置成以下隔离级别会出现的问题如下：</p>
<ul>
<li>Read Uncommitted：会产生脏读、不可重复读、幻读现象，而脏读这在生产环境中是不被允许的</li>
<li>Repeatable Read：不会出现不可重复读和幻读问题，但此特性一般不符合应用业务需要，且并发性能也不好。</li>
<li>Serializable：所有事务全部串行执行（只允许同时一个事务操作，若有其他事务，也需要等前一个事务完成后才能开始），不能并发执行，这在生产环境中是不现实的。</li>
</ul>
<a id="more"></a>
<h2 id="与mysql锁相关的有哪些因素"><a href="#与MySQL锁相关的有哪些因素？" class="headerlink" title="与MySQL锁相关的有哪些因素？"></a>与MySQL锁相关的有哪些因素？</h2><ol>
<li>有无主键</li>
<li>有无索引，是不是唯一索引</li>
<li>事务的隔离级别是什么</li>
<li>SQL语句的执行计划</li>
</ol>
<h2 id="课堂笔记"><a href="#课堂笔记" class="headerlink" title="课堂笔记"></a>课堂笔记</h2><h3 id="事务的概念"><a href="#事务的概念" class="headerlink" title="事务的概念"></a>事务的概念</h3><p>事务定义了一个服务操作的序列，由服务器保证这些操作序列在多个客户并发访问和服务器出现故障情况下的原子性。<br>事务概念最初是在数据库管理系统领域发展起来的，是一种对共享数据库进行并发访问或错误处理的范型。<br>A transcation consists of a collection of DML statements that form a logical unit of work.<br>DDL statements will implicitly commit any outstanding transcation.</p>
<h3 id="事务的属性-acid"><a href="#事务的属性-ACID" class="headerlink" title="事务的属性 ACID"></a>事务的属性 ACID</h3><ul>
<li><code>Atomicity</code>: Changes made by a transaction to the database are atomic, “all or nothing”.  [Redo &amp; Undo]</li>
<li><code>Consistency</code>: The transaction changes the state of the base from one coherent state to a new coherent state (conforming to integrity constraints). [Undo]</li>
<li><code>Isolation</code>: The transaction is isolated from other transactions and appears to be the only user on the system even though it is executing with other concurrent transaction. [lock]</li>
<li><code>Durability</code>(Durable): The committed changes by a transaction are persistent, capable of surviving machine crashes. [Redo]</li>
</ul>
<h3 id="并发会存在问题"><a href="#并发会存在问题" class="headerlink" title="并发会存在问题"></a>并发会存在问题</h3><ul>
<li>dirty read 脏读</li>
<li>unrepeatable read 不可重复读</li>
<li>phantom read 幻读</li>
</ul>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><ul>
<li>Read Uncommitted：会出现脏读、不可重复读、幻读(隔离级别最低，并发性能高) </li>
<li>Read Committed：会出现不可重复读、幻读问题（锁定正在读取的行），Oracle的默认隔离级别</li>
<li>Repeatable Read：会出幻读（锁定所读取的所有行），Mysql的默认隔离级别，在Mysql Innodb上设置此隔离级别幻读也不会产生</li>
<li>Serializable：保证所有的情况不会发生（锁表）</li>
</ul>
<h3 id="事务编程不好习惯"><a href="#事务编程不好习惯" class="headerlink" title="事务编程不好习惯"></a>事务编程不好习惯</h3><ul>
<li>在循环中提交：提交<code>commit</code>应尽量放到循环外</li>
<li>使用自动提交：不使用自动提交，<code>set autocommit=0</code></li>
<li>使用自动回滚：MSSQL中关闭自动回滚 </li>
<li>大事务：尽量拆成小事务</li>
</ul>
<h3 id="锁的概念"><a href="#锁的概念" class="headerlink" title="锁的概念"></a>锁的概念</h3><h4 id="什么是锁"><a href="#什么是锁" class="headerlink" title="什么是锁"></a>什么是锁</h4><p>锁用于在多个事务访问同一个对象时根据这些操作访问同一对象的先后次序给事务排序。</p>
<h4 id="不同数据库的锁实现"><a href="#不同数据库的锁实现" class="headerlink" title="不同数据库的锁实现"></a>不同数据库的锁实现</h4><ul>
<li>InooDB 行级锁</li>
<li>Oracle 行级锁</li>
<li>MyISAM 表锁</li>
<li>Microsoft SQL Server 行级锁、锁升级</li>
</ul>
<h4 id="lock与latch的区别"><a href="#Lock与Latch的区别" class="headerlink" title="Lock与Latch的区别"></a>Lock与Latch的区别</h4><ul>
<li>对象：事务/线程</li>
<li>保护：数据库对象/内存结构对象</li>
<li>持续时间：长/短</li>
<li>模式：表锁行锁/互斥</li>
<li>死锁：有/无</li>
</ul>
<h4 id="innodb存储引擎中锁"><a href="#InnoDB存储引擎中锁" class="headerlink" title="InnoDB存储引擎中锁"></a>InnoDB存储引擎中锁</h4><ul>
<li>表级<ul>
<li>IS 意向共享锁</li>
<li>IX 意向排它锁</li>
</ul>
</li>
<li>行级<ul>
<li>S 行级共享锁</li>
<li>X 行级排它锁</li>
</ul>
</li>
</ul>
<p>update更新一行时，会在要更新的表上加IX锁，并在更新的行上加X锁，这时如果并发有用户drop table，看到表上有IX锁，就会立即报错</p>
<h4 id="innodb-row-lock行锁范围"><a href="#InnoDB-row-lock-行锁-范围" class="headerlink" title="InnoDB row lock(行锁)范围"></a>InnoDB row lock(行锁)范围</h4><ul>
<li>Record lock：行记录锁</li>
<li>Gap lock：间隙锁，在索引记录间隙上的锁，或者是第一条索引记录之前、最后一条索引记录之后上的间隙锁，只有隔离级别为Repeatable Read的普通索引才有Gap lock</li>
<li>Next-key lock：下一键锁，索引记录锁以及索引记录之间的间隙锁，前二者的组合锁</li>
</ul>
<h4 id="测试record-lock"><a href="#测试Record-Lock" class="headerlink" title="测试Record Lock"></a>测试Record Lock</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建测试表</span></span>
<span class="line">create table t2(id <span class="keyword">int</span>, name varchar(<span class="number">10</span>),primary key(id),key(name));</span>
<span class="line">insert into t2 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'A'</span>),(<span class="number">3</span>,<span class="string">'A'</span>),(<span class="number">5</span>,<span class="string">'C'</span>),(<span class="number">7</span>,<span class="string">'G'</span>),(<span class="number">10</span>,<span class="string">'I'</span>);</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> id,name from t2;</span>
<span class="line">+----+------+</span>
<span class="line">| id | name |</span>
<span class="line">+----+------+</span>
<span class="line">|  <span class="number">1</span> | A    |</span>
<span class="line">|  <span class="number">3</span> | A    |</span>
<span class="line">|  <span class="number">5</span> | C    |</span>
<span class="line">|  <span class="number">7</span> | G    |</span>
<span class="line">| <span class="number">10</span> | I    |</span>
<span class="line">+----+------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 测试一</span></span>
<span class="line"><span class="comment"># session 1:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where name=<span class="string">'C'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where id=<span class="number">5</span> lock in share mode;</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，查看锁信息</span></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">14789</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14789</span>       | S         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">| <span class="number">14788</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14788</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 测试二</span></span>
<span class="line"><span class="comment"># session 1:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where id=<span class="number">5</span> <span class="keyword">and</span> name=<span class="string">'C'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where id=<span class="number">5</span> <span class="keyword">and</span> name=<span class="string">'B'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，查看锁信息</span></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">14793</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14793</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">| <span class="number">14792</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14792</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
</pre></td></tr></table></figure>
<h4 id="测试gap-lock"><a href="#测试GAP-LOCK" class="headerlink" title="测试GAP LOCK"></a>测试GAP LOCK</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 测试一</span></span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line">set tx_isolation=<span class="string">'repeatable-read'</span>;</span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where name=<span class="string">'C'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">set tx_isolation=<span class="string">'repeatable-read'</span>;</span>
<span class="line">begin;</span>
<span class="line">insert into t2 <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">'C'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，查看锁信息以下几种方法：</span></span>
<span class="line">show engine innodb status\G;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">14814</span>:<span class="number">19</span>:<span class="number">4</span>:<span class="number">5</span> | <span class="number">14814</span>       | X,GAP     | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | name       |         <span class="number">19</span> |         <span class="number">4</span> |        <span class="number">5</span> | <span class="string">'G'</span>, <span class="number">7</span>    |</span>
<span class="line">| <span class="number">14813</span>:<span class="number">19</span>:<span class="number">4</span>:<span class="number">5</span> | <span class="number">14813</span>       | X,GAP     | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | name       |         <span class="number">19</span> |         <span class="number">4</span> |        <span class="number">5</span> | <span class="string">'G'</span>, <span class="number">7</span>    |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line"></span>
<span class="line">SELECT</span>
<span class="line">    r.trx_id waiting_trx_id,</span>
<span class="line">    r.trx_mysql_thread_id waiting_thread,</span>
<span class="line">    r.trx_query waiting_query,</span>
<span class="line">    b.trx_id blocking_trx_id,</span>
<span class="line">    b.trx_mysql_thread_id blocking_thread,</span>
<span class="line">    b.trx_query blocking_query</span>
<span class="line">FROM </span>
<span class="line">    information_schema.innodb_lock_waits w</span>
<span class="line">INNER JOIN information_schema.innodb_trx b on b.trx_id=w.blocking_trx_id </span>
<span class="line">INNER JOIN information_schema.innodb_trx r on r.trx_id=w.requesting_trx_id;</span>
<span class="line">+----------------+----------------+-------------------------------+-----------------+-----------------+----------------+</span>
<span class="line">| waiting_trx_id | waiting_thread | waiting_query                 | blocking_trx_id | blocking_thread | blocking_query |</span>
<span class="line">+----------------+----------------+-------------------------------+-----------------+-----------------+----------------+</span>
<span class="line">| <span class="number">14819</span>          |             <span class="number">30</span> | insert into t2 <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">'C'</span>) | <span class="number">14813</span>           |              <span class="number">32</span> | NULL           |</span>
<span class="line">+----------------+----------------+-------------------------------+-----------------+-----------------+----------------+</span>
<span class="line"></span>
<span class="line">SELECT    </span>
<span class="line">        p2.<span class="string">`HOST`</span> Blockedhost,</span>
<span class="line">p2.<span class="string">`USER`</span> BlockedUser,</span>
<span class="line">r.trx_id BlockedTrxId,    </span>
<span class="line">        r.trx_mysql_thread_id BlockedThreadId,    </span>
<span class="line">        TIMESTAMPDIFF(    </span>
<span class="line">            SECOND,    </span>
<span class="line">            r.trx_wait_started,    </span>
<span class="line">            CURRENT_TIMESTAMP    </span>
<span class="line">        ) WaitTime,    </span>
<span class="line">        r.trx_query BlockedQuery,    </span>
<span class="line">        l.lock_table BlockedTable,  </span>
<span class="line">        m.<span class="string">`lock_mode`</span> BlockedLockMode,</span>
<span class="line">        m.<span class="string">`lock_type`</span> BlockedLockType,</span>
<span class="line">        m.<span class="string">`lock_index`</span> BlockedLockIndex,</span>
<span class="line">        m.<span class="string">`lock_space`</span> BlockedLockSpace,</span>
<span class="line">        m.lock_page BlockedLockPage,</span>
<span class="line">        m.lock_rec BlockedLockRec,</span>
<span class="line">        m.lock_data BlockedLockData, </span>
<span class="line">        p.<span class="string">`HOST`</span> blocking_host, </span>
<span class="line">        p.<span class="string">`USER`</span> blocking_user,</span>
<span class="line">        b.trx_id BlockingTrxid,    </span>
<span class="line">        b.trx_mysql_thread_id BlockingThreadId,</span>
<span class="line">        b.trx_query BlockingQuery,</span>
<span class="line">        l.<span class="string">`lock_mode`</span> BlockingLockMode,</span>
<span class="line">        l.<span class="string">`lock_type`</span> BlockingLockType,</span>
<span class="line">        l.<span class="string">`lock_index`</span> BlockingLockIndex,</span>
<span class="line">        l.<span class="string">`lock_space`</span> BlockingLockSpace,</span>
<span class="line">        l.lock_page BlockingLockPage,</span>
<span class="line">        l.lock_rec BlockingLockRec,</span>
<span class="line">        l.lock_data BlockingLockData,         </span>
<span class="line">       IF (p.COMMAND = <span class="string">'Sleep'</span>, CONCAT(p.TIME,<span class="string">' seconds'</span>), <span class="number">0</span>) idel_in_trx             </span>
<span class="line">    FROM    </span>
<span class="line">        information_schema.INNODB_LOCK_WAITS w    </span>
<span class="line">    INNER JOIN information_schema.INNODB_TRX b ON b.trx_id = w.blocking_trx_id    </span>
<span class="line">    INNER JOIN information_schema.INNODB_TRX r ON r.trx_id = w.requesting_trx_id    </span>
<span class="line">    INNER JOIN information_schema.INNODB_LOCKS l ON w.blocking_lock_id = l.lock_id  AND l.<span class="string">`lock_trx_id`</span>=b.<span class="string">`trx_id`</span></span>
<span class="line">      INNER JOIN information_schema.INNODB_LOCKS <span class="keyword">m</span> ON m.<span class="string">`lock_id`</span>=w.<span class="string">`requested_lock_id`</span> AND m.<span class="string">`lock_trx_id`</span>=r.<span class="string">`trx_id`</span></span>
<span class="line">    INNER JOIN information_schema. PROCESSLIST p ON p.ID = b.trx_mysql_thread_id   </span>
<span class="line"> INNER JOIN information_schema. PROCESSLIST p2 ON p2.ID = r.trx_mysql_thread_id </span>
<span class="line">    ORDER BY    </span>
<span class="line">        WaitTime DESC \G;</span>
</pre></td></tr></table></figure>
<h4 id="分析一条sql会加哪些锁"><a href="#分析一条SQL会加哪些锁" class="headerlink" title="分析一条SQL会加哪些锁"></a>分析一条SQL会加哪些锁</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set tx_isolation=<span class="string">'repeatable-read'</span>;</span>
<span class="line"></span>
<span class="line">create table t4 (</span>
<span class="line">  id <span class="keyword">int</span>(<span class="number">11</span>) <span class="keyword">not</span> null default <span class="string">'0'</span>,</span>
<span class="line">  user_id <span class="keyword">int</span>(<span class="number">11</span>) default null,</span>
<span class="line">  user_name varchar(<span class="number">10</span>) default null,</span>
<span class="line">  create_time varchar(<span class="number">10</span>) default null,</span>
<span class="line">  address varchar(<span class="number">10</span>) default null,</span>
<span class="line">  primary key (id),</span>
<span class="line">  key idx_time_name (create_time,user_name)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line">insert into t4 <span class="keyword">values</span> </span>
<span class="line">    (<span class="number">1</span>,<span class="number">101</span>,<span class="string">'tom'</span>,<span class="string">'20161010'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">4</span>,<span class="number">104</span>,<span class="string">'joe'</span>,<span class="string">'20160305'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">6</span>,<span class="number">106</span>,<span class="string">'tom'</span>,<span class="string">'20161231'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">8</span>,<span class="number">108</span>,<span class="string">'tom'</span>,<span class="string">'20160515'</span>,<span class="string">'sh'</span>),</span>
<span class="line">    (<span class="number">10</span>,<span class="number">110</span>,<span class="string">'tom'</span>,<span class="string">'20160101'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">100</span>,<span class="number">200</span>,<span class="string">'jack'</span>,<span class="string">'20161120'</span>,<span class="string">''</span>);</span>
<span class="line"></span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from t4</span>
<span class="line">  where create_time&gt;<span class="string">'20160101'</span></span>
<span class="line">  <span class="keyword">and</span> create_time&lt;<span class="string">'20161120'</span></span>
<span class="line">  <span class="keyword">and</span> user_name=<span class="string">'tom'</span></span>
<span class="line">  <span class="keyword">and</span> address!=<span class="string">''</span> <span class="keyword">for</span> update;</span>
</pre></td></tr></table></figure>
<p>下图为执行上面SQL语句后会加哪些锁的图示<br><img src="http://oligvdnzp.bkt.clouddn.com/0310_sql_lock.png" alt="SQL会加哪些锁"></p>
<h3 id="mdl锁"><a href="#MDL锁" class="headerlink" title="MDL锁"></a>MDL锁</h3><p>Mysql5.5版本引入了MDL锁(metadata lock)，用于解决或者保证DDL操作与DML操作之间的一致性。<br>在mysqldump的时候不能做DDL操作，会提示<code>wailing for table metadata lock</code>；在做DDL操作没办法保护事务，因此引入了<code>meta data lock</code>。</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># session 1</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">drop table t1;</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，可以通过以下命令查看状态</span></span>
<span class="line">show processlist;</span>
<span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------+</span>
<span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info             |</span>
<span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------+</span>
<span class="line">| <span class="number">38</span> | root | localhost | lyj  | Sleep   |  <span class="number">155</span> |                                 | NULL             |</span>
<span class="line">| <span class="number">39</span> | root | localhost | lyj  | Query   |  <span class="number">115</span> | Waiting <span class="keyword">for</span> table metadata lock | drop table t1    | <span class="comment"># 这个就是meta data lock</span></span>
<span class="line">| <span class="number">40</span> | root | localhost | NULL | Query   |    <span class="number">0</span> | init                            | show processlist |</span>
<span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------+</span>
</pre></td></tr></table></figure>
<p>解决meta data lock的策略：</p>
<ul>
<li>解决DDL高并发</li>
<li>线上DB不要轻易做alter table</li>
<li>干掉DDL会话<code>show processlist;</code> <code>kill id;</code></li>
</ul>
<h3 id="死锁的原理与分析"><a href="#死锁的原理与分析" class="headerlink" title="死锁的原理与分析"></a>死锁的原理与分析</h3><ol>
<li>产生回路<br>两个或两个以上的事务执行过程中，分别持有一把锁，然后加另一把锁（AB-BA），产生死锁。</li>
<li>加锁顺序不一致<br>两个或两个以上的事务并发执行（同一时刻），因争夺锁资源而造成的一种互相等待，产生死锁。</li>
</ol>
<h4 id="场景产生回路导致死锁测试"><a href="#场景：产生回路导致死锁测试" class="headerlink" title="场景：产生回路导致死锁测试"></a>场景：产生回路导致死锁测试</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | aaaaa |</span>
<span class="line">|    <span class="number">2</span> | aaaaa |</span>
<span class="line">|    <span class="number">3</span> | cccc  |</span>
<span class="line">|    <span class="number">5</span> | eeeee |</span>
<span class="line">+------+-------+</span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line">begin;</span>
<span class="line">update t1 set name=<span class="string">'AAAAA'</span> where id=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">begin;</span>
<span class="line">update t1 set name=<span class="string">'BBBBB'</span> where id=<span class="number">2</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line">update t1 set name=<span class="string">'CCCCC'</span> where id=<span class="number">2</span>;   <span class="comment"># 这时操作会被阻塞</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">begin;</span>
<span class="line">update t1 set name=<span class="string">'DDDDD'</span> where id=<span class="number">1</span>;</span>
<span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying to get lock; try restarting transaction</span>
<span class="line"><span class="comment"># 这时session 2会报死锁错误，操作被rollback; 而session 1的事务阻塞解除，</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA |</span>
<span class="line">|    <span class="number">2</span> | CCCCC |</span>
<span class="line">|    <span class="number">3</span> | cccc  |</span>
<span class="line">|    <span class="number">5</span> | eeeee |</span>
<span class="line">+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | aaaaa |</span>
<span class="line">|    <span class="number">2</span> | aaaaa |</span>
<span class="line">|    <span class="number">3</span> | cccc  |</span>
<span class="line">|    <span class="number">5</span> | eeeee |</span>
<span class="line">+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 可以通过以下命令查看最后一次死锁解撤的信息：</span></span>
<span class="line">show engine innodb status\G;</span>
<span class="line">------------------------</span>
<span class="line">LATEST DETECTED DEADLOCK</span>
<span class="line">------------------------</span>
<span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">38</span> <span class="number">7</span>f150d11a70<span class="number">0</span></span>
<span class="line">*** (<span class="number">1</span>) TRANSACTION:</span>
<span class="line">TRANSACTION <span class="number">14866</span>, ACTIVE <span class="number">63</span> sec fetching rows</span>
<span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span>
<span class="line">LOCK WAIT <span class="number">3</span> lock struct(<span class="keyword">s</span>), heap size <span class="number">1184</span>, <span class="number">2</span> row lock(<span class="keyword">s</span>), undo <span class="keyword">log</span> entries <span class="number">1</span></span>
<span class="line">MySQL thread id <span class="number">38</span>, OS thread handle <span class="number">0x7f150d0d9700</span>, query id <span class="number">1579</span> localhost root updating</span>
<span class="line">update t1 set name=<span class="string">'CCCCC'</span> where id=<span class="number">2</span></span>
<span class="line">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span>
<span class="line">RECORD LOCKS space id <span class="number">18</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">80</span> <span class="keyword">index</span> <span class="string">`GEN_CLUST_INDEX`</span> of table <span class="string">`lyj`</span>.<span class="string">`t1`</span> trx id <span class="number">14866</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span>
<span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">8</span> PHYSICAL RECORD: n_fields <span class="number">5</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></span>
<span class="line"> <span class="number">0</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000000501013</span>; asc    P  ;;</span>
<span class="line"> <span class="number">1</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000000003</span>a13; asc     : ;;</span>
<span class="line"> <span class="number">2</span>: len <span class="number">7</span>; <span class="keyword">hex</span> <span class="number">3</span>c0000093b011<span class="number">0</span>; asc &lt;   ;  ;;</span>
<span class="line"> <span class="number">3</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</span>
<span class="line"> <span class="number">4</span>: len <span class="number">5</span>; <span class="keyword">hex</span> <span class="number">4242424242</span>; asc BBBBB;;</span>
<span class="line">......</span>
<span class="line"></span>
<span class="line"><span class="comment"># innodb_print_all_deadlocks设置为ON时，会把死锁的信息记录到错误日志里</span></span>
<span class="line">show variables like <span class="string">'%dead%'</span>;</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| Variable_name              | Value |</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| innodb_print_all_deadlocks | OFF   |</span>
<span class="line">+----------------------------+-------+</span>
<span class="line"></span>
<span class="line">set global innodb_print_all_deadlocks=<span class="string">'ON'</span>;</span>
</pre></td></tr></table></figure>
<h3 id="减少innodb死锁的方法"><a href="#减少Innodb死锁的方法" class="headerlink" title="减少Innodb死锁的方法"></a>减少Innodb死锁的方法</h3><ul>
<li>超时设置（参数<code>innodb_lock_wait_timout</code>)</li>
<li>尽快提交事务，小事务不容易发生死锁</li>
<li>加<code>FOR UPDATE</code>、<code>LOCK IN SHARE NODE</code>读锁时，最好<code>降低</code>事务隔离级别，例如用RC级别，降低死锁发生概率</li>
<li>事务中涉及多个表，或者涉及多行记录时，每个事务的操作顺序都要保持一致，降低死锁概率，最好用存储过程/存储函数固化</li>
<li>通过索引等方式优化SQL效率，降低死锁发生概率（减少扫描/锁范围，降低概率）</li>
</ul>
<h3 id="查找锁常用命令"><a href="#查找锁常用命令" class="headerlink" title="查找锁常用命令"></a>查找锁常用命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看innodb引擎</span></span>
<span class="line">show engine innodb status\G;</span>
<span class="line"></span>
<span class="line"><span class="comment">#查看锁</span></span>
<span class="line">SELECT</span>
<span class="line">    r.trx_id waiting_trx_id,</span>
<span class="line">    r.trx_mysql_thread_id waiting_thread,</span>
<span class="line">    r.trx_query waiting_query,</span>
<span class="line">    b.trx_id blocking_trx_id,</span>
<span class="line">    b.trx_mysql_thread_id blocking_thread,</span>
<span class="line">    b.trx_query blocking_query</span>
<span class="line">FROM information_schema.innodb_lock_waits w</span>
<span class="line">INNER JOIN information_schema.innodb_trx b</span>
<span class="line">ON b.trx_id= w.blocking_trx_id</span>
<span class="line">INNER JOIN information_schema.innodb_trx r</span>
<span class="line">ON r.trx_id= w.requesting_trx_id;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_trx\G;</span>
<span class="line"><span class="comment"># 表中几个最常用的字段：</span></span>
<span class="line">trx_id: InnoDB存储引擎内部唯一的事务ID</span>
<span class="line">trx_state: 当前事务的状态</span>
<span class="line">trx_started: 事务的开始时间</span>
<span class="line">trx_wait_started: 事务等待开始的时间</span>
<span class="line">trx_mysql_thread_id: Mysql中的线程ID,SHOW PROCESSLIST显示的结果</span>
<span class="line">trx_query: 事务运行的sql语句</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks\G;</span>
<span class="line"><span class="comment"># 表中几个最常用的字段：</span></span>
<span class="line">lock_id: 锁的ID</span>
<span class="line">lock_trx_id: 事务ID</span>
<span class="line">lock_mode: 锁的模式</span>
<span class="line">lock_type: 锁的类型，表锁还是行锁</span>
<span class="line">lock_table: 要加锁的表</span>
<span class="line">lock_index: 锁的索引</span>
<span class="line">lock_space: InnoDB存储引擎表空间的ID号</span>
<span class="line">lock_page: 被锁住的页的数量。若是表锁，则该值为NULL</span>
<span class="line">lock_rec: 被锁住的行的数量。若是表锁，则该值为NULL</span>
<span class="line">lock_data: 被锁住的行的主键值。当是表锁时，该值为NULL</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_lock_waits\G;</span>
<span class="line"><span class="comment"># 表中几个最常用的字段：</span></span>
<span class="line">requesting_trx_id: 申请锁资源的事务ID</span>
<span class="line">requesting_lock_id: 申请的锁的ID</span>
<span class="line">blocking_trx_id: 阻塞的锁的ID</span>
</pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-06 深入浅出MySQL备份与恢复]]></title>
      <url>/2017/02/27/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/06-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="使用mydumper工具全库备份"><a href="#使用mydumper工具全库备份" class="headerlink" title="使用mydumper工具全库备份"></a>使用mydumper工具全库备份</h2><blockquote>
<p>mydumper是针对mysql数据库备份的一个轻量级第三方的开源工具，备份方式采用逻辑备份。<br>mydumper支持多线程，备份速度远高于原生态的mysqldump。</p>
</blockquote>
<h3 id="下载mydumper"><a href="#下载mydumper" class="headerlink" title="下载mydumper"></a>下载mydumper</h3><p>下载地址：<a href="https://launchpad.net/mydumper" target="_blank" rel="external">https://launchpad.net/mydumper </a><br><a id="more"></a></p>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装编译所需的依赖包(参照：https://answers.launchpad.net/mydumper/+faq/349)</span></span>
<span class="line">yum install -<span class="keyword">y</span> glib2-devel mysql-devel zlib-devel pcre-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># 将下载的mydumper-0.9.1.tar.gz上传到服务器/tmp目录下，root用户执行以下命令</span></span>
<span class="line">cd /tmp</span>
<span class="line">tar -xvpf mydumper-<span class="number">0</span>.<span class="number">9.1</span>.tar.gz</span>
<span class="line">cd mydumper-<span class="number">0</span>.<span class="number">9.1</span></span>
<span class="line">cmake .</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
<span class="line">Scanning dependencies of target mydumper</span>
<span class="line">[ <span class="number">25</span>%] Building C object CMakeFiles/mydumper.dir/mydumper.c.o</span>
<span class="line">[ <span class="number">50</span>%] Building C object CMakeFiles/mydumper.dir/server_detect.c.o</span>
<span class="line">[ <span class="number">75</span>%] Building C object CMakeFiles/mydumper.dir/g_unix_signal.c.o</span>
<span class="line">Linking C executable mydumper</span>
<span class="line">[ <span class="number">75</span>%] Built target mydumper</span>
<span class="line">Scanning dependencies of target myloader</span>
<span class="line">[<span class="number">100</span>%] Building C object CMakeFiles/myloader.dir/myloader.c.o</span>
<span class="line">Linking C executable myloader</span>
<span class="line">[<span class="number">100</span>%] Built target myloader</span>
<span class="line">[ <span class="number">75</span>%] Built target mydumper</span>
<span class="line">[<span class="number">100</span>%] Built target myloader</span>
<span class="line">Install the project...</span>
<span class="line">-- Install configuration: <span class="string">""</span></span>
<span class="line">-- Installing: <span class="regexp">/usr/local</span><span class="regexp">/bin/mydumper</span></span>
<span class="line">-- Removed runtime path from <span class="string">"/usr/local/bin/mydumper"</span></span>
<span class="line">-- Installing: <span class="regexp">/usr/local</span><span class="regexp">/bin/myloader</span></span>
<span class="line">-- Removed runtime path from <span class="string">"/usr/local/bin/myloader"</span></span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="使用mydumper备份全库"><a href="#使用mydumper备份全库" class="headerlink" title="使用mydumper备份全库"></a>使用mydumper备份全库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/backup</span>
<span class="line"></span>
<span class="line">mydumper \</span>
<span class="line">    --user=root \</span>
<span class="line">    --password=<span class="string">''</span> \</span>
<span class="line">    --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock \</span>
<span class="line">    --regex <span class="string">'^(?!(mysql))'</span> \</span>
<span class="line">    --outputdir=<span class="regexp">/u01/backup</span><span class="regexp">/ \</span>
<span class="line">    --compress \</span>
<span class="line">    --verbose=3 \</span>
<span class="line">    --logfile=/u</span>01/backup/mydumper.log</span>
<span class="line"><span class="comment"># --regex '^(?!(mysql))' 这个正则表达式的意思是除了mysql数据库，其他数据库都备份</span></span>
</pre></td></tr></table></figure>
<p>查看备份结果<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/backup/</span>
<span class="line">ll</span>
<span class="line">total <span class="number">20</span></span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql  <span class="number">84</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> jfedu-schema-create.sql.gz</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">174</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> jfedu.t1-schema.sql.gz</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">153</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> jfedu.t1.sql.gz</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">134</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> metadata</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">969</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> mydumper.log</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备份日志，可以看出备份开启了多线程</span></span>
<span class="line">vi mydumper.log </span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Connected to a MySQL server</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Started <span class="keyword">dump</span> at: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span></span>
<span class="line"></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Written master status</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">1</span> connected using MySQL connection ID <span class="number">20</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">2</span> connected using MySQL connection ID <span class="number">21</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">3</span> connected using MySQL connection ID <span class="number">22</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">4</span> connected using MySQL connection ID <span class="number">23</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Non-InnoDB <span class="keyword">dump</span> complete, unlocking tables</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">1</span> dumping data <span class="keyword">for</span> <span class="string">`jfedu`</span>.<span class="string">`t1`</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">2</span> dumping schema <span class="keyword">for</span> <span class="string">`jfedu`</span>.<span class="string">`t1`</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">3</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">4</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">1</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">2</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Finished <span class="keyword">dump</span> at: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span></span>
</pre></td></tr></table></figure></p>
<h2 id="误操作truncate-table-gyj_t1利用mysqldump的备份和binlog日志对表gyj_t1做完全恢复"><a href="#误操作truncate-table-gyj-t1-利用mysqldump的备份和binlog日志对表gyj-t1做完全恢复。" class="headerlink" title="误操作truncate table gyj_t1;利用mysqldump的备份和binlog日志对表gyj_t1做完全恢复。"></a>误操作truncate table gyj_t1;利用mysqldump的备份和binlog日志对表gyj_t1做完全恢复。</h2><h3 id="测试场景构建"><a href="#测试场景构建" class="headerlink" title="测试场景构建"></a>测试场景构建</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> jfedu;</span>
<span class="line">create table gyj_t1(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into gyj_t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="使用mysqldump全库备份"><a href="#使用mysqldump全库备份" class="headerlink" title="使用mysqldump全库备份"></a>使用mysqldump全库备份</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> --single-transaction --master-data=<span class="number">2</span> -P3306 -A &gt; <span class="regexp">/tmp/all</span>_database_20170302.sql</span>
</pre></td></tr></table></figure>
<h3 id="备份后dml操作再truncate"><a href="#备份后DML操作再truncate" class="headerlink" title="备份后DML操作再truncate"></a>备份后DML操作再truncate</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into gyj_t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'BBBBBB'</span>);</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">truncate</span> table gyj_t1;</span>
</pre></td></tr></table></figure>
<h3 id="完全恢复表并验证数据"><a href="#完全恢复表并验证数据" class="headerlink" title="完全恢复表并验证数据"></a>完全恢复表并验证数据</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从备份文件中找出需要恢复表的建表语句：</span></span>
<span class="line">cat /tmp/all_database_20170302.sql | sed -e <span class="string">'/./&#123;H;$!d;&#125;'</span> -e <span class="string">'x;/CREATE TABLE `gyj_t1`/!d;q'</span> </span>
<span class="line"></span>
<span class="line"><span class="comment"># 从备份文件中找出需要恢复表的数据</span></span>
<span class="line">cat /tmp/all_database_20170302.sql | <span class="keyword">grep</span> --ignore-case  <span class="string">'insert into `gyj_t1`'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复之前需要确认是否设置自动提交，若不是恢复前先执行以下命令修改</span></span>
<span class="line">set autocommit=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 因为是truncate表，表结构不需要恢复，只需要恢复数据即可</span></span>
<span class="line">cat /tmp/all_database_20170302.sql | <span class="keyword">grep</span> --ignore-case  <span class="string">'insert into `gyj_t1`'</span> | mysql -uroot -p jfedu</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看恢复的数据</span></span>
<span class="line"><span class="keyword">select</span> * from gyj_t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA |</span>
<span class="line">+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备份时binlog位置</span></span>
<span class="line"><span class="keyword">grep</span> MASTER /tmp/all_database_20170302.sql</span>
<span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'binlog.000030'</span>, MASTER_LOG_POS=<span class="number">1957</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 找出误操作语句的位置</span></span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock -e <span class="string">"show binlog events in 'binlog.000030'"</span> |<span class="keyword">grep</span> -i <span class="keyword">truncate</span></span>
<span class="line">binlog.<span class="number">000030</span>   <span class="number">2161</span>    Query   <span class="number">101</span>     <span class="number">2250</span>    <span class="keyword">use</span> <span class="string">`jfedu`</span>; <span class="keyword">truncate</span> table gyj_t1</span>
<span class="line"></span>
<span class="line"><span class="comment"># 用mysqlbinlog命令在binlog中找出相关记录</span></span>
<span class="line">mysqlbinlog -v --base64-output=decode-rows /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000030</span> &gt; <span class="regexp">/tmp/</span><span class="number">30</span>.sql</span>
<span class="line">vi /tmp/<span class="number">30</span>.sql</span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
<span class="line">......</span>
<span class="line"><span class="comment">#170302 13:46:20 server id 101  end_log_pos 1957 CRC32 0xfb6ea7a5       Xid = 512</span></span>
<span class="line">COMMIT/*!*<span class="regexp">/;</span>
<span class="line"># at 1957</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2030 CRC32 0x27b2b661       Query   thread_id=4     exec_time=0     error_code=0</span>
<span class="line">SET TIMESTAMP=1488433793/</span>*!*<span class="regexp">/;</span>
<span class="line">SET @@session.sql_mode=1073741824/</span>*!*<span class="regexp">/;</span>
<span class="line">BEGIN</span>
<span class="line">/</span>*!*<span class="regexp">/;</span>
<span class="line"># at 2030</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2083 CRC32 0x5e3da140       Table_map: `jfedu`.`gyj_t1` mapped to number 109</span>
<span class="line"># at 2083</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2130 CRC32 0xbb45eb36       Write_rows: table id 109 flags: STMT_END_F</span>
<span class="line">### INSERT INTO `jfedu`.`gyj_t1`</span>
<span class="line">### SET</span>
<span class="line">###   @1=2</span>
<span class="line">###   @2='BBBBBB'</span>
<span class="line"># at 2130</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2161 CRC32 0x54d510bc       Xid = 950</span>
<span class="line">COMMIT/</span>*!*<span class="regexp">/;    # 这个就是truancate前最后操作的位置</span>
<span class="line"># at 2161</span>
<span class="line">#170302 13:50:23 server id 101  end_log_pos 2250 CRC32 0xc37cd27b       Query   thread_id=4     exec_time=0     error_code=0</span>
<span class="line">SET TIMESTAMP=1488433823/</span>*!*<span class="regexp">/;</span>
<span class="line">truncate table gyj_t1</span>
<span class="line">/</span>*!*<span class="regexp">/;</span>
<span class="line"># at 2250</span>
<span class="line">......</span>
<span class="line"># ------------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 使用mysqlbinlog恢复从备份到</span>
<span class="line">mysqlbinlog --start-position=1957 --stop-position=2161 /u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000030</span> | mysql -uroot -p</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from gyj_t1;</span>
<span class="line">+------+--------+</span>
<span class="line">| id   | name   |</span>
<span class="line">+------+--------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA  |</span>
<span class="line">|    <span class="number">2</span> | BBBBBB |</span>
<span class="line">+------+--------+</span>
</pre></td></tr></table></figure>
<h2 id="利用innobackupex的备份和binlog日志对mysql数据库做完全恢复"><a href="#利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复" class="headerlink" title="利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复"></a>利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复</h2><blockquote>
<p><code>Xtrabackup</code>是一个对InnoDB做数据备份的工具，支持在线热备份（备份时不影响数据读写），是商业备份工具InnoDB Hotbackup的一个很好的替代品。Xtrabackup有两个主要的工具：<code>xtrabackup</code>、<code>innobackupex</code>。<br>（1）xtrabackup只能备份InnoDB和XtraDB两种数据表，而不能备份MyISAM数据表<br>（2）innobackupex是用perl脚本封装了xtrabackup，能同时备份处理innodb和myisam，但在处理myisam时需要加一个读锁<br>（3）相关帮助文档：<a href="https://www.percona.com/docs/wiki/index.html" target="_blank" rel="external">https://www.percona.com/docs/wiki/index.html </a></p>
</blockquote>
<h3 id="下载安装xtrabackup二进制"><a href="#下载安装Xtrabackup（二进制）" class="headerlink" title="下载安装Xtrabackup（二进制）"></a>下载安装Xtrabackup（二进制）</h3><p><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="external">https://www.percona.com/downloads/XtraBackup/LATEST/ </a><br><img src="http://oligvdnzp.bkt.clouddn.com/0301_xtrabackup_01.png" alt="下载Xtrabackup"></p>
<p>上传并解压缩安装软件包<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /tmp</span>
<span class="line">tar -xvpf percona-xtrabackup-<span class="number">2.4</span>.<span class="number">6</span>-Linux-x86_64.tar.gz</span>
<span class="line">cd /tmp/percona-xtrabackup-<span class="number">2.4</span>.<span class="number">6</span>-Linux-x86_64/bin</span>
<span class="line">cp * <span class="regexp">/usr/local</span><span class="regexp">/bin/</span></span>
<span class="line">cd /tmp/percona-xtrabackup-<span class="number">2.4</span>.<span class="number">6</span>-Linux-x86_64/man/man1</span>
<span class="line">cp * <span class="regexp">/usr/share</span><span class="regexp">/man/man</span>1</span>
<span class="line"></span>
<span class="line"><span class="comment"># 可以使用以下命令查看帮助</span></span>
<span class="line">xtrabackup --help</span>
<span class="line">innobackupex --help</span>
<span class="line">man xtrabackup</span>
<span class="line">man innobackupex</span>
</pre></td></tr></table></figure></p>
<h3 id="测试场景构建"><a href="#测试场景构建-1" class="headerlink" title="测试场景构建"></a>测试场景构建</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create database lyj;</span>
<span class="line"><span class="keyword">use</span> lyj</span>
<span class="line">create table t1(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">insert into t1 <span class="keyword">select</span> * from t1;</span>
<span class="line">......</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> count(*) from t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">64</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h3 id="使用innobackupex备份全库"><a href="#使用Innobackupex备份全库" class="headerlink" title="使用Innobackupex备份全库"></a>使用Innobackupex备份全库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/backup</span>
<span class="line"></span>
<span class="line">innobackupex \</span>
<span class="line">  --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf \</span>
<span class="line">  --user=root \</span>
<span class="line">  --password='' \</span>
<span class="line">  --socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock \</span>
<span class="line">  --<span class="keyword">no</span>-timestamp \</span>
<span class="line">  /u01/backup/xtrabackup_20170302</span>
</pre></td></tr></table></figure>
<h3 id="应用备份期间日志"><a href="#应用备份期间日志" class="headerlink" title="应用备份期间日志"></a>应用备份期间日志</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">innobackupex \</span>
<span class="line">  --defaults-file=<span class="regexp">/u01/backup</span><span class="regexp">/xtrabackup_20170302/backup</span>-my.cnf \</span>
<span class="line">  --apply-<span class="keyword">log</span> \</span>
<span class="line">  --user=root \</span>
<span class="line">  --password=<span class="string">''</span> \</span>
<span class="line">  /u01/backup/xtrabackup_20170302</span>
<span class="line"><span class="comment"># --defaults-file 配置文件参数必须放在第一位，否则会报错</span></span>
<span class="line"><span class="comment"># --apply-log 应用备份期间日志</span></span>
</pre></td></tr></table></figure>
<h3 id="查看innobackupex备份结果"><a href="#查看innobackupex备份结果" class="headerlink" title="查看innobackupex备份结果"></a>查看innobackupex备份结果</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/backup/xtrabackup_20170302</span>
<span class="line">ll</span>
<span class="line">total <span class="number">4165684</span></span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql        <span class="number">434</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> backup-my.cnf</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql   <span class="number">33554432</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ibdata1</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql   <span class="number">16777216</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> ibdata2</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ib_logfile<span class="number">0</span></span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> ib_logfile1</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ib_logfile2</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ib_logfile3</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql   <span class="number">12582912</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ibtmp1</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> jfedu</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> lyj</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> mysql</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> performance_schema</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql         <span class="number">20</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> xtrabackup_binlog_info</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql         <span class="number">20</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> xtrabackup_binlog_pos_innodb</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql        <span class="number">113</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> xtrabackup_checkpoints        <span class="comment"># 检查点</span></span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql        <span class="number">572</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> xtrabackup_info</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql    <span class="number">8388608</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> xtrabackup_logfile            <span class="comment"># log日志</span></span>
</pre></td></tr></table></figure>
<h3 id="备份后dml操作"><a href="#备份后DML操作" class="headerlink" title="备份后DML操作"></a>备份后DML操作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into t1 <span class="keyword">select</span> * from t1;</span>
<span class="line">......</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> count(*) from t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|     <span class="number">4096</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h3 id="摸拟rm误操作"><a href="#摸拟rm误操作" class="headerlink" title="摸拟rm误操作"></a>摸拟rm误操作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rm -rf /u01/data/<span class="number">3306</span>/*</span>
<span class="line"><span class="comment"># 这时关闭数据库已不能正常启动了</span></span>
</pre></td></tr></table></figure>
<h3 id="拷备份数据到数据库目录"><a href="#拷备份数据到数据库目录" class="headerlink" title="拷备份数据到数据库目录"></a>拷备份数据到数据库目录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cp -rf /u01/backup/xtrabackup_20170302/* <span class="regexp">/u01/data</span><span class="regexp">/3306/</span></span>
<span class="line"><span class="comment"># 注意文件权限，如果不是mysql，使用以下语句修改，xtrabackup_* 可以不拷贝</span></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01/data/<span class="number">3306</span>/</span>
</pre></td></tr></table></figure>
<h3 id="登陆数据库验证备份恢复"><a href="#登陆数据库验证备份恢复" class="headerlink" title="登陆数据库验证备份恢复"></a>登陆数据库验证备份恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动数据库</span></span>
<span class="line"><span class="keyword">use</span> lyj</span>
<span class="line"><span class="keyword">select</span> count(*) from t1; </span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">64</span> |</span>
<span class="line">+----------+</span>
<span class="line"><span class="comment"># 恢复了备份时（包括备份期间）的64条记录</span></span>
</pre></td></tr></table></figure>
<h3 id="使用mysqlbinlog完全恢复"><a href="#使用mysqlbinlog完全恢复" class="headerlink" title="使用mysqlbinlog完全恢复"></a>使用mysqlbinlog完全恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /u01/backup/xtrabackup_20170302/xtrabackup_binlog_info</span>
<span class="line">binlog.<span class="number">000027</span>   <span class="number">28905477</span></span>
<span class="line"></span>
<span class="line">mysqlbinlog --start-position=<span class="number">28905477</span> /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000027</span> | mysql -uroot -p</span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆数据库</span></span>
<span class="line"><span class="keyword">select</span> count(*) from t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|     <span class="number">4096</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h2 id="随堂笔记"><a href="#随堂笔记" class="headerlink" title="随堂笔记"></a>随堂笔记</h2><h3 id="mysqldump常用参数及使用示例"><a href="#mysqldump常用参数及使用示例" class="headerlink" title="mysqldump常用参数及使用示例"></a>mysqldump常用参数及使用示例</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看帮助</span></span>
<span class="line">mysqldump --help</span>
<span class="line"></span>
<span class="line"><span class="comment"># 一些常用参数</span></span>
<span class="line">--single-transaction  <span class="comment"># 备份执行期间不阻塞DML，在生产环境备份时一定要加此参数</span></span>
<span class="line">-A, --all-databases Dump all the databases. This will be same as --databases <span class="comment"># 备份所有的数据库</span></span>
<span class="line">--master-data[=<span class="comment">#]   # --master-data=2 或 --master-data=1，一般做主从的时侯需要加此参数</span></span>
<span class="line">--add-drop-database Add a DROP DATABASE before <span class="keyword">each</span> create. <span class="comment"># 备份中不生成创建数据库命令</span></span>
<span class="line">--add-drop-table    Add a DROP TABLE before <span class="keyword">each</span> create.    <span class="comment"># 备份中不生成创建表命令</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 示例</span></span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> --single-transaction -P3306 -A &gt; <span class="regexp">/tmp/all</span>_database.sql</span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P3306 -uroot -p --single-transaction --master-data=<span class="number">2</span> jfedu &gt; <span class="regexp">/tmp/jfedu</span>.sql</span>
<span class="line"></span>
<span class="line">--single-transaction</span>
<span class="line"><span class="comment"># 创建一致性快照（only innodb）</span></span>
<span class="line"><span class="comment"># 不能存在其他操作：ALTER TABLE, DROP TABLE, RENAME TABLE,TRUNCATE TABLE</span></span>
<span class="line"><span class="comment"># 关闭--lock-tables</span></span>
<span class="line"></span>
<span class="line">--master-data</span>
<span class="line"><span class="number">1</span> ： 输出change master命令</span>
<span class="line"><span class="number">2</span> ： 注释输出change master命令</span>
<span class="line"></span>
<span class="line">--default-character-set</span>
<span class="line">binary</span>
<span class="line"></span>
<span class="line">mysqldump -u[USER] -p[PASSWORD] -h [HOST] -P[PORT] --single-transaction --master-data=<span class="number">2</span> [DB]| pv -<span class="keyword">q</span> -L <span class="number">10</span>M | gzip &gt; <span class="regexp">/tmp/test</span>.gzip</span>
<span class="line">备份 ：mysqldump</span>
<span class="line">限流 ：pv </span>
<span class="line">压缩 ：gzip</span>
<span class="line"></span>
<span class="line">gunzip -fc /tmp/test.gz | mysql -u[USER]-h[HOST] -P[PORT] DB </span>
<span class="line">解压 ： gunzip</span>
<span class="line">恢复 ：mysql</span>
<span class="line">主备： change master</span>
</pre></td></tr></table></figure>
<h3 id="分析mysqldump的执行流程"><a href="#分析mysqldump的执行流程" class="headerlink" title="分析mysqldump的执行流程"></a>分析mysqldump的执行流程</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开general.log（通常是关闭的）</span></span>
<span class="line">show variables like <span class="string">'%gen%'</span>;</span>
<span class="line">+------------------+--------------------------+</span>
<span class="line">| Variable_name    | Value                    |</span>
<span class="line">+------------------+--------------------------+</span>
<span class="line">| general_log      | OFF                      |</span>
<span class="line">| general_log_file | <span class="regexp">/u01/data</span><span class="regexp">/3306/mysql</span>.log |</span>
<span class="line">+------------------+--------------------------+</span>
<span class="line"></span>
<span class="line">set global general_log=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在新窗口追踪日志</span></span>
<span class="line">tail -f /u01/data/<span class="number">3306</span>/mysql.log</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用mysqldump备份jfedu数据库</span></span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P3306 -uroot -p --single-transaction --master-data=<span class="number">2</span> jfedu &gt; <span class="regexp">/tmp/jfedu</span>.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 分析general.log，下面这段就是追踪到的mysqldump执行流程</span></span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">170228</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">29</span>     <span class="number">9</span> Connect   root@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> on </span>
<span class="line">                    <span class="number">9</span> Query     /*!<span class="number">40100</span> SET @@SQL_MODE=<span class="string">''</span> *<span class="regexp">/</span>
<span class="line">                    9 Query     /</span>*!<span class="number">40103</span> SET TIME_ZONE=<span class="string">'+00:00'</span> *<span class="regexp">/</span>
<span class="line">                    9 Query     FLUSH /</span>*!<span class="number">40101</span> LOCAL *<span class="regexp">/ TABLES</span>
<span class="line">                    9 Query     FLUSH TABLES WITH READ LOCK      # 数据库只读锁定命令</span>
<span class="line">                    9 Query     SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ</span>
<span class="line">                    9 Query     START TRANSACTION /</span>*!<span class="number">40100</span> WITH CONSISTENT SNAPSHOT *<span class="regexp">/</span>
<span class="line">                    9 Query     SHOW VARIABLES LIKE 'gtid\_mode'</span>
<span class="line">                    9 Query     SHOW MASTER STATUS</span>
<span class="line">                    9 Query     UNLOCK TABLES</span>
<span class="line">                    9 Query     SELECT LOGFILE_GROUP_NAME, FILE_NAME, TOTAL_EXTENTS, INITIAL_SIZE, ENGINE, EXTRA FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE = 'UNDO LOG' AND FILE_NAME IS NOT NULL AND LOGFILE_GROUP_NAME IN (SELECT DISTINCT LOGFILE_GROUP_NAME FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE = 'DATAFILE' AND TABLESPACE_NAME IN (SELECT DISTINCT TABLESPACE_NAME FROM INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA IN ('jfedu'))) GROUP BY LOGFILE_GROUP_NAME, FILE_NAME, ENGINE ORDER BY LOGFILE_GROUP_NAME</span>
<span class="line">                    9 Query     SELECT DISTINCT TABLESPACE_NAME, FILE_NAME, LOGFILE_GROUP_NAME, EXTENT_SIZE, INITIAL_SIZE, ENGINE FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE = 'DATAFILE' AND TABLESPACE_NAME IN (SELECT DISTINCT TABLESPACE_NAME FROM INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA IN ('jfedu')) ORDER BY TABLESPACE_NAME, LOGFILE_GROUP_NAME</span>
<span class="line">                    9 Query     SHOW VARIABLES LIKE 'ndbinfo\_version'</span>
<span class="line">                    9 Init DB   jfedu</span>
<span class="line">                    9 Query     SAVEPOINT sp</span>
<span class="line">                    9 Query     show tables</span>
<span class="line">                    9 Query     show table status like 't1'</span>
<span class="line">                    9 Query     SET SQL_QUOTE_SHOW_CREATE=1</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'binary'</span>
<span class="line">                    9 Query     show create table `t1`</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'utf8'</span>
<span class="line">                    9 Query     show fields from `t1`</span>
<span class="line">                    9 Query     SELECT /</span>*!<span class="number">40001</span> SQL_NO_CACHE *<span class="regexp">/ * FROM `t1`</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'binary'</span>
<span class="line">                    9 Query     use `jfedu`</span>
<span class="line">                    9 Query     select @@collation_database</span>
<span class="line">                    9 Query     SHOW TRIGGERS LIKE 't1'</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'utf8'</span>
<span class="line">                    9 Query     ROLLBACK TO SAVEPOINT sp</span>
<span class="line">                    9 Query     RELEASE SAVEPOINT sp</span>
<span class="line">                    9 Quit</span>
<span class="line"># ------------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 关闭general.log</span>
<span class="line">set global general_log=0;</span></span>
</pre></td></tr></table></figure>
<h3 id="修改隔离级别"><a href="#修改隔离级别" class="headerlink" title="修改隔离级别"></a>修改隔离级别</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%iso%'</span>;</span>
<span class="line">+---------------+-----------------+</span>
<span class="line">| Variable_name | Value           |</span>
<span class="line">+---------------+-----------------+</span>
<span class="line">| tx_isolation  | REPEATABLE-READ |</span>
<span class="line">+---------------+-----------------+</span>
<span class="line"></span>
<span class="line">set global tx_isolation=<span class="string">'read-committed'</span>;   <span class="comment"># 重启mysql失效</span></span>
<span class="line">set session tx_isolation=<span class="string">'read-committed'</span>;  <span class="comment"># 只在当前会话中有效</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改my.cnf永久有效</span></span>
<span class="line">vi /etc/my.cnf</span>
<span class="line"><span class="comment">#-------------------------------------</span></span>
<span class="line">transaction_isolation=<span class="keyword">read</span>-committed</span>
<span class="line"><span class="comment">#-------------------------------------</span></span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%iso%'</span>;</span>
<span class="line">+---------------+----------------+</span>
<span class="line">| Variable_name | Value          |</span>
<span class="line">+---------------+----------------+</span>
<span class="line">| tx_isolation  | READ-COMMITTED |</span>
<span class="line">+---------------+----------------+</span>
</pre></td></tr></table></figure>
<h3 id="mydumper常用参数及使用示例"><a href="#mydumper常用参数及使用示例" class="headerlink" title="mydumper常用参数及使用示例"></a>mydumper常用参数及使用示例</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">mydumper --help</span>
<span class="line"></span>
<span class="line"><span class="comment"># 常用参数解释</span></span>
<span class="line"><span class="comment"># </span></span>
<span class="line">statement-size ： sql语句最大长度</span>
<span class="line">rows ： 按照执行rows分割table数据。</span>
<span class="line">chunk-filesize ： 按照输出文件的大小分割table数据。</span>
<span class="line"><span class="keyword">no</span>-locks ： 不锁表</span>
<span class="line">binlogs ： 备份binlog日志</span>
<span class="line">threads ： 并发线程数</span>
<span class="line"></span>
<span class="line">mydumper -u [USER] -p [PASSWORD] -h [HOST] -P [PORT] -t [THREADS] -b -c -B [DB] -o /tmp/backup</span>
<span class="line"></span>
<span class="line">myloader</span>
<span class="line">  queries-per-transaction：每个事务包含的记录数</span>
<span class="line">  overwrite-tables ：drop table <span class="keyword">if</span> <span class="keyword">exists</span></span>
<span class="line">  enable-binlog：binlog恢复数据  </span>
<span class="line">  threads ： 并发线程数</span>
<span class="line"></span>
<span class="line">myloader -u [USER] -p [PASSWORD] -h [HOST] -P [PORT] -t [THREADS] -o /tmp/backup - -B [DB]</span>
</pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-05 MySQL DBA日常操作]]></title>
      <url>/2017/02/21/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/05-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="使用mysqld_mutil-start命令启动多实例3306-3307使用mysqld_multi-report命令显示结果"><a href="#使用mysqld-mutil-start命令启动多实例3306、3307，使用mysqld-multi-report命令显示结果。" class="headerlink" title="使用mysqld_mutil start命令启动多实例3306、3307，使用mysqld_multi report命令显示结果。"></a>使用mysqld_mutil start命令启动多实例3306、3307，使用mysqld_multi report命令显示结果。</h2><h3 id="规划多实例目录"><a href="#规划多实例目录" class="headerlink" title="规划多实例目录"></a>规划多实例目录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/mysql             <span class="comment"># 程序目录</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/conf              <span class="comment"># 配置文件</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/data/<span class="number">3306</span>         </span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/data/<span class="number">3307</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3307</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3307</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/run/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/run/<span class="number">3307</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/tmp/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/tmp/<span class="number">3307</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="重新编译安装mysql"><a href="#重新编译安装mysql" class="headerlink" title="重新编译安装mysql"></a>重新编译安装mysql</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line">rm -rf CMakeCache.txt</span>
<span class="line"></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/u01/mysql</span> \</span>
<span class="line">-DINSTALL_DATADIR=<span class="regexp">/u01/data</span><span class="regexp">/3306  \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DEXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=1 \</span>
<span class="line">-DENABLED_LOCAL_INFILE=1 \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span>
<span class="line">-DMYSQL_UNIX_ADDR=/u</span>01/run/<span class="number">3306</span>/mysql.sock \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/etc \</span>
<span class="line">-DWITH_READLINE=on</span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span></span>
</pre></td></tr></table></figure>
<h3 id="配置多实例独自参数文件"><a href="#配置多实例独自参数文件" class="headerlink" title="配置多实例独自参数文件"></a>配置多实例独自参数文件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/conf</span>
<span class="line">vi my3306.cnf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">[mysql]</span>
<span class="line">pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">1</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/u01/mysql</span></span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">max_allowed_packet=1g</span>
<span class="line">max_connections=3000</span>
<span class="line">max_user_connections=2800</span>
<span class="line">open_files_limit=65535</span>
<span class="line">pid_file=/u</span>01/run/<span class="number">3306</span>/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">3306</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line"></span>
<span class="line">#binlog</span>
<span class="line">log_bin=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/slow</span>.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/log</span><span class="regexp">/3306/relaylog</span></span>
<span class="line">relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line">#innodb</span>
<span class="line">innodb_data_home_dir=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_format=Barracuda</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 将上面内容中3306替换成3307，server编辑保存my3307.cnf</span>
<span class="line">vi my3307.cnf</span></span>
</pre></td></tr></table></figure>
<h3 id="初始化多实例数据库"><a href="#初始化多实例数据库" class="headerlink" title="初始化多实例数据库"></a>初始化多实例数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改环境变量</span></span>
<span class="line">vi /home/mysql/.bash_profile</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">PATH=$PATH:$HOME/bin:<span class="regexp">/u01/mysql</span><span class="regexp">/bin</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 初始化数据库实例</span>
<span class="line">cd /u</span>01/mysql/scripts</span>
<span class="line">./mysql_install_db --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf \</span>
<span class="line">--datadir=/u</span>01/data/<span class="number">3306</span> --basedir=<span class="regexp">/u01/mysql</span> --user=mysql</span>
<span class="line"></span>
<span class="line">./mysql_install_db --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3307.cnf \</span>
<span class="line">--datadir=/u</span>01/data/<span class="number">3307</span> --basedir=<span class="regexp">/u01/mysql</span> --user=mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用独立参数启动实例</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line">mysqld_safe --defaults-file=/u</span>01/conf/my3307.cnf &amp;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆3306实例</span></span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3306</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆3307实例</span></span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3307/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3307</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭实例</span></span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3307/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
</pre></td></tr></table></figure>
<h3 id="修改etcmycnf参数"><a href="#修改-etc-my-cnf参数" class="headerlink" title="修改/etc/my.cnf参数"></a>修改/etc/my.cnf参数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户下操作</span></span>
<span class="line">vi /etc/my.cnf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">[mysqld_multi]</span>
<span class="line">    mysqld=<span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysqld</span>_safe</span>
<span class="line">    mysqladmin=<span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysqladmin</span></span>
<span class="line">    user=root</span>
<span class="line">    <span class="keyword">log</span>=<span class="regexp">/u01/log</span><span class="regexp">/multi.log</span>
<span class="line"></span>
<span class="line">[mysqld3306]</span>
<span class="line">    port=3306</span>
<span class="line">    basedir=/u</span>01/mysql</span>
<span class="line">    datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">    socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line">    server-id=<span class="number">3306</span></span>
<span class="line">    log_bin=<span class="regexp">/u01/log</span><span class="regexp">/3306/binlog</span><span class="regexp">/binlog</span>
<span class="line">    slow_query_log_file=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/slow.log</span>
<span class="line">    innodb_data_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">    innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">    log_error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log</span>
<span class="line">    pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid</span>
<span class="line">    tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line">    relay_log=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/relaylog</span>
<span class="line">    relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>.index</span>
<span class="line">    relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>-log.info</span>
<span class="line">    slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line"></span>
<span class="line">[mysqld3307]</span>
<span class="line">    port=3307</span>
<span class="line">    basedir=/u</span>01/mysql</span>
<span class="line">    datadir=<span class="regexp">/u01/data</span><span class="regexp">/3307</span>
<span class="line">    socket=/u</span>01/run/<span class="number">3307</span>/mysql.sock</span>
<span class="line">    server-id=<span class="number">3307</span></span>
<span class="line">    log_bin=<span class="regexp">/u01/log</span><span class="regexp">/3307/binlog</span><span class="regexp">/binlog</span>
<span class="line">    slow_query_log_file=/u</span>01/<span class="keyword">log</span>/<span class="number">3307</span>/slow.log</span>
<span class="line">    innodb_data_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3307/iblog</span></span>
<span class="line">    innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3307/iblog</span></span>
<span class="line">    log_error=<span class="regexp">/u01/log</span><span class="regexp">/3307/error</span>.log</span>
<span class="line">    pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3307/mysqld</span>.pid</span>
<span class="line">    tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3307</span>
<span class="line">    relay_log=/u</span>01/<span class="keyword">log</span>/<span class="number">3307</span>/relaylog</span>
<span class="line">    relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3307/relay</span>.index</span>
<span class="line">    relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3307/relay</span>-log.info</span>
<span class="line">    slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3307</span>
<span class="line"></span>
<span class="line">[client]</span>
<span class="line">    port=3306</span>
<span class="line">    socket =/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">    autocommit=<span class="number">1</span></span>
<span class="line">    general_log=off</span>
<span class="line">    explicit_defaults_for_timestamp=true</span>
<span class="line">    max_allowed_packet=<span class="number">1</span>g</span>
<span class="line">    max_connections=<span class="number">3000</span></span>
<span class="line">    max_user_connections=<span class="number">2800</span></span>
<span class="line">    open_files_limit=<span class="number">65535</span></span>
<span class="line">    skip_name_resolve=ON</span>
<span class="line"></span>
<span class="line">    <span class="comment">#binlog</span></span>
<span class="line">    binlog_cache_size=<span class="number">32768</span></span>
<span class="line">    binlog_format=row</span>
<span class="line">    expire_logs_days=<span class="number">7</span></span>
<span class="line">    log_slave_updates=ON</span>
<span class="line">    max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">    max_binlog_size=<span class="number">524288000</span></span>
<span class="line">    sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line">    log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">    slow_query_log=<span class="number">1</span></span>
<span class="line">    log_slave_updates=ON</span>
<span class="line">    log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">    long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line">    slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line">    innodb_adaptive_flushing=ON</span>
<span class="line">    innodb_adaptive_hash_index=ON</span>
<span class="line">    innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">    innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line">    <span class="comment">#default</span></span>
<span class="line">    innodb_change_buffering=inserts</span>
<span class="line">    innodb_checksums=ON</span>
<span class="line">    innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">    innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">    innodb_doublewrite=ON</span>
<span class="line">    innodb_file_format=Barracuda</span>
<span class="line">    innodb_file_per_table=ON</span>
<span class="line">    innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">    innodb_flush_method=O_DIRECT</span>
<span class="line">    innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">    innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">    innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">    innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">    innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">    innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">    innodb_open_files=<span class="number">60000</span></span>
<span class="line">    innodb_purge_threads=<span class="number">1</span></span>
<span class="line">    innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">    innodb_stats_on_metadata=OFF</span>
<span class="line">    innodb_support_xa=ON</span>
<span class="line">    innodb_use_native_aio=OFF</span>
<span class="line">    innodb_write_io_threads=<span class="number">10</span></span>
<span class="line">----------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h3 id="mysqld_multi启动关闭多实例查看多实例运行状态"><a href="#mysqld-multi启动-关闭多实例，查看多实例运行状态" class="headerlink" title="mysqld_multi启动/关闭多实例，查看多实例运行状态"></a>mysqld_multi启动/关闭多实例，查看多实例运行状态</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动多实例数据库</span></span>
<span class="line">mysqld_multi start             <span class="comment"># 启动全部配置的多实例</span></span>
<span class="line">mysqld_multi start <span class="number">3306</span>        <span class="comment"># 启动指定server-id的实例</span></span>
<span class="line">mysqld_multi start <span class="number">3306</span>-<span class="number">3307</span>   <span class="comment"># 启动指定server-id连续的实例</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看多实例运行状态</span></span>
<span class="line">mysqld_multi report</span>
<span class="line">Reporting MySQL servers</span>
<span class="line">MySQL server from group: mysqld3306 is running</span>
<span class="line">MySQL server from group: mysqld3307 is running</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭多实例数据库</span></span>
<span class="line">mysqld_multi stop</span>
<span class="line">mysqld_multi stop <span class="number">3306</span></span>
<span class="line">mysqld_multi stop <span class="number">3306</span>-<span class="number">3307</span></span>
</pre></td></tr></table></figure>
<h2 id="在线迁移mysql-3306实例上的数据库jfedu到mysql-3307上"><a href="#在线迁移MySQL-3306实例上的数据库jfedu到MySQL-3307上。" class="headerlink" title="在线迁移MySQL 3306实例上的数据库jfedu到MySQL 3307上。"></a>在线迁移MySQL 3306实例上的数据库jfedu到MySQL 3307上。</h2><h3 id="登陆3306实例创建jfedu数据库"><a href="#登陆3306实例，创建jfedu数据库" class="headerlink" title="登陆3306实例，创建jfedu数据库"></a>登陆3306实例，创建jfedu数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登陆3306实例</span></span>
<span class="line">mysql -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看port和server_id</span></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3306</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'server_id'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| server_id     | <span class="number">3306</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建jfedu数据库，创建表t1并插入数据</span></span>
<span class="line">create database jfedu;</span>
<span class="line"><span class="keyword">use</span> jfedu;</span>
<span class="line">create table t1(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="在3306实例上创建一个复制帐号"><a href="#在3306实例上创建一个复制帐号" class="headerlink" title="在3306实例上创建一个复制帐号"></a>在3306实例上创建一个复制帐号</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">grant replication slave,replication client on *.* to <span class="string">'repl'</span>@'%' identified by <span class="string">'repl4Slave'</span>;</span>
</pre></td></tr></table></figure>
<h3 id="备份jfedu数据库"><a href="#备份jfedu数据库" class="headerlink" title="备份jfedu数据库"></a>备份jfedu数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysqldump --single-transaction --master-data=<span class="number">2</span> -uroot jfedu &gt; <span class="regexp">/tmp/jfedu</span>.sql</span>
<span class="line"><span class="comment"># --single-transaction 不锁表</span></span>
<span class="line"><span class="comment"># --master-data=2 在备份文件中记录master_log_file和master_log_pos的值</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置主从复制时会用到master_log_file和master_log_pos的值</span></span>
<span class="line">cat /tmp/jfedu.sql | <span class="keyword">grep</span> MASTER_LOG_FILE</span>
<span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'binlog.000022'</span>, MASTER_LOG_POS=<span class="number">750</span>;</span>
</pre></td></tr></table></figure>
<h3 id="在3307实例上恢复jfedu数据库"><a href="#在3307实例上恢复jfedu数据库" class="headerlink" title="在3307实例上恢复jfedu数据库"></a>在3307实例上恢复jfedu数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登陆3306实例</span></span>
<span class="line">mysql -S /u01/run/<span class="number">3307</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看port和server_id</span></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3307</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'server_id'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| server_id     | <span class="number">3307</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在3307上创建jfedu数据库</span></span>
<span class="line">create database jfedu;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复数据库</span></span>
<span class="line"><span class="keyword">use</span> jfedu;</span>
<span class="line">source /tmp/jfedu.sql;</span>
</pre></td></tr></table></figure>
<h3 id="3306实例在恢复时有数据插入"><a href="#3306实例在恢复时有数据插入" class="headerlink" title="3306实例在恢复时有数据插入"></a>3306实例在恢复时有数据插入</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> jfedu</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'BBBBB'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="在3307实例上执行change-master设置主从复制并启动复制"><a href="#在3307实例上执行change-master设置主从复制，并启动复制" class="headerlink" title="在3307实例上执行change master设置主从复制，并启动复制"></a>在3307实例上执行change master设置主从复制，并启动复制</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置主从复制</span></span>
<span class="line">change master to</span>
<span class="line">master_host=<span class="string">'127.0.0.1'</span>,</span>
<span class="line">master_port=<span class="number">3306</span>,</span>
<span class="line">master_user=<span class="string">'repl'</span>,</span>
<span class="line">master_password=<span class="string">'repl4Slave'</span>,</span>
<span class="line">master_log_file=<span class="string">'binlog.000022'</span>,</span>
<span class="line">master_log_pos=<span class="number">750</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动复制</span></span>
<span class="line">start slave;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看复制状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line"></span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line">                  Master_User: repl</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000022</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">949</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">479</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000022</span></span>
<span class="line">             Slave_IO_Running: Yes               <span class="comment"># Yes表示复制正常</span></span>
<span class="line">            Slave_SQL_Running: Yes               <span class="comment"># Yes表示复制正常</span></span>
<span class="line">......</span>
<span class="line"></span>
<span class="line"><span class="comment"># 观察3307上数据是否复制过来</span></span>
<span class="line"><span class="keyword">select</span> * from jfedu.t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA |</span>
<span class="line">|    <span class="number">2</span> | BBBBB |</span>
<span class="line">+------+-------+</span>
</pre></td></tr></table></figure>
<h3 id="3306实例设置成read-only"><a href="#3306实例设置成read-only" class="headerlink" title="3306实例设置成read only"></a>3306实例设置成read only</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'read_only'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| read_only     | OFF   |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">set global read_only=<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h3 id="数据全部一致后停止复制"><a href="#数据全部一致后，停止复制" class="headerlink" title="数据全部一致后，停止复制"></a>数据全部一致后，停止复制</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">stop slave;</span>
</pre></td></tr></table></figure>
<h2 id="mysql56升级到mysql57正常登录到mysql57详细步骤"><a href="#MySQL5-6升级到MySQL5-7，正常登录到MySQL5-7，详细步骤。" class="headerlink" title="MySQL5.6升级到MySQL5.7，正常登录到MySQL5.7，详细步骤。"></a>MySQL5.6升级到MySQL5.7，正常登录到MySQL5.7，详细步骤。</h2><h3 id="下载mysql57"><a href="#下载MySQL5-7" class="headerlink" title="下载MySQL5.7"></a>下载MySQL5.7</h3><p>下载地址：<a href="https://dev.mysql.com/downloads/mysql" target="_blank" rel="external">https://dev.mysql.com/downloads/mysql </a><br><img src="http://oligvdnzp.bkt.clouddn.com/0224_mysql57_01.png" alt="mysql5.7下载"></p>
<h3 id="上传并解压软件包"><a href="#上传并解压软件包" class="headerlink" title="上传并解压软件包"></a>上传并解压软件包</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[mysql@mysql ~]$ cd /u01</span>
<span class="line"><span class="comment">#选择下载的软件包上传</span></span>
<span class="line">[mysql@mysql u01]$ rz</span>
<span class="line">[mysql@mysql u01]$ ll</span>
<span class="line">total <span class="number">698668</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">2</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">11</span>:<span class="number">16</span> conf</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> 09:<span class="number">45</span> data</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">11</span>:<span class="number">00</span> <span class="keyword">log</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">13</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">16</span> mysql</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">35</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">05</span> mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line">-rwxr-xr-x.  <span class="number">1</span> mysql mysql  <span class="number">32167628</span> Jan <span class="number">17</span> <span class="number">11</span>:<span class="number">16</span> mysql-<span class="number">5.6</span>.<span class="number">35</span>.tar.gz</span>
<span class="line">-rw-r--r--   <span class="number">1</span> mysql mysql <span class="number">683233280</span> Feb <span class="number">24</span> <span class="number">16</span>:<span class="number">36</span> mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar   <span class="comment"># 这个就是二进制mysql5.7软件</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> 09:<span class="number">50</span> run</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> 09:<span class="number">45</span> tmp</span>
<span class="line"></span>
<span class="line">tar -xpvf mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar</span>
<span class="line">tar -xpvf mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="comment"># 因为是二进制包，解压后就可以用了，文件夹名改短些</span></span>
<span class="line">mv mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64 mysql5.<span class="number">7</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改环境变量</span></span>
<span class="line">vi /home/mysql/.bash_profile</span>
<span class="line">PATH=$PATH:$HOME/bin:<span class="regexp">/u01/mysql</span>5.<span class="number">7</span>/bin</span>
</pre></td></tr></table></figure>
<h3 id="查看mysql版本信息"><a href="#查看mysql版本信息" class="headerlink" title="查看mysql版本信息"></a>查看mysql版本信息</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql -V</span>
<span class="line">--------------</span>
<span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.7</span>.<span class="number">17</span>, <span class="keyword">for</span> linux-glibc2.<span class="number">5</span> (x86_64) using  EditLine wrapper</span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line">mysqld_multi start <span class="number">3306</span></span>
<span class="line">mysql -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">status;</span>
<span class="line">--------------</span>
<span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.7</span>.<span class="number">17</span>, <span class="keyword">for</span> linux-glibc2.<span class="number">5</span> (x86_64) using  EditLine wrapper</span>
<span class="line"></span>
<span class="line">Connection id:          <span class="number">7</span></span>
<span class="line">Current database:</span>
<span class="line">Current user:           root@localhost</span>
<span class="line">SSL:                    Not in <span class="keyword">use</span></span>
<span class="line">Current pager:          stdout</span>
<span class="line">Using outfile:          <span class="string">''</span></span>
<span class="line">Using delimiter:        ;</span>
<span class="line">Server version:         <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> Source distribution</span>
<span class="line">Protocol version:       <span class="number">10</span></span>
<span class="line">Connection:             Localhost via UNIX <span class="keyword">socket</span></span>
<span class="line">Server characterset:    utf8</span>
<span class="line">Db     characterset:    utf8</span>
<span class="line">Client characterset:    utf8</span>
<span class="line">Conn.  characterset:    utf8</span>
<span class="line">UNIX <span class="keyword">socket</span>:            <span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">Uptime:                 <span class="number">3</span> min <span class="number">57</span> sec</span>
<span class="line"></span>
<span class="line">Threads: <span class="number">2</span>  Questions: <span class="number">16</span>  Slow queries: <span class="number">0</span>  Opens: <span class="number">70</span>  Flush tables: <span class="number">1</span>  Open tables: <span class="number">63</span>  Queries per second avg: <span class="number">0</span>.<span class="number">067</span></span>
<span class="line">--------------</span>
</pre></td></tr></table></figure>
<h3 id="升级数据库字典"><a href="#升级数据库字典" class="headerlink" title="升级数据库字典"></a>升级数据库字典</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql_upgrade -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line">--------------</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">Checking server version.</span>
<span class="line">Error: Server version (<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>) does <span class="keyword">not</span> match with the version of</span>
<span class="line">the server (<span class="number">5.7</span>.<span class="number">17</span>) with which this program was built/distributed. You can</span>
<span class="line"><span class="keyword">use</span> --skip-version-check to skip this check.</span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line">mysql_upgrade -S /u01/run/<span class="number">3306</span>/mysql.sock --skip-version-check</span>
<span class="line">--------------</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">Running queries to upgrade MySQL server.</span>
<span class="line">mysql_upgrade: [ERROR] <span class="number">1726</span>: Storage engine <span class="string">'InnoDB'</span> does <span class="keyword">not</span> support <span class="keyword">system</span> tables. [mysql.plugin]</span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启下数据库</span></span>
<span class="line">mysqld_multi stop</span>
<span class="line">mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line">mysql_upgrade -S /u</span>01/run/<span class="number">3306</span>/mysql.sock --skip-version-check</span>
<span class="line">--------------</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">Running queries to upgrade MySQL server.</span>
<span class="line">Checking <span class="keyword">system</span> database.</span>
<span class="line">mysql.columns_priv                                 OK</span>
<span class="line">mysql.db                                           OK</span>
<span class="line">mysql.engine_cost                                  OK</span>
<span class="line">mysql.event                                        OK</span>
<span class="line">mysql.func                                         OK</span>
<span class="line">mysql.general_log                                  OK</span>
<span class="line">mysql.gtid_executed                                OK</span>
<span class="line">mysql.help_category                                OK</span>
<span class="line">mysql.help_keyword                                 OK</span>
<span class="line">mysql.help_relation                                OK</span>
<span class="line">mysql.help_topic                                   OK</span>
<span class="line">mysql.innodb_index_stats                           OK</span>
<span class="line">mysql.innodb_table_stats                           OK</span>
<span class="line">mysql.ndb_binlog_index                             OK</span>
<span class="line">mysql.plugin                                       OK</span>
<span class="line">......</span>
<span class="line">Repairing tables</span>
<span class="line">mysql_old.innodb_index_stats</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.innodb_table_stats</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.slave_master_info</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.slave_relay_log_info</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.slave_worker_info</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">Upgrade process completed successfully.</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">--------------</span>
</pre></td></tr></table></figure>
<h3 id="再查看mysql版本信息升级完成"><a href="#再查看mysql版本信息，升级完成" class="headerlink" title="再查看mysql版本信息，升级完成"></a>再查看mysql版本信息，升级完成</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">mysql&gt; status;</span>
<span class="line">--------------</span>
<span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.7</span>.<span class="number">17</span>, <span class="keyword">for</span> linux-glibc2.<span class="number">5</span> (x86_64) using  EditLine wrapper</span>
<span class="line"></span>
<span class="line">Connection id:          <span class="number">4</span></span>
<span class="line">Current database:</span>
<span class="line">Current user:           root@localhost</span>
<span class="line">SSL:                    Not in <span class="keyword">use</span></span>
<span class="line">Current pager:          stdout</span>
<span class="line">Using outfile:          <span class="string">''</span></span>
<span class="line">Using delimiter:        ;</span>
<span class="line">Server version:         <span class="number">5.7</span>.<span class="number">17</span>-<span class="keyword">log</span> MySQL Community Server (GPL)</span>
<span class="line">Protocol version:       <span class="number">10</span></span>
<span class="line">Connection:             Localhost via UNIX <span class="keyword">socket</span></span>
<span class="line">Server characterset:    latin1</span>
<span class="line">Db     characterset:    latin1</span>
<span class="line">Client characterset:    utf8</span>
<span class="line">Conn.  characterset:    utf8</span>
<span class="line">UNIX <span class="keyword">socket</span>:            <span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">Uptime:                 <span class="number">6</span> min <span class="number">3</span> sec</span>
<span class="line"></span>
<span class="line">Threads: <span class="number">1</span>  Questions: <span class="number">3174</span>  Slow queries: <span class="number">0</span>  Opens: <span class="number">368</span>  Flush tables: <span class="number">1</span>  Open tables: <span class="number">25</span>  Queries per second avg: <span class="number">8.743</span></span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> version();</span>
<span class="line">+------------+</span>
<span class="line">| version()  |</span>
<span class="line">+------------+</span>
<span class="line">| <span class="number">5.7</span>.<span class="number">17</span>-<span class="keyword">log</span> |</span>
<span class="line">+------------+</span>
</pre></td></tr></table></figure>
<h2 id="课堂笔记整理"><a href="#课堂笔记整理" class="headerlink" title="课堂笔记整理"></a>课堂笔记整理</h2><h3 id="mysql启动"><a href="#MySQL启动" class="headerlink" title="MySQL启动"></a>MySQL启动</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 推荐启动方式</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line"># 编译安装可以使用的启动方式（很少用）</span>
<span class="line">cd /u</span>01/mysql/support-files/</span>
<span class="line">./mysql.server start</span>
<span class="line"></span>
<span class="line"><span class="comment"># rpm包安装可以使用的启动方式</span></span>
<span class="line">/etc/init.d/mysqld start</span>
<span class="line">service mysqld start</span>
<span class="line"></span>
<span class="line"><span class="comment"># mysqld的启动方式</span></span>
<span class="line">mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line"># 多实例启动方式，需要先修改my.cnf参数，并放到/etc</span>目录下（建议单个实例维护）</span>
<span class="line">mysqld_mutil start</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看mysql启动时参数my.cnf查找顺序</span></span>
<span class="line">mysqld --verbose --help | <span class="keyword">grep</span> my.cnf</span>
<span class="line"></span>
<span class="line"><span class="comment"># mysqld_safe方式启动mysql后相关进程，mysqld_safe进程有监控mysqld进程的作用，mysqld异常终止时，mysqld_safe会重启mysqld</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> mysql | <span class="keyword">grep</span> -v bash | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | <span class="keyword">grep</span> -v su | <span class="keyword">grep</span> -v ps</span>
<span class="line">mysql     <span class="number">5503</span> <span class="number">18586</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">33</span> pts/<span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/sh /u01/mysql/bin/mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf</span>
<span class="line">mysql     6342  5503  0 16:33 pts/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /u01/mysql/bin/mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf --basedir=/u</span>01/mysql --datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306 --plugin-dir=/u</span>01/mysql/lib/plugin --<span class="keyword">log</span>-error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log --<span class="keyword">open</span>-files-limit=<span class="number">65535</span> --pid-file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock --port=<span class="number">3306</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># mysqld方式启动mysql后相关进程</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> mysql | <span class="keyword">grep</span> -v bash | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | <span class="keyword">grep</span> -v su | <span class="keyword">grep</span> -v ps</span>
<span class="line">mysql     <span class="number">6401</span> <span class="number">18586</span>  <span class="number">2</span> <span class="number">16</span>:<span class="number">36</span> pts/<span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf</span></span>
</pre></td></tr></table></figure>
<h3 id="mysql关闭"><a href="#MySQL关闭" class="headerlink" title="MySQL关闭"></a>MySQL关闭</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用mysqld_safe和mysqld启动的关闭方式（推荐的方式）</span></span>
<span class="line">mysqladmin <span class="keyword">shutdown</span></span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译安装可以使用的关闭方式</span></span>
<span class="line">cd /u01/mysql/support-files/</span>
<span class="line">./mysql.server stop</span>
<span class="line"></span>
<span class="line"><span class="comment"># rpm安装可以使用的关闭方式</span></span>
<span class="line">/etc/init.d/mysqld stop</span>
<span class="line">service mysqld stop</span>
<span class="line"></span>
<span class="line"><span class="comment"># 多实例关闭方式</span></span>
<span class="line">mysqld_mutil stop</span>
<span class="line"></span>
<span class="line"><span class="comment"># kill进程</span></span>
<span class="line"><span class="keyword">kill</span> -<span class="number">9</span> pid</span>
</pre></td></tr></table></figure>
<h3 id="mysql登陆"><a href="#MySQL登陆" class="headerlink" title="MySQL登陆"></a>MySQL登陆</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 本地登陆</span></span>
<span class="line">mysql</span>
<span class="line">mysql -u$username -p$password</span>
<span class="line"></span>
<span class="line"><span class="comment"># 远程登陆</span></span>
<span class="line">mysql -u$username -p$password -h$ip</span>
<span class="line"></span>
<span class="line"><span class="comment"># 多实例</span></span>
<span class="line">mysql -u$username -p$password -P$port</span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock --port=<span class="number">3306</span></span>
</pre></td></tr></table></figure>
<h3 id="帐户权限设置-创建删除用户"><a href="#帐户权限设置-创建-删除用户" class="headerlink" title="帐户权限设置-创建/删除用户"></a>帐户权限设置-创建/删除用户</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">+------+-----------+----------+</span>
<span class="line">| user | host      | password |</span>
<span class="line">+------+-----------+----------+</span>
<span class="line">| root | localhost |          |     <span class="comment"># 密码都为空，不安全</span></span>
<span class="line">| root | mysql     |          |</span>
<span class="line">| root | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> |          |</span>
<span class="line">| root | ::<span class="number">1</span>       |          |</span>
<span class="line">|      | localhost |          |</span>
<span class="line">|      | mysql     |          |</span>
<span class="line">+------+-----------+----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># insert方式创建用户(用insert方式创建的用户，需要刷新缓存)</span></span>
<span class="line">insert into mysql.user(user,host,password) <span class="keyword">values</span>(<span class="string">'mytt'</span>,<span class="string">'127.0.0.1'</span>,password(<span class="number">123456</span>));</span>
<span class="line">flush privileges;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| user | host      | password                                  |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| root | localhost |                                           |</span>
<span class="line">| root | mysql     |                                           |</span>
<span class="line">| root | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> |                                           |</span>
<span class="line">| root | ::<span class="number">1</span>       |                                           |</span>
<span class="line">|      | localhost |                                           |</span>
<span class="line">|      | mysql     |                                           |</span>
<span class="line">| mytt | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># mytt登陆mysql命令如下</span></span>
<span class="line">mysql -umytt -p123456 -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> user();</span>
<span class="line">+----------------+</span>
<span class="line">| user()         |</span>
<span class="line">+----------------+</span>
<span class="line">| mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> |</span>
<span class="line">+----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># create方式创建用户</span></span>
<span class="line">create user lyj@'%' identified by <span class="string">'123456'</span>;  <span class="comment"># %代表可以从任意位置登陆</span></span>
<span class="line">mysql -ulyj -p123456 -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除用户</span></span>
<span class="line">drop user lyj;</span>
</pre></td></tr></table></figure>
<h3 id="帐户权限设置-用户授权"><a href="#帐户权限设置-用户授权" class="headerlink" title="帐户权限设置-用户授权"></a>帐户权限设置-用户授权</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建新用户并授权</span></span>
<span class="line">grant all privileges on *.* to lyj@'%' identified by <span class="string">'123456'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看用户权限</span></span>
<span class="line">show grants <span class="keyword">for</span> lyj@'%';</span>
<span class="line">+-------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| Grants <span class="keyword">for</span> lyj@%                                                                                            |</span>
<span class="line">+-------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| GRANT ALL PRIVILEGES ON *.* TO <span class="string">'lyj'</span>@'%' IDENTIFIED BY PASSWORD <span class="string">'*6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9'</span> |</span>
<span class="line">+-------------------------------------------------------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 给已有用户授权</span></span>
<span class="line">grant <span class="keyword">select</span> on *.* to mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>;</span>
<span class="line">show grants <span class="keyword">for</span> mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>;</span>
<span class="line">+--------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| Grants <span class="keyword">for</span> mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>                                                                                    |</span>
<span class="line">+--------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| GRANT SELECT ON *.* TO <span class="string">'mytt'</span>@'<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' IDENTIFIED BY PASSWORD '</span>*<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9<span class="string">' |</span>
<span class="line">+--------------------------------------------------------------------------------------------------------------+</span></span>
</pre></td></tr></table></figure>
<h3 id="帐户权限设置-权限等级"><a href="#帐户权限设置-权限等级" class="headerlink" title="帐户权限设置-权限等级"></a>帐户权限设置-权限等级</h3><ol>
<li>核心开发权限 select/insert/delete/update</li>
<li>管理权限–表级 create table/drop table/lock table</li>
<li>管理权限–server级别 create database/create user等</li>
</ol>
<h3 id="mysql数据库安全配置"><a href="#MySQL数据库安全配置" class="headerlink" title="MySQL数据库安全配置"></a>MySQL数据库安全配置</h3><p>1.禁用/删除多余的管理员帐号，设置用户密码<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除多余的帐号</span></span>
<span class="line"><span class="keyword">delete</span> from mysql.user where user !=<span class="string">'root'</span> <span class="keyword">and</span> password=<span class="string">''</span>;</span>
<span class="line">flush privileges;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用set方式设置root用户密码</span></span>
<span class="line">set password <span class="keyword">for</span> root@localhost = password(<span class="string">'123456'</span>);</span>
<span class="line">set password <span class="keyword">for</span> root@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> = password(<span class="string">'123456'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用mysqladmin工具设置密码</span></span>
<span class="line"><span class="comment">## 格式: mysqladmin -u用户名 -p旧密码 password 新密码</span></span>
<span class="line"><span class="comment">## 密码为空时，直接输入回车确认</span></span>
<span class="line">mysqladmin -uroot -p password <span class="number">654321</span></span>
<span class="line">Enter password: </span>
<span class="line">Warning: Using a password on the command line interface can be insecure.</span>
<span class="line"></span>
<span class="line"><span class="comment">## 修改已有密码</span></span>
<span class="line">mysqladmin -uroot -p654321 password <span class="number">123456</span></span>
<span class="line"><span class="comment">## 执行后会出现如下警告提示，可以忽略：</span></span>
<span class="line"><span class="comment">## Warning: Using a password on the command line interface can be insecure.</span></span>
<span class="line"><span class="comment">## 翻译过来的意思：在命令行界面上使用密码是不安全的。</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆mysql</span></span>
<span class="line">mysql -uroot -p123456</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除所有密码为空的帐号</span></span>
<span class="line"><span class="keyword">delete</span> from mysql.user where password=<span class="string">''</span>;</span>
<span class="line">flush privileges;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 确保所有用户都有密码</span></span>
<span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| user | host      | password                                  |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| root | localhost | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">| root | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">| mytt | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
</pre></td></tr></table></figure></p>
<p>2.删除掉db表数据(test权限)<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> mysql;</span>
<span class="line"><span class="keyword">truncate</span> table mysql.db;</span>
</pre></td></tr></table></figure></p>
<p>3.删除test库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">drop database test;</span>
</pre></td></tr></table></figure></p>
<p>4.修改管理员帐户名<br>5.密码复杂度要求<br>6.权限最小化</p>
<h3 id="表操作线上可以直接删除表吗"><a href="#表操作–线上可以直接删除表吗" class="headerlink" title="表操作–线上可以直接删除表吗?"></a>表操作–线上可以直接删除表吗?</h3><p>生产环境上，不可以直接删除表，要删除表步骤如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建环境</span></span>
<span class="line">drop database lyj;</span>
<span class="line">create database lyj;</span>
<span class="line"><span class="keyword">use</span> lyj;</span>
<span class="line">create table t1 (id <span class="keyword">int</span>, name varchar(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'lyj'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 1.查看表</span></span>
<span class="line">show tables;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 2.检查表是否被访问</span></span>
<span class="line">show processlist;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 3.重命名临时表</span></span>
<span class="line"><span class="keyword">rename</span> table t1 to t1_bak;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 4.备份临时表</span></span>
<span class="line">mysqldump -uroot -p123456 lyj t1_bak &gt; <span class="regexp">/tmp/lyj</span>_t1_bak_20170223.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 5.一段时间后删除临时表</span></span>
<span class="line">drop table t1_bak;</span>
<span class="line">show tables from lyj like <span class="string">'%t1%'</span>;</span>
</pre></td></tr></table></figure></p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show databases;</span>
<span class="line"><span class="keyword">use</span> mysql;</span>
<span class="line">show tables;</span>
<span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">grant all privilege on *.* to test_1@'%';</span>
<span class="line">mysql -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -utest_1</span>
<span class="line"><span class="keyword">select</span> user();</span>
<span class="line">create database jianfeng;</span>
<span class="line">create table user(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">grant <span class="keyword">select</span> on jianfeng.user to test_1@'%';</span>
<span class="line">flush privileges;</span>
<span class="line">show master status\G;</span>
<span class="line">change master to xxx;</span>
<span class="line">show engine innodb status\G</span>
<span class="line">show tables from information_schema like <span class="string">'INNODB%'</span>;</span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf &amp;</span>
<span class="line">mysqladmin -S /u01/my3306/run/mysql.sock <span class="keyword">shutdown</span> &amp;</span>
<span class="line"></span>
<span class="line"><span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysql</span>_secure_installation</span>
</pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[那些在11gR2中可能惹祸的新特性]]></title>
      <url>/2017/02/16/oracle/%E9%82%A3%E4%BA%9B%E5%9C%A811gR2%E4%B8%AD%E5%8F%AF%E8%83%BD%E6%83%B9%E7%A5%B8%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7/</url>
      <content type="html"><![CDATA[<p>有很多朋友因为11gR2那些潜在的特性可能给升级后系统稳定运行带来麻烦而无法鼓足升级到11gR2的勇气，实际Oracle在开发新版本RDBMS软件时引入的一些特性有很好的理念的，但是往往这些理念会给已稳定的应用环境带来变数，最显著的就是10g/9i升级到11gR2时的执行计划稳定性，此外adaptive cursor sharing 自适应游标、automatic serial direct path自动判断串行直接路径读、deferred segment creation、GC read mostly DRM…….等等的一系列特性已经在大量的案例中被证明是不适合于大量国产Application的。</p>
<p>这篇文章里想做的是给出一张列表，能够将11gR2的优化器optimizer特性、和其他的如上列的这些可能引起问题的特性通过参数的方式给出一张列表，你可以选择性的禁用这些特性，前提是你的Applicaiton就该特性经过充分的测试，如果没有时间或者环境来测试这些新特性，那么还不如禁用这些特性，禁用新特性的结果也仅仅是回到老版本(一般是10gR2 10.2.0.4)的默认表现上来。<br><a id="more"></a><br>你肯定要问：“如果都禁用了11gR2的特性，那么我还升级做什么？”</p>
<p>回答是：首先这里给出的是一张禁用11gR2特性列表，如果你对部分特性已经很熟悉，那么你可以选择性而非全部地禁用这些特性，如果不熟悉也测试不了，那么无畏给稳定的系统引入不确定因素。其次这里列出的仅仅是11gR2部分默认已启用的可能”惹祸”的特性， 其他的一些特性例如flashback archive、securefile，它们默认不开启，本身需要你去手动打开才会生效，并不会受到这张列表的影响。</p>


	<div class="row">
    <embed src="http://ol3rzmg8c.bkt.clouddn.com/%E9%82%A3%E4%BA%9B11gR2%E4%B8%AD%E6%83%B9%E7%A5%B8%E7%9A%84%E7%89%B9%E6%80%A7%E5%85%B3%E9%97%AD%E5%88%97%E8%A1%A8.pdf" width="100%" height="550" type="application/pdf">
	</div>



<blockquote>
<p>转载自：<a href="http://www.askmaclean.com/" target="_blank" rel="external">AskMaclean</a></p>
</blockquote>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hexo解决代码块空行自动删除问题]]></title>
      <url>/2017/02/14/tools/hexo%E8%A7%A3%E5%86%B3%E4%BB%A3%E7%A0%81%E5%9D%97%E7%A9%BA%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="修改hexo源码"><a href="#修改hexo源码" class="headerlink" title="修改hexo源码"></a>修改hexo源码</h2><p>将<code>node_modules\hexo-util\lib\highlight.js</code>文件中第<code>35</code>行<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 原</span></span>
<span class="line">    numbers += <span class="string">'&lt;div class="line"&gt;'</span> + (firstLine + i) + <span class="string">'&lt;/div&gt;\n'</span>;</span>
<span class="line">    content += <span class="string">'&lt;div class="line'</span>;</span>
<span class="line">    content += (mark.indexOf(firstLine + i) !== -<span class="number">1</span>) ? <span class="string">' marked'</span> : <span class="string">''</span>;</span>
<span class="line">    content += <span class="string">'"&gt;'</span> + line + <span class="string">'&lt;/div&gt;\n'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 改后</span></span>
<span class="line">    numbers += <span class="string">'&lt;span class="line"&gt;'</span> + (firstLine + i) + <span class="string">'&lt;/span&gt;\n'</span>;</span>
<span class="line">    content += <span class="string">'&lt;span class="line'</span>;</span>
<span class="line">    content += (mark.indexOf(firstLine + i) !== -<span class="number">1</span>) ? <span class="string">' marked'</span> : <span class="string">''</span>;</span>
<span class="line">    content += <span class="string">'"&gt;'</span> + line + <span class="string">'&lt;/span&gt;\n'</span>;</span>
</pre></td></tr></table></figure></p>
<h2 id="清理临时数据库并重启本地服务"><a href="#清理临时数据库并重启本地服务" class="headerlink" title="清理临时数据库并重启本地服务"></a>清理临时数据库并重启本地服务</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo clean</span>
<span class="line">hexo <span class="keyword">s</span> -g</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="查看hexo版本信息"><a href="#查看hexo版本信息" class="headerlink" title="查看hexo版本信息"></a>查看hexo版本信息</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ hexo version</span>
<span class="line">hexo: <span class="number">3.2</span>.<span class="number">2</span></span>
<span class="line">hexo-cli: <span class="number">1.0</span>.<span class="number">2</span></span>
<span class="line">os: Windows_NT <span class="number">6.1</span>.<span class="number">7601</span> win32 x64</span>
<span class="line">http_parser: <span class="number">2.7</span>.<span class="number">0</span></span>
<span class="line">node: <span class="number">6.9</span>.<span class="number">4</span></span>
<span class="line">v8: <span class="number">5.1</span>.<span class="number">281.89</span></span>
<span class="line">uv: <span class="number">1.9</span>.<span class="number">1</span></span>
<span class="line">zlib: <span class="number">1.2</span>.<span class="number">8</span></span>
<span class="line">ares: <span class="number">1.10</span>.<span class="number">1</span>-DEV</span>
<span class="line">icu: <span class="number">57.1</span></span>
<span class="line">modules: <span class="number">48</span></span>
<span class="line">openssl: <span class="number">1.0</span>.<span class="number">2</span>j</span>
</pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-04 揭密MySQL databock and binlog的格式]]></title>
      <url>/2017/02/14/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/04-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="1-为什么创建一个innodb表只分配了96k而不是1m"><a href="#1-为什么创建一个InnoDB表只分配了96K而不是1M？" class="headerlink" title="1. 为什么创建一个InnoDB表只分配了96K而不是1M？"></a>1. 为什么创建一个InnoDB表只分配了96K而不是1M？</h2><p>Mysql中<code>extent</code>(区)中是64个连续的<code>page</code>(页)，是分配空间的最小单位，标准大小是1M。 但在用户启用了参数<code>innodb_file_per_table=on</code>后，创建一个Innodb表时，初始分配的大小却是为96K。这是因为在每个段开始时，先用32个页大小的碎片页(fragment page)来存放数据，在使用完这些页之后才是64个连续页的申请。这样做的目的是，对于一些小表，或者是undo这类的段，可以在开始时申请较少的空间，节省磁盘容量的开销。 下面通过示例来显示InnoDB存储引擎对于区的申请方式。</p>
<a id="more"></a>
<h3 id="创建一个测试用的innodb表"><a href="#创建一个测试用的InnoDB表" class="headerlink" title="创建一个测试用的InnoDB表"></a>创建一个测试用的InnoDB表</h3><p>创建数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; create database lyj;</span>
</pre></td></tr></table></figure></p>
<p>查看数据库创建信息，并切换到lyj数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show create database lyj;</span>
<span class="line">+----------+--------------------------------------------------------------+</span>
<span class="line">| Database | Create Database                                              |</span>
<span class="line">+----------+--------------------------------------------------------------+</span>
<span class="line">| lyj      | CREATE DATABASE <span class="string">`lyj`</span> /*!<span class="number">40100</span> DEFAULT CHARACTER SET utf8 *<span class="regexp">/ |</span>
<span class="line">+----------+--------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; use lyj;</span>
<span class="line"></span>
<span class="line">mysql&gt; select database();</span>
<span class="line">+------------+</span>
<span class="line">| database() |</span>
<span class="line">+------------+</span>
<span class="line">| lyj        |</span>
<span class="line">+------------+</span></span>
</pre></td></tr></table></figure></p>
<p>查看是否启用独享表空间存储方式（innodb_file_per_table=ON），启用后每一个表会单独的生成一个<code>table_name.ibd</code>的文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%per_table%'</span>;</span>
<span class="line">+-----------------------+-------+</span>
<span class="line">| Variable_name         | Value |</span>
<span class="line">+-----------------------+-------+</span>
<span class="line">| innodb_file_per_table | ON    |</span>
<span class="line">+-----------------------+-------+</span>
</pre></td></tr></table></figure></p>
<p>在lyj数据库中创建一张表<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create table lyj_t1 </span>
<span class="line">  (col1 <span class="keyword">int</span> <span class="keyword">not</span> null auto_increment, </span>
<span class="line">   col2 varchar(<span class="number">7000</span>),</span>
<span class="line">   primary key (col1)</span>
<span class="line">  ) engine=innodb;</span>
<span class="line"><span class="comment"># 将col2字段设置为varchar(7000)，这样能保证一个页最多可以存放2条记录</span></span>
</pre></td></tr></table></figure></p>
<p>可通过以下命令查看表的创建信息<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show create table lyj_t1\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">       Table: lyj_t1</span>
<span class="line">Create Table: CREATE TABLE <span class="string">`lyj_t1`</span> (</span>
<span class="line">  <span class="string">`col1`</span> <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</span>
<span class="line">  <span class="string">`col2`</span> varchar(<span class="number">7000</span>) DEFAULT NULL,</span>
<span class="line">  PRIMARY KEY (<span class="string">`col1`</span>)</span>
<span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span>
</pre></td></tr></table></figure></p>
<h3 id="查验创建表时分配的初始大小为96k"><a href="#查验创建表时分配的初始大小为96K" class="headerlink" title="查验创建表时分配的初始大小为96K"></a>查验创建表时分配的初始大小为96K</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[mysql@mysql lyj]$ pwd</span>
<span class="line">/u01/my3306/data/lyj</span>
<span class="line">[mysql@mysql lyj]$ ll</span>
<span class="line">total <span class="number">112</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">61</span> Feb <span class="number">15</span> <span class="number">14</span>:<span class="number">20</span> db.opt</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">29070</span> Feb <span class="number">15</span> <span class="number">17</span>:<span class="number">07</span> lyj_t1.frm   <span class="comment"># frm 表定义</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">98304</span> Feb <span class="number">15</span> <span class="number">17</span>:<span class="number">07</span> lyj_t1.ibd   <span class="comment"># idb 数据和索引 创建初始分配大小是 98304/1024=96K</span></span>
</pre></td></tr></table></figure>
<h3 id="插入数据观察表空间大小变化"><a href="#插入数据观察表空间大小变化" class="headerlink" title="插入数据观察表空间大小变化"></a>插入数据观察表空间大小变化</h3><p>插入2条记录<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into lyj_t1 <span class="keyword">select</span> null, repeat(<span class="string">'a'</span>,<span class="number">7000</span>);</span>
<span class="line">insert into lyj_t1 <span class="keyword">select</span> null, repeat(<span class="string">'a'</span>,<span class="number">7000</span>);</span>
<span class="line"></span>
<span class="line"><span class="keyword">system</span> ls -lh /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">96</span>K Feb <span class="number">15</span> <span class="number">17</span>:<span class="number">16</span> /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这时可以通过py_innodb_page_info工具来查看表空间</span></span>
<span class="line"><span class="comment"># 根据之前对表的定义，插入的这两条记录应该位于同一个页中</span></span>
<span class="line"><span class="comment"># 所有记录都在一个页中，因此这时还没有非叶节点</span></span>
<span class="line">$ python py_innodb_page_info.py -v /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;File Space Header&gt;</span>
<span class="line">page offset <span class="number">00000001</span>, page type &lt;Insert Buffer Bitmap&gt;</span>
<span class="line">page offset <span class="number">00000002</span>, page type &lt;File Segment inode&gt;</span>
<span class="line">page offset <span class="number">00000003</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0000</span>&gt;  <span class="comment"># 这个就是数据页，page level表示所在层，0表示页子节点</span></span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;Freshly Allocated Page&gt;</span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;Freshly Allocated Page&gt;</span>
<span class="line">Total number of page: <span class="number">6</span>:</span>
<span class="line">Freshly Allocated Page: <span class="number">2</span></span>
<span class="line">Insert Buffer Bitmap: <span class="number">1</span></span>
<span class="line">File Space Header: <span class="number">1</span></span>
<span class="line">B-tree Node: <span class="number">1</span></span>
<span class="line">File Segment inode: <span class="number">1</span></span>
</pre></td></tr></table></figure></p>
<blockquote>
<p><code>py_innodb_page_info</code>工具下载地址：<a href="http://olg2mr2vf.bkt.clouddn.com/py_innodb_page_type.zip" target="_blank" rel="external">py_innodb_page_type.zip</a></p>
</blockquote>
<p>再插入1条记录<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into lyj_t1 <span class="keyword">select</span> null, repeat(<span class="string">'a'</span>,<span class="number">7000</span>);</span>
<span class="line"></span>
<span class="line">$ python py_innodb_page_info.py -v /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;File Space Header&gt;</span>
<span class="line">page offset <span class="number">00000001</span>, page type &lt;Insert Buffer Bitmap&gt;</span>
<span class="line">page offset <span class="number">00000002</span>, page type &lt;File Segment inode&gt;</span>
<span class="line">page offset <span class="number">00000003</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0001</span>&gt;</span>
<span class="line">page offset <span class="number">00000004</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0000</span>&gt;</span>
<span class="line">page offset <span class="number">00000005</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0000</span>&gt;</span>
<span class="line">Total number of page: <span class="number">6</span>:</span>
<span class="line">Insert Buffer Bitmap: <span class="number">1</span></span>
<span class="line">File Space Header: <span class="number">1</span></span>
<span class="line">B-tree Node: <span class="number">3</span></span>
<span class="line">File Segment inode: <span class="number">1</span></span>
</pre></td></tr></table></figure></p>
<p>创建批量插入数据的存储过程<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">drop procedure if exists load_t1;</span>
<span class="line">delimiter //</span>
<span class="line">create procedure load_t1(count int unsigned)</span>
<span class="line">begin</span>
<span class="line">  declare s int unsigned default 1;</span>
<span class="line">  declare c varchar(7000) default repeat('a', 7000);</span>
<span class="line">    while s&lt;= count do</span>
<span class="line">    insert into lyj_t1 select null,c;</span>
<span class="line">    set s=s+1;</span>
<span class="line">  end while;</span>
<span class="line">end;</span>
<span class="line">//</span>
<span class="line">delimiter;</span>
</pre></td></tr></table></figure></p>
<p>调用存储过程，插入60条记录后观察表空间大小<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; call load_t1(<span class="number">60</span>);</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> count(*) from lyj_t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">63</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">system</span> ls -lh /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">576</span>K Feb <span class="number">15</span> <span class="number">18</span>:<span class="number">10</span> /u01/my3306/data/lyj/lyj_t1.ibd</span>
</pre></td></tr></table></figure></p>
<p>再插入1条记录后观察表空间大小<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; call load_t1(<span class="number">1</span>);</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> count(*) from lyj_t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">64</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">system</span> ls -lh /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">2.0</span>M Feb <span class="number">15</span> <span class="number">18</span>:<span class="number">15</span> /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line"><span class="comment"># 因为已经用完了32个碎片页，新的页就会采用区的方式进行空间的申请</span></span>
</pre></td></tr></table></figure></p>
<h2 id="2-innodb数据块解析解析第2行记录格式"><a href="#2-Innodb数据块解析，解析第2行记录格式" class="headerlink" title="2. Innodb数据块解析，解析第2行记录格式"></a>2. Innodb数据块解析，解析第2行记录格式</h2><h3 id="创建测试表并插入数据"><a href="#创建测试表并插入数据" class="headerlink" title="创建测试表并插入数据"></a>创建测试表并插入数据</h3><p>创建测试用数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">drop database lyj;</span>
<span class="line">create database lyj DEFAULT CHARACTER SET gbk COLLATE gbk_chinese_ci;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看当前数据库中存在那些数据库，以及数据库创建信息</span></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| lyj                |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 显示数据库创建信息，若加\G参数是格式化输出信息</span></span>
<span class="line">show create database lyj;</span>
<span class="line">+----------+-------------------------------------------------------------+</span>
<span class="line">| Database | Create Database                                             |</span>
<span class="line">+----------+-------------------------------------------------------------+</span>
<span class="line">| lyj      | CREATE DATABASE <span class="string">`lyj`</span> /*!<span class="number">40100</span> DEFAULT CHARACTER SET gbk *<span class="regexp">/ |</span>
<span class="line">+----------+-------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line">show create database lyj\G</span>
<span class="line">*************************** 1. row ***************************</span>
<span class="line">       Database: lyj</span>
<span class="line">Create Database: CREATE DATABASE `lyj` /</span>*!<span class="number">40100</span> DEFAULT CHARACTER SET gbk *<span class="regexp">/</span></span>
</pre></td></tr></table></figure></p>
<p>使用lyj数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> lyj</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看当前选择的数据库</span></span>
<span class="line"><span class="keyword">select</span> database();</span>
<span class="line">+------------+</span>
<span class="line">| database() |</span>
<span class="line">+------------+</span>
<span class="line">| lyj        |</span>
<span class="line">+------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 若要删除数据库可使用以下命令</span></span>
<span class="line">drop database lyj;</span>
</pre></td></tr></table></figure></p>
<p>关闭自动提交<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%autocommit%'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| autocommit    | ON    |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">set autocommit = <span class="number">0</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%autocommit%'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| autocommit    | OFF   |</span>
<span class="line">+---------------+-------+</span>
</pre></td></tr></table></figure></p>
<p>在lyj数据库中创建表并插入测试数据<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create table lyj_t1 </span>
<span class="line">  (id <span class="keyword">int</span>,name1 varchar(<span class="number">10</span>),name2 varchar(<span class="number">10</span>),name3 varchar(<span class="number">10</span>),name4 varchar(<span class="number">10</span>),name5 varchar(<span class="number">10</span>));</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+---------------+</span>
<span class="line">| Tables_in_lyj |</span>
<span class="line">+---------------+</span>
<span class="line">| lyj_t1        |</span>
<span class="line">+---------------+</span>
<span class="line"></span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'A'</span>,<span class="string">'BB'</span>,<span class="string">'CCC'</span>,<span class="string">'DDDD'</span>,null);</span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,<span class="string">'ccccc'</span>,<span class="string">''</span>,null);</span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,<span class="string">'ccccc'</span>,<span class="string">'dddddd'</span>,<span class="string">'e'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,null,<span class="string">'dddddd'</span>,<span class="string">'e'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from lyj_t1;</span>
<span class="line">+------+------------+------------+-------+--------+-------+</span>
<span class="line">| id   | name1      | name2      | name3 | name4  | name5 |</span>
<span class="line">+------+------------+------------+-------+--------+-------+</span>
<span class="line">|    <span class="number">1</span> | A          | BB         | CCC   | DDDD   | NULL  |</span>
<span class="line">|    <span class="number">2</span> | aaaaaaaaaa | bbbbbbbbbb | ccccc |        | NULL  |</span>
<span class="line">|    <span class="number">3</span> | aaaaaaaaaa | bbbbbbbbbb | ccccc | dddddd | e     |</span>
<span class="line">|    <span class="number">4</span> | aaaaaaaaaa | bbbbbbbbbb | NULL  | dddddd | e     |</span>
<span class="line">+------+------------+------------+-------+--------+-------+</span>
</pre></td></tr></table></figure></p>
<h3 id="解析数据块"><a href="#解析数据块" class="headerlink" title="解析数据块"></a>解析数据块</h3><h4 id="使用hexdump工具导出表空间文件前4个块"><a href="#使用hexdump工具导出表空间文件前4个块" class="headerlink" title="使用hexdump工具导出表空间文件前4个块"></a>使用hexdump工具导出表空间文件前4个块</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 一个page 16k, 导出的16进制文件一行是16byte ==&gt; 1个page在16制文件中有1024 row，即一个块是1024行</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第1个块 File Space Header</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">1</span>.txt</span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第2个块 Insert Buffer Bitmap</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">2048</span> | tail -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">2</span>.txt</span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第3个块 File Segment inode</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">3072</span> | tail -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">3</span>.txt</span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第4个块 Used Page，也就是行记录开始处</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">4096</span> | tail -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">4</span>.txt</span>
</pre></td></tr></table></figure>
<p>使用sz工具下载到windows本地查看，需要先secureCRT会话设置里先设置本地下载路径<br><img src="http://oligvdnzp.bkt.clouddn.com/securecrt_01.png" alt="secureCRT中本地地址路径设置"></p>
<p>下载命令<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sz /tmp/<span class="number">1</span>.txt</span>
<span class="line">sz /tmp/<span class="number">2</span>.txt</span>
<span class="line">sz /tmp/<span class="number">3</span>.txt</span>
<span class="line">sz /tmp/<span class="number">4</span>.txt</span>
</pre></td></tr></table></figure></p>
<h4 id="查看导出块类型标识"><a href="#查看导出块类型标识" class="headerlink" title="查看导出块类型标识"></a>查看导出块类型标识</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_01.png" alt="第1个块 File Space Header    标识(偏移量19开始)：0x0008"> 第1个块类型标识：0x0008<br><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_02.png" alt="第2个块 Insert Buffer Bitmap 标识(偏移量19开始)：0x0005"> 第2个块类型标识：0x0005<br><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_03.png" alt="第3个块 File Segment inode   标识(偏移量19开始)：0x0003"> 第3个块类型标识：0x0003<br><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_04.png" alt="第4个块 Used Page            标识(偏移量19开始)：0x45BF"> 第4个块类型标识：0x45BF</p>
<h4 id="查看行记录格式"><a href="#查看行记录格式" class="headerlink" title="查看行记录格式"></a>查看行记录格式</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show table status like <span class="string">'%lyj_t1%'</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           Name: lyj_t1</span>
<span class="line">         Engine: InnoDB</span>
<span class="line">        Version: <span class="number">10</span></span>
<span class="line">     Row_format: Compact       <span class="comment"># 行的格式是Compact（简洁的）</span></span>
<span class="line">           Rows: <span class="number">4</span></span>
<span class="line"> Avg_row_length: <span class="number">4096</span></span>
<span class="line">    Data_length: <span class="number">16384</span></span>
<span class="line">Max_data_length: <span class="number">0</span></span>
<span class="line">   Index_length: <span class="number">0</span></span>
<span class="line">      Data_free: <span class="number">0</span></span>
<span class="line"> Auto_increment: NULL</span>
<span class="line">    Create_time: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">16</span> <span class="number">10</span>:<span class="number">20</span>:<span class="number">15</span></span>
<span class="line">    Update_time: NULL</span>
<span class="line">     Check_time: NULL</span>
<span class="line">      Collation: gbk_chinese_ci</span>
<span class="line">       Checksum: NULL</span>
<span class="line"> Create_options: </span>
<span class="line">        Comment:</span>
</pre></td></tr></table></figure>
<h4 id="compact行记录结构"><a href="#Compact行记录结构" class="headerlink" title="Compact行记录结构"></a>Compact行记录结构</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/compact.png" alt="Compact行记录结构"></p>
<h4 id="解析块头"><a href="#解析块头" class="headerlink" title="解析块头"></a>解析块头</h4><p>记录是放在第4个块中，下面详细解析<code>/tmp/4.txt</code>文件<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1    0000c000  51 07 91 31 00 00 00 03  ff ff ff ff ff ff ff ff  |Q..1............|</span>
<span class="line">2    0000c010  00 00 00 00 00 2b d4 0d  45 bf 00 00 00 00 00 00  |.....+..E.......|</span>
<span class="line">3    0000c020  00 00 00 00 00 13 00 02  01 5b 80 06 00 00 00 00  |.........[......|</span>
<span class="line">4    0000c030  01 29 00 02 00 03 00 04  00 00 00 00 00 00 00 00  |.)..............|</span>
<span class="line">5    0000c040  00 00 00 00 00 00 00 00  00 24 00 00 00 13 00 00  |.........$......|</span>
<span class="line">6    0000c050  00 02 00 f2 00 00 00 13  00 00 00 02 00 32 01 00  |.............2..|</span>
<span class="line">7    0000c060  02 00 1f 69 6e 66 69 6d  75 6d 00 05 00 0b 00 00  |...infimum......|</span>
<span class="line">8    0000c070  73 75 70 72 65 6d 75 6d  04 03 02 01 20 00 00 10  |supremum.... ...|</span>
<span class="line">9    0000c080  00 2b 00 00 00 00 02 0a  00 00 00 00 0e 56 95 00  |.+...........V..|</span>
<span class="line">10   0000c090  00 01 42 01 10 80 00 00  01 41 42 42 43 43 43 44  |..B......ABBCCCD|</span>
<span class="line">11   0000c0a0  44 44 44 00 05 0a 0a 20  00 00 18 00 3b 00 00 00  |DDD.... ....;...|</span>
<span class="line">12   0000c0b0  00 02 0b 00 00 00 00 0e  56 95 00 00 01 42 01 1e  |........V....B..|</span>
<span class="line">13   0000c0c0  80 00 00 02 61 61 61 61  61 61 61 61 61 61 62 62  |....aaaaaaaaaabb|</span>
<span class="line">14   0000c0d0  62 62 62 62 62 62 62 62  63 63 63 63 63 01 06 05  |bbbbbbbbccccc...|</span>
<span class="line">15   0000c0e0  0a 0a 00 00 00 20 00 41  00 00 00 00 02 0c 00 00  |..... .A........|</span>
<span class="line">16   0000c0f0  00 00 0e 56 95 00 00 01  42 01 2c 80 00 00 03 61  |...V....B.,....a|</span>
<span class="line">17   0000c100  61 61 61 61 61 61 61 61  61 62 62 62 62 62 62 62  |aaaaaaaaabbbbbbb|</span>
<span class="line">18   0000c110  62 62 62 63 63 63 63 63  64 64 64 64 64 64 65 01  |bbbcccccdddddde.|</span>
<span class="line">19   0000c120  06 0a 0a 08 00 00 28 ff  47 00 00 00 00 02 0d 00  |......(.G.......|</span>
<span class="line">20   0000c130  00 00 00 0e 5e 98 00 00  01 45 01 10 80 00 00 04  |....^....E......|</span>
<span class="line">21   0000c140  61 61 61 61 61 61 61 61  61 61 62 62 62 62 62 62  |aaaaaaaaaabbbbbb|</span>
<span class="line">22   0000c150  62 62 62 62 64 64 64 64  64 64 65 00 00 00 00 00  |bbbbdddddde.....|</span>
<span class="line">     ......</span>
<span class="line">1024 0000fff0  00 00 00 00 00 70 00 63  f2 c3 5d 27 00 2b d4 0d  |.....p.c..]&apos;.+..|</span>
</pre></td></tr></table></figure></p>
<ul>
<li>第1行中的<code>51 07 91 31</code>和最后一行的<code>f2 c3 5d 27</code>是checksum，调用mysql中的一个校验函数，若检验不一致判断该块有问题</li>
<li>第1行中的<code>00 00 00 03</code>，代表这是第几个page(0开始)，这里代表是第4个page</li>
<li>第1行中的<code>ff ff ff ff ff ff ff ff</code>中前4个字节代表记录上一页指针地址，后4个字节代表记录下一页指针地址，全是<code>f</code>代表上一页和下一页无记录</li>
<li>第2行中的<code>00 00 00 00 00 2b d4 0d</code>是日志地址，LSN(Log Segment Number)，其中后4个字节和块最后一行后4个字节<code>00 2b d4 0d</code>是一致的</li>
<li>第2行中的<code>45 bf</code>代表页（块）的类型</li>
<li>第3行中的<code>00 00 00 13</code>代表tablespace的编号</li>
<li>第3行中的<code>00 02</code>代表有两个slot，对应块最后一行尾部的<code>00 70 00 63</code>，每2个字节代表一个slot</li>
<li>第3行中的<code>01 5b</code>代表该页下一行的空闲开始位置，也就是<code>0000c15b</code></li>
<li>第3行中的<code>80 06</code>能算出块中有几行记录，compact中该值初始是8002，8006-8002=4，代表该页有4行记录</li>
<li>第3行中的<code>00 00 00 00</code>代表可重用字节，这里没有删除过记录，值都是0</li>
<li>第4行中的<code>01 29</code>代表最后一行记录的开始位置，也就是该块中第4行记录的开始位置</li>
<li>第4行中的<code>00 02 00 03</code>其中<code>00 02</code>为往右插，<code>00 03</code>为连续插入3次</li>
<li>第4行中的<code>00 04</code>代表有4行记录</li>
<li>第4行中的<code>00 00 00 00 00 00 00 00</code>代表页上最大事务数</li>
<li>第5行中的<code>00 00</code>代表page level <0000>，也就是叶子节点</0000></li>
<li>第5行中的<code>00 00 00 00 00 00 00 24</code>代表索引的ID</li>
<li>第5-6行中的<code>00 00 00 13 00 00 00 02 00 f2</code> 代表段头管理非叶节点的</li>
<li>第6行中的<code>00 00 00 13  00 00 00 02 00 32</code> 代表段头管理叶节点的</li>
<li>第6-7行中的<code>01 00 02 00 1f</code>代表最小虚拟值的行头，固定的5个节点</li>
<li>第7行中的<code>69 6e 66 69 6d 75 6d 00</code>代表的就是infimum，8个字节，后面的<code>00</code>占位</li>
<li>第7行中的<code>05 00 0b 00 00</code>代表最大虚拟值的行头，固定的5个节点</li>
<li>第8行中的<code>73 75 70 72 65 6d 75 6d</code>代表的就是supremum，8个字节</li>
</ul>
<h4 id="解析第1行记录"><a href="#解析第1行记录" class="headerlink" title="解析第1行记录"></a>解析第1行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">8    0000c070  73 75 70 72 65 6d 75 6d  04 03 02 01 20 00 00 10  |supremum.... ...|</span>
<span class="line">9    0000c080  00 2b 00 00 00 00 02 0a  00 00 00 00 0e 56 95 00  |.+...........V..|</span>
<span class="line">10   0000c090  00 01 42 01 10 80 00 00  01 41 42 42 43 43 43 44  |..B......ABBCCCD|</span>
<span class="line">11   0000c0a0  44 44 44 00 05 0a 0a 20  00 00 18 00 3b 00 00 00  |DDD.... ....;...|</span>
</pre></td></tr></table></figure>
<ul>
<li>第8行中的<code>04 03 02 01</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，有NULL数据</li>
<li>第8行中的<code>20</code>代表null标志位，第1行记录有null值，十六进制<code>20</code>转成二进制是100000，逆序，表中一共6列，1表示第6列为null，0表示其他列有值</li>
<li>第8-9行中的<code>00 00 10 00 2b</code> 是记录头信息，固定5个字节  c078(本行记录开位置)+2b(偏移量)=c0a3(下一行记录开始位置)</li>
<li>第9行中的<code>00 00 00 00 02 0a</code> 是RowID，固定6个字节，表没有主键</li>
<li>第9行中的<code>00 00 00 00 0e 56</code> 是事务ID，固定6个字节</li>
<li>第9-10行中的<code>95 00 00 01 42 01 10</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第10行中的<code>80 00 00 01</code> 是ID列int 占4字节 值是1</li>
<li>第10-11行的<code>41 42 42 43 43 43 44 44 44 44</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 41</li>
<li>第3列 42 42 </li>
<li>第4列 43 43 43 </li>
<li>第5列 44 44 44 44</li>
<li>第6列 null</li>
</ul>
</li>
</ul>
<h4 id="解析第2行记录"><a href="#解析第2行记录" class="headerlink" title="解析第2行记录"></a>解析第2行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">11   0000c0a0  44 44 44 00 05 0a 0a 20  00 00 18 00 3b 00 00 00  |DDD.... ....;...|</span>
<span class="line">12   0000c0b0  00 02 0b 00 00 00 00 0e  56 95 00 00 01 42 01 1e  |........V....B..|</span>
<span class="line">13   0000c0c0  80 00 00 02 61 61 61 61  61 61 61 61 61 61 62 62  |....aaaaaaaaaabb|</span>
<span class="line">14   0000c0d0  62 62 62 62 62 62 62 62  63 63 63 63 63 01 06 05  |bbbbbbbbccccc...|</span>
</pre></td></tr></table></figure>
<p>从第1行记录解析中，已可算出，第二行开始位置为c0a3</p>
<ul>
<li>第11行中的<code>00 05 0a 0a</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，有NULL数据</li>
<li>第11行中的<code>20</code>代表null标志位，第2行记录有null值，十六进制<code>20</code>转成二进制是100000，逆序，表中一共6列，1表示第6列为null，0表示其他列有值</li>
<li>第11行中的<code>00 00 18 00 3b</code> 是记录头信息，固定5个字节   c0a3(本行记录开位置)+3b(偏移量)=c0de(下一行记录开始位置)</li>
<li>第11-12行中的<code>00 00 00 00 02 0b</code> 是RowID，固定6个字节，表没有主键</li>
<li>第12行中的<code>00 00 00 00 0e 56</code> 是事务ID，固定6个字节</li>
<li>第12中的<code>95 00 00 01 42 01 1e</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第13行中的<code>80 00 00 02</code> 是ID列int 占4字节 值是2</li>
<li>第13-14行的<code>61 61 61 61 61 61 61 61 61 61 62 62 62 62 62 62 62 62 62 62 63 63 63 63 63</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 61 61 61 61 61 61 61 61 61 61</li>
<li>第3列 62 62 62 62 62 62 62 62 62 62 </li>
<li>第4列 63 63 63 63 63</li>
<li>第5列 空值</li>
<li>第6列 null</li>
</ul>
</li>
</ul>
<h4 id="解析第3行记录"><a href="#解析第3行记录" class="headerlink" title="解析第3行记录"></a>解析第3行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">14   0000c0d0  62 62 62 62 62 62 62 62  63 63 63 63 63 01 06 05  |bbbbbbbbccccc...|</span>
<span class="line">15   0000c0e0  0a 0a 00 00 00 20 00 41  00 00 00 00 02 0c 00 00  |..... .A........|</span>
<span class="line">16   0000c0f0  00 00 0e 56 95 00 00 01  42 01 2c 80 00 00 03 61  |...V....B.,....a|</span>
<span class="line">17   0000c100  61 61 61 61 61 61 61 61  61 62 62 62 62 62 62 62  |aaaaaaaaabbbbbbb|</span>
<span class="line">18   0000c110  62 62 62 63 63 63 63 63  64 64 64 64 64 64 65 01  |bbbcccccdddddde.|</span>
</pre></td></tr></table></figure>
<ul>
<li>第14-15行中的<code>01 06 05 0a 0a</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，没有NULL数据</li>
<li>第15行中的<code>00</code>代表null标志位，00表示没有null值</li>
<li>第15行中的<code>00 00 20 00 41</code> 是记录头信息，固定5个字节</li>
<li>第15行中的<code>00 00 00 00 02 0c</code> 是RowID，固定6个字节，表没有主键</li>
<li>第15-16行中的<code>00 00 00 00 0e 56</code> 是事务ID，固定6个字节</li>
<li>第16中的<code>95 00 00 01 42 01 2c</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第16行中的<code>80 00 00 03</code> 是ID列int 占4字节 值是3</li>
<li>第16-18行的<code>61 61 61 61 61 61 61 61 61 61 62 62 62 62 62 62 62 62 62 62 63 63 63 63 63 64 64 64 64 64 64 65</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 61 61 61 61 61 61 61 61 61 61</li>
<li>第3列 62 62 62 62 62 62 62 62 62 62 </li>
<li>第4列 63 63 63 63 63</li>
<li>第5列 64 64 64 64 64 64</li>
<li>第6列 65</li>
</ul>
</li>
</ul>
<h4 id="解析第4行记录"><a href="#解析第4行记录" class="headerlink" title="解析第4行记录"></a>解析第4行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">18   0000c110  62 62 62 63 63 63 63 63  64 64 64 64 64 64 65 01  |bbbcccccdddddde.|</span>
<span class="line">19   0000c120  06 0a 0a 08 00 00 28 ff  47 00 00 00 00 02 0d 00  |......(.G.......|</span>
<span class="line">20   0000c130  00 00 00 0e 5e 98 00 00  01 45 01 10 80 00 00 04  |....^....E......|</span>
<span class="line">21   0000c140  61 61 61 61 61 61 61 61  61 61 62 62 62 62 62 62  |aaaaaaaaaabbbbbb|</span>
<span class="line">22   0000c150  62 62 62 62 64 64 64 64  64 64 65 00 00 00 00 00  |bbbbdddddde.....|</span>
</pre></td></tr></table></figure>
<ul>
<li>第18-19行中的<code>01 06 0a 0a</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，有NULL数据</li>
<li>第19行中的<code>08</code>代表null标志位，十六进制<code>08</code>转成二进制是001000，逆序，表中一共6列，1表示第4列为null，0表示其他列有值</li>
<li>第19行中的<code>00 00 28 ff 47</code> 是记录头信息，固定5个字节</li>
<li>第19行中的<code>00 00 00 00 02 0d</code> 是RowID，固定6个字节，表没有主键</li>
<li>第19-20行中的<code>00 00 00 00 0e 5e</code> 是事务ID，固定6个字节，这里事务ID已经变化</li>
<li>第20中的<code>98 00 00  01 45 01 10</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第20行中的<code>80 00 00 04</code> 是ID列int 占4字节 值是4</li>
<li>第16-18行的<code>61 61 61 61 61 61 61 61  61 61 62 62 62 62 62 62 62 62 62 62 64 64 64 64  64 64 65</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 61 61 61 61 61 61 61 61 61 61</li>
<li>第3列 62 62 62 62 62 62 62 62 62 62 </li>
<li>第4列 NULL</li>
<li>第5列 64 64 64 64 64 64</li>
<li>第5列 65</li>
</ul>
</li>
</ul>
<h2 id="3详细描述commit命令发出后binlog日志从内存写到磁盘的过程"><a href="#3-详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？" class="headerlink" title="3.详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？"></a>3.详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？</h2><h3 id="重启数据库"><a href="#重启数据库" class="headerlink" title="重启数据库"></a>重启数据库</h3><p>重启数据库生成新的binlog，便于观察测试<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysqladmin <span class="keyword">shutdown</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf &amp;</span>
<span class="line"></span>
<span class="line">[mysql@mysql binlog]$ pwd</span>
<span class="line">/u01/my3306/<span class="keyword">log</span>/binlog</span>
<span class="line">[mysql@mysql binlog]$ ll</span>
<span class="line">total <span class="number">928</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">933537</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">38</span> binlog.<span class="number">000007</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">391</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">54</span> binlog.<span class="number">00000</span>8</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">120</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">54</span> binlog.<span class="number">00000</span>9</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">111</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">54</span> binlog.index</span>
</pre></td></tr></table></figure></p>
<h3 id="用一个update事务做测试"><a href="#用一个update事务做测试" class="headerlink" title="用一个update事务做测试"></a>用一个update事务做测试</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> lyj;</span>
<span class="line">begin;</span>
<span class="line">update lyj_t1 set name1=<span class="string">'aaaaaaa'</span> where id=<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h3 id="查看binlog"><a href="#查看binlog" class="headerlink" title="查看binlog"></a>查看binlog</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 未commit前</span></span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| Log_name      | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| binlog.<span class="number">00000</span>9 |   <span class="number">4</span> | Format_desc |       <span class="number">101</span> |         <span class="number">120</span> | Server ver: <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>, Binlog ver: <span class="number">4</span> |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># commit后</span></span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">show binlog events in <span class="string">'binlog.000009'</span>;</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| Log_name      | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| binlog.<span class="number">00000</span>9 |   <span class="number">4</span> | Format_desc |       <span class="number">101</span> |         <span class="number">120</span> | Server ver: <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>, Binlog ver: <span class="number">4</span> |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">120</span> | Query       |       <span class="number">101</span> |         <span class="number">191</span> | BEGIN                                 |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">191</span> | Table_map   |       <span class="number">101</span> |         <span class="number">254</span> | table_id: <span class="number">70</span> (lyj.lyj_t1)             |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">254</span> | Update_rows |       <span class="number">101</span> |         <span class="number">339</span> | table_id: <span class="number">70</span> flags: STMT_END_F        |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">339</span> | Xid         |       <span class="number">101</span> |         <span class="number">370</span> | COMMIT /* xid=<span class="number">9</span> *<span class="regexp">/                    |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line"></span>
<span class="line"># 也可用以下命令查看</span>
<span class="line">mysqlbinlog -v -v binlog.000009</span></span>
</pre></td></tr></table></figure>
<h3 id="binlog日志生成的流程"><a href="#Binlog日志生成的流程" class="headerlink" title="Binlog日志生成的流程"></a>Binlog日志生成的流程</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/0217_binlog_01.png" alt="Binlog日志生成的流程"></p>
<ol>
<li>事务commit后，日志会被write到标准I/O cache里面，每个线程是单独缓存的，线程间的日志彼此独立，不能看到不同线程的日志，这时若发生crash，日志会丢失</li>
<li>write后，每个线程的日志会flush到OS file cache里，这时日志是全局可见的，每个线程都能看到这个日志，若此时crash，日志也会丢失</li>
<li>sync操作会从日志内存里把日志写到disk中，达到持久化。</li>
</ol>
<h3 id="相关的参数"><a href="#相关的参数" class="headerlink" title="相关的参数"></a>相关的参数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'sync_binlog'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| sync_binlog   | <span class="number">100</span>   |    <span class="comment"># 代表做100次commit再写binlog，一般设置成1，保证数据的一致性</span></span>
<span class="line">+---------------+-------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show variables like <span class="string">'innodb_flush_log_at_trx_commit'</span>;</span>
<span class="line">+--------------------------------+-------+</span>
<span class="line">| Variable_name                  | Value |</span>
<span class="line">+--------------------------------+-------+</span>
<span class="line">| innodb_flush_log_at_trx_commit | <span class="number">1</span>     |   <span class="comment"># 一般设置成1，保证数据的一致性</span></span>
<span class="line">+--------------------------------+-------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">01</span> sec)</span>
</pre></td></tr></table></figure>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="查看innodb默认块的大小"><a href="#查看innodb默认块的大小" class="headerlink" title="查看innodb默认块的大小"></a>查看innodb默认块的大小</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%innodb_page_size%'</span>;</span>
<span class="line">+------------------+-------+</span>
<span class="line">| Variable_name    | Value |</span>
<span class="line">+------------------+-------+</span>
<span class="line">| innodb_page_size | <span class="number">16384</span> |</span>
<span class="line">+------------------+-------+</span>
</pre></td></tr></table></figure>
<h3 id="查看文件格式"><a href="#查看文件格式" class="headerlink" title="查看文件格式"></a>查看文件格式</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%file_format%'</span>;</span>
<span class="line">+--------------------------+-----------+</span>
<span class="line">| Variable_name            | Value     |</span>
<span class="line">+--------------------------+-----------+</span>
<span class="line">| innodb_file_format       | Barracuda |    <span class="comment"># Barracuda[,bærə''kudə] 梭鱼类</span></span>
<span class="line">| innodb_file_format_check | ON        |</span>
<span class="line">| innodb_file_format_max   | Antelope  |    <span class="comment"># Antelope['æntɪlop] 羚羊 </span></span>
<span class="line">+--------------------------+-----------+</span>
</pre></td></tr></table></figure>
<p>从下图可以看出<code>Antelope</code>只包括<code>Redundant</code>（已废弃）和<code>Compact</code>，故建议将<code>innodb_file_format_max</code>也设置为<code>Barracuda</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0216_file_format.png" alt="innodb文件格式"></p>
<h3 id="查看tablespace编号"><a href="#查看tablespace编号" class="headerlink" title="查看tablespace编号"></a>查看tablespace编号</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.innodb_sys_tables where name like <span class="string">'%lyj_t1%'</span>;</span>
<span class="line">+----------+----------------------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">| TABLE_ID | NAME                       | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE |</span>
<span class="line">+----------+----------------------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">|       <span class="number">14</span> | SYS_DATAFILES              |    <span class="number">0</span> |      <span class="number">5</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">11</span> | SYS_FOREIGN                |    <span class="number">0</span> |      <span class="number">7</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">12</span> | SYS_FOREIGN_COLS           |    <span class="number">0</span> |      <span class="number">7</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">13</span> | SYS_TABLESPACES            |    <span class="number">0</span> |      <span class="number">6</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">27</span> | lyj/lyj_t1                 |    <span class="number">1</span> |      <span class="number">5</span> |    <span class="number">13</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">16</span> | mysql/innodb_index_stats   |    <span class="number">1</span> |     <span class="number">11</span> |     <span class="number">2</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">15</span> | mysql/innodb_table_stats   |    <span class="number">1</span> |      <span class="number">9</span> |     <span class="number">1</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">18</span> | mysql/slave_master_info    |    <span class="number">1</span> |     <span class="number">26</span> |     <span class="number">4</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">17</span> | mysql/slave_relay_log_info |    <span class="number">1</span> |     <span class="number">11</span> |     <span class="number">3</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">19</span> | mysql/slave_worker_info    |    <span class="number">1</span> |     <span class="number">15</span> |     <span class="number">5</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">+----------+----------------------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.innodb_sys_tables where name like <span class="string">'%lyj_t1%'</span>;</span>
<span class="line">+----------+------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">| TABLE_ID | NAME       | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE |</span>
<span class="line">+----------+------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">|       <span class="number">30</span> | lyj/lyj_t1 |    <span class="number">1</span> |      <span class="number">5</span> |    <span class="number">16</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">+----------+------------+------+--------+-------+-------------+------------+---------------+</span>
</pre></td></tr></table></figure>
<h3 id="查看未提交事务id"><a href="#查看未提交事务ID" class="headerlink" title="查看未提交事务ID"></a>查看未提交事务ID</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set autocommit = <span class="number">0</span>;</span>
<span class="line"></span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,<span class="string">'ccccc'</span>,<span class="string">'dddddd'</span>,<span class="string">'e'</span>);</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_sys_idx\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                    trx_id: <span class="number">3694</span></span>
<span class="line">                 trx_state: RUNNING</span>
<span class="line">               trx_started: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">42</span>:<span class="number">41</span></span>
<span class="line">     trx_requested_lock_id: NULL</span>
<span class="line">          trx_wait_started: NULL</span>
<span class="line">                trx_weight: <span class="number">2</span></span>
<span class="line">       trx_mysql_thread_id: <span class="number">23</span></span>
<span class="line">                 trx_query: <span class="keyword">select</span> * from information_schema.innodb_trx</span>
<span class="line">       trx_operation_state: NULL</span>
<span class="line">         trx_tables_in_use: <span class="number">0</span></span>
<span class="line">         trx_tables_locked: <span class="number">0</span></span>
<span class="line">          trx_lock_structs: <span class="number">1</span></span>
<span class="line">     trx_lock_memory_bytes: <span class="number">360</span></span>
<span class="line">           trx_rows_locked: <span class="number">0</span></span>
<span class="line">         trx_rows_modified: <span class="number">1</span></span>
<span class="line">   trx_concurrency_tickets: <span class="number">0</span></span>
<span class="line">       trx_isolation_level: REPEATABLE READ</span>
<span class="line">         trx_unique_checks: <span class="number">1</span></span>
<span class="line">    trx_foreign_key_checks: <span class="number">1</span></span>
<span class="line">trx_last_foreign_key_error: NULL</span>
<span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span>
<span class="line"> trx_adaptive_hash_timeout: <span class="number">10000</span></span>
<span class="line">          trx_is_read_only: <span class="number">0</span></span>
<span class="line">trx_autocommit_non_locking: <span class="number">0</span></span>
<span class="line"></span>
<span class="line">rollback;</span>
</pre></td></tr></table></figure>
<h3 id="转换成16进制函数"><a href="#转换成16进制函数" class="headerlink" title="转换成16进制函数"></a>转换成16进制函数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">hex</span>(<span class="string">'infimum'</span>);</span>
<span class="line">+----------------+</span>
<span class="line">| <span class="keyword">hex</span>(<span class="string">'infimum'</span>) |</span>
<span class="line">+----------------+</span>
<span class="line">| <span class="number">696</span>E66696D756D |</span>
<span class="line">+----------------+</span>
</pre></td></tr></table></figure>
<h3 id="文件结构图"><a href="#文件结构图" class="headerlink" title="文件结构图"></a>文件结构图</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/innodb_file_s.png" alt="文件结构"></p>
<h3 id="page结构图"><a href="#Page结构图" class="headerlink" title="Page结构图"></a>Page结构图</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/innodb_page_s.png" alt="Page结构"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hexo博客添加常用插件]]></title>
      <url>/2017/02/08/tools/hexo%E5%8D%9A%E5%AE%A2%E6%B7%BB%E5%8A%A0%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6/</url>
      <content type="html"><![CDATA[<p>Hexo提供了诸多插件来增强博客体验，地址<a href="http://hexo.io/plugins/" target="_blank" rel="external"><code>http://hexo.io/plugins</code></a></p>
<h2 id="添加pdf浏览插件"><a href="#添加pdf浏览插件" class="headerlink" title="添加pdf浏览插件"></a>添加pdf浏览插件</h2><h3 id="安装hexo-pdf"><a href="#安装hexo-pdf" class="headerlink" title="安装hexo-pdf"></a>安装<a href="https://github.com/superalsrk/hexo-pdf" target="_blank" rel="external">hexo-pdf</a></h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cnpm install --save hexo-pdf</span>
</pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">&#123;% pdf http:<span class="regexp">//</span><span class="number">7</span>xov2f.com1.z<span class="number">0</span>.glb.clouddn.com/bash_freshman.pdf %&#125;</span>
<span class="line">&#123;% pdf ./bash_freshman.pdf %&#125;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="添加生成文章目录插件hexo-toc"><a href="#添加生成文章目录插件hexo-toc" class="headerlink" title="添加生成文章目录插件hexo-toc"></a>添加生成文章目录插件hexo-toc</h2><ol>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-toc --save</span>
</pre></td></tr></table></figure>
</li>
<li><p>配置<br>在博客根目录下的<code>_config.yml</code>中如下配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">toc:</span>
<span class="line">  maxdepth: 3</span>
</pre></td></tr></table></figure>
</li>
<li><p>使用<br>在Markdown中需要显示文章目录的地方添加 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- toc --&gt;</span>
</pre></td></tr></table></figure>
</li>
</ol>
<h2 id="添加百度统计支持"><a href="#添加百度统计支持" class="headerlink" title="添加百度统计支持"></a>添加百度统计支持</h2><p><code>yilia</code>主题自带统计支持</p>
<ol>
<li><p>打开<a href="http://tongji.baidu.com/web/welcome/login" target="_blank" rel="external">百度统计</a>网站，注册账号<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_01.png" alt="baidu_stat_01.png"></p>
</li>
<li><p>填写注册信息<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_02.png" alt="baidu_stat_02.png"></p>
</li>
<li><p>记录百度统计ID号码<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_03.png" alt="baidu_stat_03.png"></p>
</li>
<li><p>编辑修改<code>themes\yilia</code>目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Miscellaneous</span></span>
<span class="line">baidu_analytics: <span class="string">'xxxxxxxxxxxx'</span>   <span class="comment"># xxxxxx是刚获得的百度统计ID号码</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>统计代码安装检查，确保代码安装正确<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_04.png" alt="baidu_stat_04.png"></p>
</li>
</ol>
<h2 id="添加多说评论支持"><a href="#添加多说评论支持" class="headerlink" title="添加多说评论支持"></a>添加多说评论支持</h2><ol>
<li><p>打开<a href="http://duoshuo.com/" target="_blank" rel="external">多说</a>网站<br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_01.png" alt="duoshuo_01.png"></p>
</li>
<li><p>选择微信登陆<br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_02.png" alt="duoshuo_02.png"></p>
</li>
<li><p>点击<code>我要安装</code><br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_03.png" alt="duoshuo_03.png"></p>
</li>
<li><p>填写相应信息<br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_04.png" alt="duoshuo_04.png"></p>
</li>
<li><p>编辑修改<code>themes\yilia</code>目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#是否开启多说评论，开启填写你在多说申请的项目的short_name: dbanote</span></span>
<span class="line"><span class="comment">#duoshuo: false</span></span>
<span class="line">duoshuo: dbanote</span>
</pre></td></tr></table></figure>
</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://www.ituring.com.cn/article/199624" target="_blank" rel="external">Hexo站点中添加文章目录以及归档</a></li>
<li><a href="http://www.cnblogs.com/peihao/p/5269131.html" target="_blank" rel="external">hexo优化目录</a></li>
</ul>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hexo更换主题并个性化定制]]></title>
      <url>/2017/02/08/tools/hexo%E6%9B%B4%E6%8D%A2%E4%B8%BB%E9%A2%98%E5%B9%B6%E4%B8%AA%E6%80%A7%E5%8C%96%E5%AE%9A%E5%88%B6/</url>
      <content type="html"><![CDATA[<blockquote>
<p>hexo系统默认的主题虽然也不错，但我更喜欢<a href="http://moxfive.xyz/yelee" target="_blank" rel="external">yelee</a>和<a href="https://github.com/litten/hexo-theme-yilia" target="_blank" rel="external">yilia</a>这两款主题</p>
</blockquote>
<h2 id="安装yelee主题"><a href="#安装yelee主题" class="headerlink" title="安装yelee主题"></a>安装yelee主题</h2><ol>
<li><p>主题说明文档：<a href="http://moxfive.coding.me/yelee" target="_blank" rel="external"><code>http://moxfive.coding.me/yelee/</code></a></p>
</li>
<li><p>在博客根目录下执行以下命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 克隆最新一次提交（git clone速度很慢，可只克隆最新一次提交）</span></span>
<span class="line">git clone --depth <span class="number">1</span> https:<span class="regexp">//github</span>.com/MOxFIVE/hexo-theme-yelee.git themes/yelee</span>
</pre></td></tr></table></figure>
</li>
<li><p>编辑修改根目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># theme: landscape</span></span>
<span class="line">theme: yelee</span>
</pre></td></tr></table></figure>
</li>
<li><p>更换主题后需要清理并重新生成静态页</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span>
</pre></td></tr></table></figure>
</li>
<li><p>安装搜索插件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-generator-search --save</span>
</pre></td></tr></table></figure>
</li>
<li><p>参照文档修改<code>themes\yelee</code>目录下的<code>_config.yml</code>文件</p>
</li>
</ol>
<a id="more"></a>
<h2 id="安装yilia主题"><a href="#安装yilia主题" class="headerlink" title="安装yilia主题"></a>安装yilia主题</h2><ol>
<li><p>在博客根目录下执行以下命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">git clone https:<span class="regexp">//github</span>.com/litten/hexo-theme-yilia.git themes/yilia</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">git clone git@github.com:litten/hexo-theme-yilia.git themes/yilia</span>
<span class="line"></span>
<span class="line"><span class="comment"># 克隆最新一次提交（git clone速度很慢，可只克隆最新一次提交）</span></span>
<span class="line">git clone --depth <span class="number">1</span> https:<span class="regexp">//github</span>.com/litten/hexo-theme-yilia.git themes/yilia</span>
</pre></td></tr></table></figure>
</li>
<li><p>在博客根目录（注意不是yilia根目录）执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm i hexo-generator-json-content --save</span>
</pre></td></tr></table></figure>
</li>
<li><p>编辑修改根目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># theme: landscape</span></span>
<span class="line">theme: yilia</span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加以下内容</span></span>
<span class="line"><span class="comment"># jsonContent</span></span>
<span class="line">jsonContent:</span>
<span class="line">    meta: false</span>
<span class="line">    pages: false</span>
<span class="line">    posts:</span>
<span class="line">      title: true</span>
<span class="line">      date: true</span>
<span class="line">      path: true</span>
<span class="line">      text: true</span>
<span class="line">      raw: false</span>
<span class="line">      content: false</span>
<span class="line">      slug: false</span>
<span class="line">      updated: false</span>
<span class="line">      comments: false</span>
<span class="line">      <span class="keyword">link</span>: false</span>
<span class="line">      permalink: false</span>
<span class="line">      excerpt: false</span>
<span class="line">      categories: false</span>
<span class="line">      tags: true</span>
</pre></td></tr></table></figure>
</li>
<li><p>更换主题后需要清理并重新生成静态页</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean</span>
<span class="line">hexo g</span>
<span class="line">hexo s</span>
</pre></td></tr></table></figure>
</li>
<li><p>更换后效果<br><img src="http://oligvdnzp.bkt.clouddn.com/update_theme.png" alt="update_theme.png"></p>
</li>
<li><p>编辑修改<code>themes\yilia</code>目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改menu</span></span>
<span class="line">menu:</span>
<span class="line">  主页: <span class="regexp">/</span>
<span class="line">  归档: /archives</span><span class="regexp">/</span>
<span class="line">  #随笔: /tags</span><span class="regexp">/随笔/</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改并注释掉不需要的项</span></span>
<span class="line"><span class="comment"># SubNav</span></span>
<span class="line">subnav:</span>
<span class="line">  github: <span class="string">"https://github.com/dbanote"</span></span>
<span class="line">  weibo: <span class="string">"http://weibo.com/foxbei"</span></span>
<span class="line">  <span class="comment">#rss: "#"</span></span>
<span class="line">  <span class="comment">#zhihu: "#"</span></span>
<span class="line">  qq: <span class="string">"http://sighttp.qq.com/msgrd?v=1&amp;uin=9320802"</span></span>
<span class="line">  <span class="comment">#weixin: "#"</span></span>
<span class="line">  <span class="comment">#jianshu: "#"</span></span>
<span class="line">  <span class="comment">#douban: "#"</span></span>
<span class="line">  mail: <span class="string">"mailto:15004618839@139.com"</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 文章太长，截断按钮文字</span></span>
<span class="line"><span class="comment"># 截断需要在文章中添加 &lt;!--more--&gt;</span></span>
<span class="line"><span class="comment">#excerpt_link: more</span></span>
<span class="line">excerpt_link: false</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置打赏二维码</span></span>
<span class="line"><span class="comment"># 打赏基础设定：0-关闭打赏； 1-文章对应的md文件里有reward:true属性，才有打赏； 2-所有文章均有打赏</span></span>
<span class="line">reward_type: <span class="number">2</span></span>
<span class="line"><span class="comment"># 打赏wording</span></span>
<span class="line">reward_wording: <span class="string">'喜欢的话，支付1元请我吃糖吧！'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 支付宝二维码图片地址，跟你设置头像的方式一样。比如：/assets/img/alipay.jpg</span></span>
<span class="line"><span class="comment"># 支付宝收款1元二维码图片</span></span>
<span class="line">alipay: <span class="regexp">/img/zhifubao</span>01.png</span>
<span class="line"><span class="comment"># 支付宝收款无金额设置二维码图片</span></span>
<span class="line"><span class="comment"># alipay: /img/zhifubao.png</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 微信二维码图片地址</span></span>
<span class="line"><span class="comment"># 微信收款1元二维码图片</span></span>
<span class="line">weixin: <span class="regexp">/img/weixin</span>01.png</span>
<span class="line"><span class="comment"># 微信收款无金额设置二维码图片</span></span>
<span class="line"><span class="comment"># alipay: /img/weixin.png</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改网站收藏夹图标</span></span>
<span class="line">favicon: <span class="regexp">/img/favicon</span>.png</span>
<span class="line"></span>
<span class="line"><span class="comment">#你的头像url</span></span>
<span class="line">avatar: <span class="regexp">/img/avatar</span>.jpg</span>
<span class="line"></span>
<span class="line"><span class="comment"># 根据需要修改以下内容</span></span>
<span class="line"><span class="comment"># 智能菜单</span></span>
<span class="line"><span class="comment"># 如不需要，将该对应项置为false</span></span>
<span class="line"><span class="comment"># 比如</span></span>
<span class="line"><span class="comment">#smart_menu:</span></span>
<span class="line"><span class="comment">#  friends: false</span></span>
<span class="line">smart_menu:</span>
<span class="line">  innerArchive: <span class="string">'所有文章'</span></span>
<span class="line">  friends: <span class="string">'常用网站'</span></span>
<span class="line">  aboutme: <span class="string">'关于我'</span></span>
<span class="line"></span>
<span class="line">friends:</span>
<span class="line">  My Oracle Support: https:<span class="regexp">//support</span>.oracle.com/</span>
<span class="line">  Oracle Edelivery: https:<span class="regexp">//edelivery</span>.oracle.com/</span>
<span class="line">  Oracle Help Center: http:<span class="regexp">//docs</span>.oracle.com/</span>
<span class="line">  练数成金: http:<span class="regexp">//www</span>.dataguru.cn/</span>
<span class="line">  三通IT论坛: http:<span class="regexp">//www</span>.santongit.com/</span>
<span class="line">  一起自学吧: http:<span class="regexp">//www</span>.<span class="number">17</span>zixueba.com/</span>
<span class="line"></span>
<span class="line">aboutme: DBA&lt;br&gt;&lt;br&gt;工作学习笔记&lt;br&gt;谢谢大家</span>
</pre></td></tr></table></figure>
</li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Sublime Text 常用快捷键]]></title>
      <url>/2017/01/30/tools/Sublime%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/</url>
      <content type="html"><![CDATA[<h2 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">↑ ↓ ← →             上下左右移动光标</span>
<span class="line">Alt                 调出菜单</span>
<span class="line">Ctrl + Shift + P    调出命令板（Command Palette）</span>
<span class="line">Ctrl + `            调出控制台</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + Enter            在当前行下面新增一行然后跳至该行</span>
<span class="line">Ctrl + Shift + Enter    在当前行上面增加一行并跳至该行</span>
<span class="line">Ctrl + ←/→              进行逐词移动</span>
<span class="line">Ctrl + Shift + ←/→      进行逐词选择</span>
<span class="line">Ctrl + ↑/↓              移动当前显示区域</span>
<span class="line">Ctrl + Shift + ↑/↓      移动当前行</span>
</pre></td></tr></table></figure>
<h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + D                选择当前光标所在的词并高亮该词所有出现的位置</span>
<span class="line">                        再次 Ctrl + D 选择该词出现的下一个位置，在多重选词的过程中</span>
<span class="line">                        使用 Ctrl + K 进行跳过，使用 Ctrl + U 进行回退，使用 Esc 退出多重编辑</span>
<span class="line">Ctrl + Shift + L        将当前选中区域打散</span>
<span class="line">Ctrl + J                把当前选中区域合并为一行</span>
<span class="line">Ctrl + M                在起始括号和结尾括号间切换</span>
<span class="line">Ctrl + Shift + M        快速选择括号间的内容</span>
<span class="line">Ctrl + Shift + J        快速选择同缩进的内容</span>
<span class="line">Ctrl + Shift + Space    快速选择当前作用域（Scope）的内容</span>
</pre></td></tr></table></figure>
<h2 id="查找amp替换"><a href="#查找-amp-替换" class="headerlink" title="查找&amp;替换"></a>查找&amp;替换</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">F3                  跳至当前关键字下一个位置</span>
<span class="line">Shift + F3          跳到当前关键字上一个位置</span>
<span class="line">Alt + F3            选中当前关键字出现的所有位置</span>
<span class="line">Ctrl + F/H          进行标准查找/替换，之后：</span>
<span class="line">Alt + C             切换大小写敏感（Case-sensitive）模式</span>
<span class="line">Alt + W             切换整字匹配（Whole matching）模式</span>
<span class="line">Alt + R             切换正则匹配（Regex matching）模式</span>
<span class="line">Ctrl + Shift + H    替换当前关键字</span>
<span class="line">Ctrl + Alt + Enter  替换所有关键字匹配</span>
<span class="line">Ctrl + Shift + F    多文件搜索&amp;替换</span>
</pre></td></tr></table></figure>
<h2 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + P        跳转到指定文件，输入文件名后可以：</span>
<span class="line">@ 符号跳转       输入@symbol跳转到symbol符号所在的位置</span>
<span class="line"># 关键字跳转     输入#keyword跳转到keyword所在的位置</span>
<span class="line">: 行号跳转       输入:12跳转到文件的第12行。</span>
<span class="line">Ctrl + R        跳转到指定符号</span>
<span class="line">Ctrl + G        跳转到指定行号</span>
</pre></td></tr></table></figure>
<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + Shift + N    创建一个新窗口</span>
<span class="line">Ctrl + N            在当前窗口创建一个新标签</span>
<span class="line">Ctrl + W            关闭当前标签，当窗口内没有标签时会关闭该窗口</span>
<span class="line">Ctrl + Shift + T    恢复刚刚关闭的标签</span>
</pre></td></tr></table></figure>
<h2 id="屏幕"><a href="#屏幕" class="headerlink" title="屏幕"></a>屏幕</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">F11                             切换至普通全屏</span>
<span class="line">Shift + F11                     切换至无干扰全屏</span>
<span class="line">Alt+Shift+1       Single        切换至独屏</span>
<span class="line">Alt+Shift+2       Columns:2     切换至纵向二栏分屏</span>
<span class="line">Alt+Shift+3       Columns:3     切换至纵向三栏分屏</span>
<span class="line">Alt+Shift+4       Columns:4     切换至纵向四栏分屏</span>
<span class="line">Alt+Shift+8       Rows:2        切换至横向二栏分屏</span>
<span class="line">Alt+Shift+9       Rows:3        切换至横向三栏分屏</span>
<span class="line">Alt+Shift+5       Grid          切换至四格式分屏</span>
</pre></td></tr></table></figure>
<h2 id="插件deleteblanklines"><a href="#插件”DeleteBlankLines”" class="headerlink" title="插件”DeleteBlankLines”"></a>插件”DeleteBlankLines”</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Windows/Linux</span>
<span class="line">Ctrl+Alt+Backspace          删除所有空行</span>
<span class="line">Ctrl+Alt+Shift+Backspace    删除多余空行</span>
<span class="line"></span>
<span class="line"># Mac OS</span>
<span class="line">Ctrl+Alt+Delete             删除所有空行</span>
<span class="line">Ctrl+Alt+Shift+Delete       删除多余空行</span>
</pre></td></tr></table></figure>
<h2 id="插件sublimetmpl"><a href="#插件”SublimeTmpl”" class="headerlink" title="插件”SublimeTmpl”"></a>插件”SublimeTmpl”</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+alt+h          html</span>
<span class="line">ctrl+alt+j          javascript</span>
<span class="line">ctrl+alt+c          css</span>
<span class="line">ctrl+alt+p          php</span>
<span class="line">ctrl+alt+r          ruby</span>
<span class="line">ctrl+alt+shift+p    python</span>
</pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-03 深入MySQL体系结构]]></title>
      <url>/2017/01/28/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/03-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="1-thread-pool的原理是什么"><a href="#1-thread-pool的原理是什么？" class="headerlink" title="1. thread pool的原理是什么？"></a>1. thread pool的原理是什么？</h2><p>线程池的原理很简单，类似于操作系统中的缓冲区的概念，它的流程如下：先启动若干数量的线程，并让这些线程都处于睡眠状态，当客户端有一个新请求时，就会唤醒线程池中的某一个睡眠线程，让它来处理客户端的这个请求，当处理完这个请求后，线程又处于睡眠状态。</p>
<p>MySQL线程池只在MariaDB，Oracle MySQL企业版中提供，Oracle MySQL社区版并不提供。</p>
<p>在传统方式下，MySQL线程调度方式有两种：每个连接一个线程(one-thread-per-connection)和所有连接一个线程（no-threads）。在实际生产中，一般用的是前者。即每当有一个客户端连接到MySQL服务器，MySQL服务器都会为该客户端创建一个单独的线程，请求结束后，销毁线程。连接数越多，则相应的线程会越多。这种方式在高并发情况下，会导致线程的频繁创建和释放。</p>
<a id="more"></a>
<h2 id="2-为什么用double-write就能解决page坏的问题"><a href="#2-为什么用double-write就能解决page坏的问题？" class="headerlink" title="2. 为什么用double write就能解决page坏的问题？"></a>2. 为什么用double write就能解决page坏的问题？</h2><p>InnoDB 的Page Size一般是16KB，其数据校验也是针对这16KB来计算的，将数据写入到磁盘是以Page为单位进行操作的，mysql的page size跟系统文件的page size是不一致的，在写数据的时候, 系统并不是把整个buffer pool page一次性写到disk上，在极端情况下（比如断电）往往并不能保证这一操作的原子性，16K的数据，写入4K时，发生了系统断电/OS crash ，只有一部分写是成功的，这种情况下就是partial page write问题。</p>
<p>mysql在恢复的过程中是检查page的checksum（检验和），checksum就是pgae的最后事务号，发生partial page write问题时，page已经损坏，找不到该page中的事务号，就无法恢复（redo里面是没有保留这个损坏page完全的镜像，就无法从REDO里恢复）。</p>
<p>为了解决 partial page write 问题 ，当mysql将脏数据flush到data file的时候, 先使用memcopy 将脏数据复制到内存中的double write buffer ，之后通过double write buffer再分2次，每次写入1MB到共享表空间，然后马上调用fsync函数，同步到磁盘上，避免缓冲带来的问题，在这个过程中，doublewrite是顺序写，开销并不大，在完成doublewrite写入后，在将double write buffer写入各表空间文件，这时是离散写入。如果发生了极端情况（断电），InnoDB再次启动后，发现了一个Page数据已经损坏，那么此时就可以从double write buffer中进行数据恢复了。</p>
<ul>
<li><strong>double write的优点是什么?</strong><br>double write解决了partial page write的问题，它能保证即使double write部分发生了partial page write但也能恢复。另外一个好处就是double write能减少redo log的量, 有了double write，redo log只记录了二进制的变化量，也就等同于binary log，而通过前段时间的测试确实发现，在double write关闭的情况下，redo log比binary logs要大。</li>
</ul>
<ul>
<li><strong>double write的缺点是什么?</strong><br>虽然mysql称double write是一个buffer, 但其实它是开在物理文件上的一个buffer, 其实也就是file, 所以它会导致系统有更多的fsync操作, 而我们知道硬盘的fsync性能是很慢的, 所以它会降低mysql的整体性能. 但是并不会降低到原来的50%. 这主要是因为: <ol>
<li>double write是一个连接的存储空间, 所以硬盘在写数据的时候是顺序写, 而不是随机写, 这样性能更高。 </li>
<li>另外将数据从double write buffer写到真正的segment中的时候, 系统会自动合并连接空间刷新的方式, 每次可以刷新多个pages。另外将数据从double write buffer写到真正的segment中的时候, 系统会自动合并连接空间刷新的方式, 每次可以刷新多个pages。</li>
</ol>
</li>
</ul>
<ul>
<li><strong>double write在恢复的时候是如何工作的?</strong><br>如果是写double write buffer本身失败，那么这些数据不会被写到磁盘，innodb此时会从磁盘载入原始的数据，然后通过innodb的事务日志来计算出正确的数据，重新写入到double write buffer。如果double write buffer写成功的话，但是写磁盘失败，innodb就不用通过事务日志来计算了，而是直接用buffer的数据再写一遍。在恢复的时候，innodb直接比较页面的checksum，如果不对的话，就从硬盘载入原始数据，再由事务日志开始推演出正确的数据，所以innodb的恢复通常需要较长的时间。</li>
</ul>
<ul>
<li><strong>查看是否开启double write</strong><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%double%'</span>;</span>
<span class="line">+<span class="comment">--------------------+-------+</span></span>
<span class="line">| Variable_name      | Value |</span>
<span class="line">+<span class="comment">--------------------+-------+</span></span>
<span class="line">| innodb_doublewrite | ON    |</span>
<span class="line">+<span class="comment">--------------------+-------+</span></span>
</pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-innodb-redo-log与binlog有什么区别有了innodb-redo-log为什么还要binlog"><a href="#3-InnoDB-redo-log与binlog有什么区别？有了InnoDB-redo-log为什么还要binlog" class="headerlink" title="3. InnoDB redo log与binlog有什么区别？有了InnoDB redo log为什么还要binlog?"></a>3. InnoDB redo log与binlog有什么区别？有了InnoDB redo log为什么还要binlog?</h2><ul>
<li>binlog会记录所有与MySQL数据库有关的日志记录，包括InnoDB、MyISAM、Heap等其他存储引擎的日志；而InnoDB存储引擎的redo log只记录有关该引擎本身的事务日志。</li>
<li>无论将binlog文件记录的格式设为STATEMENT还是ROW，又或是MIXED，其记录的都是关于一个事务的具体操作内容，即该日志是逻辑日志；而InnoDB存储引擎的redo log是关于每个页（page）更改的物理情况。</li>
<li>binlog文件仅在事务提交后进行写入，即只写磁盘一次，不论这时该事务多大；而在事务进行的过程中，却不断有重做日志条目（redo entry）被写入到重做日志文件中。</li>
</ul>
<p>binlog是MySQL Server层记录的日志，所有引擎产生的日志都会通过binlog进行封装；MySQL的特点就是支持多存储引擎，为了兼容绝大部分引擎来支持类似复制这样的特性，就需要采用binlog日志来用实现。简单的说，binlog 是mysqld 记录全局数据结构变化的log，用于复制和恢复；innodb redo log 是innodb 引擎自己记录事务过程的log，用于回滚和crash 恢复。</p>
<h2 id="4-课程笔记"><a href="#4-课程笔记" class="headerlink" title="4. 课程笔记"></a>4. 课程笔记</h2><ol>
<li>MySQL是单进程多线程</li>
<li>MySQL存储引擎是可插拔的，有InnoDB，MyISAM(早期)等</li>
<li>存储引擎是用来处理数据库相关的CRUD的操作</li>
<li>CRUD是指在做计算处理时的增加(Create)、读取(Retrieve)(重新得到数据)、更新(Update)和删除(Delete)几个单词的首字母简写</li>
<li>存储引擎的对象是表</li>
<li>MySQL数据库与实例的关系是一对一的</li>
<li>MySQL的数据库是物理操作系统文件或其他形式文件类型的集合，实例是由数据库后台进程/线程以及一个共享内存区组成</li>
<li><p>MySQL 5.6 InnoDB架构中Buffer Pool<br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_innodb_architecture_00.jpg" alt="mysql_innodb_architecture_00"><br>(1) <code>index page</code>: 数据缓存放在index page里，因MySQL数据的存储结构是Btree，所以称index page，page的概念相当于oracle中的buffer，1 page默认大小16k<br>(2) <code>data dictionary</code>: 数据字典的缓冲，其文件是存放在iblog目录下的ibdata中，如<code>/u01/my3306/log/iblog/ibdata1</code><br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_innodb_architecture_01.png" alt="mysql_innodb_architecture_01"><br>(3) <code>lock info</code>: 行锁放在lock info中，当行锁达到一定值的时候，行锁就会升级为表锁<br>(4) <code>undo page</code>: 缓存UNDO操作，DML操作修改前镜像放到undo page中，其文件也是存放在iblog目录下的ibdata中<br>(5) <code>insert buffer page</code>: 缓存二级索引（非唯一索引，或称辅助索引）<br>(6) <code>adaptive hash index</code>: 自适应哈希索引，InnoDB存储引擎会监控对表上索引的查找，如果观察到建立哈希索引可以带来速度的提升，则建立哈希索引，所以称之为自适应（adaptive）的。自适应哈希索引通过缓冲池的B+树构造而来，因此建立的速度很快。而且不需要将整个表都建哈希索引，InnoDB存储引擎会自动根据访问的频率和模式来为某些页建立哈希索引。<br>(7) <code>Buffer Pool</code>的大小一般设置为物理内存的60%-80%，在MySQL中可以通过以下命令查询：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like '%buffer_pool_size%';</span>
<span class="line">+-------------------------+-----------+</span>
<span class="line">| Variable_name           | Value     |</span>
<span class="line">+-------------------------+-----------+</span>
<span class="line">| innodb_buffer_pool_size | 134217728 |</span>
<span class="line">+-------------------------+-----------+</span>
</pre></td></tr></table></figure>
</li>
<li><p><code>redo log buffer</code>: 缓存redo log，通过redo log thead写到redo log文件中存放在iblog目录下的ibdata中，如<code>/u01/my3306/log/iblog/ib_logfile0</code></p>
</li>
<li>查找算法：链表遍历、二分查找、Btree查找、HASH查找</li>
<li><p>当数据库关闭时，把热块保存(缓存)到文件，在打开时再从文件加载到内存里，参数和设置方法如下：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%dump%'</span>;</span>
<span class="line">+-------------------------------------+-------+</span>
<span class="line">| Variable_name                       | Value |</span>
<span class="line">+-------------------------------------+-------+</span>
<span class="line">| innodb_buffer_pool_dump_at_shutdown | OFF   |</span>
<span class="line">| innodb_buffer_pool_dump_now         | OFF   |</span>
<span class="line">+-------------------------------------+-------+</span>
<span class="line"></span>
<span class="line">set global innodb_buffer_pool_dump_at_shutdown=<span class="number">1</span>;</span>
<span class="line">set global innodb_buffer_pool_dump_now=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">exit</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭数据库</span></span>
<span class="line">mysqladmin <span class="keyword">shutdown</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看缓存的文件</span></span>
<span class="line">ll /u01/my3306/<span class="keyword">log</span>/iblog/</span>
<span class="line">total <span class="number">4145172</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql        <span class="number">884</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ib_buffer_pool   //这个就是缓存的文件</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql   <span class="number">33554432</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ibdata1</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql   <span class="number">16777216</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ibdata2</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ib_logfile<span class="number">0</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">17</span> <span class="number">17</span>:<span class="number">37</span> ib_logfile1</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">17</span> <span class="number">17</span>:<span class="number">37</span> ib_logfile2</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">17</span> <span class="number">17</span>:<span class="number">37</span> ib_logfile3</span>
<span class="line"></span>
<span class="line"><span class="comment"># 指定参数启动数据库</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf &amp;</span>
</pre></td></tr></table></figure>
</li>
<li><p>安装MySQL Utilities<br>(1)选择MySQL Utilities适合的版本下载：<a href="https://dev.mysql.com/downloads/utilities/" target="_blank" rel="external">https://dev.mysql.com/downloads/utilities/</a><br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_utilities_download_00.png" alt="mysql_utilities_download_00"><br>(2)选择Connector/Python适合的版本下载（依赖包）：<a href="https://dev.mysql.com/downloads/connector/python/" target="_blank" rel="external">https://dev.mysql.com/downloads/connector/python/</a><br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_utilities_download_01.png" alt="mysql_utilities_download_01"><br>(3)上传安装包到服务器/tmp目录，并安装（root用户下）</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ll</span>
<span class="line">total <span class="number">32836</span></span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root    <span class="number">258776</span> Jan <span class="number">25</span> <span class="number">11</span>:<span class="number">50</span> mysql-connector-python-<span class="number">2.1</span>.<span class="number">5</span>-<span class="number">1</span>.el6.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root    <span class="number">892500</span> Jan <span class="number">25</span> <span class="number">11</span>:<span class="number">39</span> mysql-utilities-<span class="number">1.6</span>.<span class="number">4</span>-<span class="number">1</span>.el6.noarch.rpm</span>
<span class="line"></span>
<span class="line">rpm -ivh mysql-connector-python-<span class="number">2.1</span>.<span class="number">5</span>-<span class="number">1</span>.el6.x86_64.rpm</span>
<span class="line">rpm -ivh mysql-utilities-<span class="number">1.6</span>.<span class="number">4</span>-<span class="number">1</span>.el6.noarch.rpm</span>
</pre></td></tr></table></figure>
<p>(4)MySQL Utilities–mysqlfrm</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以诊断模式查看表结构定义文件</span></span>
<span class="line">mysqlfrm --diagnostic user.frm</span>
</pre></td></tr></table></figure>
</li>
<li><p>查看错误日志所在位置</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%log_error%'</span>;</span>
<span class="line">+---------------------+---------------------------+</span>
<span class="line">| Variable_name       | Value                     |</span>
<span class="line">+---------------------+---------------------------+</span>
<span class="line">| binlog_error_action | IGNORE_ERROR              |</span>
<span class="line">| log_error           | <span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/error.log |  <span class="comment"># 错误日志所在位置</span></span>
<span class="line">+---------------------+---------------------------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>开启慢查询</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%slow%'</span>;</span>
<span class="line">+---------------------------+--------------------------+</span>
<span class="line">| Variable_name             | Value                    |</span>
<span class="line">+---------------------------+--------------------------+</span>
<span class="line">| log_slow_admin_statements | ON                       |</span>
<span class="line">| log_slow_slave_statements | OFF                      |</span>
<span class="line">| slow_launch_time          | <span class="number">2</span>                        |</span>
<span class="line">| slow_query_log            | ON                       |   <span class="comment"># 开启慢查询</span></span>
<span class="line">| slow_query_log_file       | <span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/slow.log |   <span class="comment"># 慢查询日志位置</span></span>
<span class="line">+---------------------------+--------------------------+ </span>
<span class="line"></span>
<span class="line">mysql&gt; show variables like <span class="string">'%query_time%'</span>;</span>
<span class="line">+-----------------+----------+</span>
<span class="line">| Variable_name   | Value    |</span>
<span class="line">+-----------------+----------+</span>
<span class="line">| long_query_time | <span class="number">1.000000</span> |   <span class="comment"># 慢查询时间为1s</span></span>
<span class="line">+-----------------+----------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>通用日志默认是不开启的（通用日志主要用在数据库审计）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%gen%&apos;;</span>
<span class="line">+------------------+----------------------------+</span>
<span class="line">| Variable_name    | Value                      |</span>
<span class="line">+------------------+----------------------------+</span>
<span class="line">| general_log      | OFF                        |</span>
<span class="line">| general_log_file | /u01/my3306/data/mysql.log |</span>
<span class="line">+------------------+----------------------------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>最大用户连接数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%max_user_connect%&apos;;</span>
<span class="line">+----------------------+-------+</span>
<span class="line">| Variable_name        | Value |</span>
<span class="line">+----------------------+-------+</span>
<span class="line">| max_user_connections | 2800  |</span>
<span class="line">+----------------------+-------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>查出mysqld进程号为27507</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ps -ef | <span class="keyword">grep</span> <span class="number">3306</span></span>
<span class="line"></span>
<span class="line">root      <span class="number">5475</span>  <span class="number">5183</span>  <span class="number">0</span> <span class="number">11</span>:<span class="number">44</span> pts/<span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">grep</span> <span class="number">3306</span></span>
<span class="line">mysql    <span class="number">26656</span>     <span class="number">1</span>  <span class="number">0</span> Jan17 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/sh /u01/my3306/bin/mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf --user=mysql</span>
<span class="line">mysql    <span class="number">27507</span> <span class="number">26656</span>  <span class="number">0</span> Jan17 ?        <span class="number">00</span>:<span class="number">01</span>:<span class="number">32</span> /u01/my3306/bin/mysqld --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf --basedir=<span class="regexp">/u01/my</span>3306 --datadir=<span class="regexp">/u01/my</span>3306/data --plugin-dir=<span class="regexp">/u01/my</span>3306/lib/plugin --<span class="keyword">log</span>-error=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/error.log --<span class="keyword">open</span>-files-limit=<span class="number">65535</span> --pid-file=<span class="regexp">/u01/my</span>3306/run/mysqld.pid --<span class="keyword">socket</span>=<span class="regexp">/u01/my</span>3306/run/mysql.sock --port=<span class="number">3306</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>查看mysqld进程27507下所有线程</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pstack <span class="number">27507</span></span>
<span class="line"></span>
<span class="line">Thread <span class="number">28</span> (Thread <span class="number">0x7f9b070c4700</span> (LWP <span class="number">27508</span>)):</span>
<span class="line"><span class="comment">#0  0x00000038a040b68c in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0</span></span>
<span class="line"><span class="comment">#1  0x00000000009536bb in os_event_wait_low(os_event*, long) ()</span></span>
<span class="line"><span class="comment">#2  0x0000000000950aa6 in os_aio_simulated_handle(unsigned long, fil_node_t**, void**, unsigned long*) ()</span></span>
<span class="line"><span class="comment">#3  0x0000000000a49ed7 in fil_aio_wait(unsigned long) ()</span></span>
<span class="line"><span class="comment">#4  0x00000000009b9638 in io_handler_thread ()</span></span>
<span class="line"><span class="comment">#5  0x00000038a0407aa1 in start_thread () from /lib64/libpthread.so.0</span></span>
<span class="line"><span class="comment">#6  0x00000038a00e8aad in clone () from /lib64/libc.so.6</span></span>
<span class="line"><span class="comment"># ...... 中间略过</span></span>
<span class="line">Thread <span class="number">1</span> (Thread <span class="number">0x7f9b18f637e0</span> (LWP <span class="number">27507</span>)):</span>
<span class="line"><span class="comment">#0  0x00000038a00df283 in poll () from /lib64/libc.so.6</span></span>
<span class="line"><span class="comment">#1  0x0000000000585284 in handle_connections_sockets() ()</span></span>
<span class="line"><span class="comment">#2  0x000000000058cd51 in mysqld_main(int, char**) ()</span></span>
<span class="line"><span class="comment">#3  0x00000038a001ed1d in __libc_start_main () from /lib64/libc.so.6</span></span>
<span class="line"><span class="comment">#4  0x000000000057dbc1 in _start ()</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>read/write thread</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%io_thread%'</span>;</span>
<span class="line">+-------------------------+-------+</span>
<span class="line">| Variable_name           | Value |</span>
<span class="line">+-------------------------+-------+</span>
<span class="line">| innodb_read_io_threads  | <span class="number">4</span>     |     <span class="comment"># 预读</span></span>
<span class="line">| innodb_write_io_threads | <span class="number">10</span>    |</span>
<span class="line">+-------------------------+-------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>purge thread: 清undo page</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%purge%'</span>;</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| Variable_name              | Value |</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| gtid_purged                |       |</span>
<span class="line">| innodb_max_purge_lag       | <span class="number">0</span>     |</span>
<span class="line">| innodb_max_purge_lag_delay | <span class="number">0</span>     |</span>
<span class="line">| innodb_purge_batch_size    | <span class="number">300</span>   |</span>
<span class="line">| innodb_purge_threads       | <span class="number">1</span>     |</span>
<span class="line">| relay_log_purge            | ON    |</span>
<span class="line">+----------------------------+-------+</span>
</pre></td></tr></table></figure></li>
</ol>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[VIM常用命令]]></title>
      <url>/2017/01/28/tools/vim%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<p>文本编辑器是所有计算机系统中最常用的一种工具。UNIX下的编辑器有ex,sed和vi等，其中，使用最为广泛的是vi。 文中是两张<code>VIM键盘图</code>和<code>VIM命令图解</code>。<br><a id="more"></a></p>
<p><img src="http://oligvdnzp.bkt.clouddn.com/vim02.jpg" alt="VIM键盘图"><br><img src="http://oligvdnzp.bkt.clouddn.com/vim01.png" alt="VIM命令图解"></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[GIT常用命令整理]]></title>
      <url>/2017/01/26/tools/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="基本信息设置与查看"><a href="#基本信息设置与查看" class="headerlink" title="基本信息设置与查看"></a>基本信息设置与查看</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &apos;dbanote&apos;</span>
<span class="line">git config --global user.email &apos;15004618839@139.com&apos;</span>
<span class="line"></span>
<span class="line">git config --list</span>
</pre></td></tr></table></figure>
<h2 id="初始化git仓库"><a href="#初始化git仓库" class="headerlink" title="初始化git仓库"></a>初始化git仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git init</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="向本地仓库中添加修改文件"><a href="#向本地仓库中添加-修改文件" class="headerlink" title="向本地仓库中添加/修改文件"></a>向本地仓库中添加/修改文件</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加/修改/删除工作区文件后，保存变动内容到暂存区</span></span>
<span class="line">git add &lt;file&gt;</span>
<span class="line">git add *</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看暂存区状态</span></span>
<span class="line">git status</span>
<span class="line"></span>
<span class="line"><span class="comment"># 暂存区内容提交到git仓库</span></span>
<span class="line">git commit -<span class="keyword">m</span> <span class="string">"git init"</span></span>
</pre></td></tr></table></figure>
<h2 id="push远程仓库"><a href="#PUSH远程仓库" class="headerlink" title="PUSH远程仓库"></a>PUSH远程仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git remote add origin git@github.com:dbanote/08_dbanote.git</span>
<span class="line">git push -u origin master</span>
</pre></td></tr></table></figure>
<h2 id="克隆远程仓库"><a href="#克隆远程仓库" class="headerlink" title="克隆远程仓库"></a>克隆远程仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone git@github.com:dbanote/08_dbanote.git</span>
</pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-02 MySQL标准化、自动化部署]]></title>
      <url>/2017/01/26/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/02-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="为什么数据目录和日志目录需要分开"><a href="#为什么数据目录和日志目录需要分开" class="headerlink" title="为什么数据目录和日志目录需要分开?"></a>为什么数据目录和日志目录需要分开?</h2><p>这里的分开，我理解是将MySQL的数据目录和日志目录分别放到不同类型的磁盘中。<br>假设生产环境中服务器上有两种类型的磁盘，分别是SSD和SAS，SSD比SAS的响应时间要快（SSD响应时间约0.1毫秒，SAS的响应时间约10毫秒），为了更好的利用磁盘，一般会把活跃的数据放到SSD上，冷数据放到SAS磁盘上。<br>数据目录下的数据一般是随机读写的热数据，放到SSD盘中会有较高的响应速度；<br>日志目录下的日志是顺序读写的冷数据，放到SAS盘中满足写日志高吞吐量的需求。<br><a id="more"></a></p>
<h2 id="如何标准化配置多实例例如一台物理主机上部署3306与3307两个实例"><a href="#如何标准化配置多实例-（例如：一台物理主机上部署3306与3307两个实例）" class="headerlink" title="如何标准化配置多实例?（例如：一台物理主机上部署3306与3307两个实例）"></a>如何标准化配置多实例?（例如：一台物理主机上部署3306与3307两个实例）</h2><p>标准化配置多实例，主要是标准化每个实例的目录和内存设置，这样每个实例的参数设置也很容易达到标准化。标准化配置的MYSQL实例，方便实施监控及运维管理。<br>因一个MySQL实例最多占用64G的物理内存，所以在物理内存较高的服务器上，一般会安装多个MySQL实例，MySQL不同实例是通过端口来区别的。<br>例如：一台64G的物理主机上部署3306与3307两个MYSQL实例  </p>
<h3 id="标准化目录"><a href="#标准化目录" class="headerlink" title="标准化目录"></a>标准化目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">实例1：</span>
<span class="line">/data/my3306</span>
<span class="line">/log/my3306</span>
<span class="line"></span>
<span class="line">实例2：</span>
<span class="line">/data/my3307</span>
<span class="line">/log/my3307</span>
<span class="line"></span>
<span class="line"># /data 目录挂载到SSD盘上</span>
<span class="line"># /log  目录挂载到SAS盘上</span>
</pre></td></tr></table></figure>
<h3 id="标准化内存"><a href="#标准化内存" class="headerlink" title="标准化内存"></a>标准化内存</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">实例1：</span>
<span class="line">15G: InnoDB buffer cache</span>
<span class="line">5G : mysql server层</span>
<span class="line"></span>
<span class="line">实例2：</span>
<span class="line">15G: InnoDB buffer cache</span>
<span class="line">5G : mysql server层</span>
<span class="line"></span>
<span class="line">OS:</span>
<span class="line">24G</span>
</pre></td></tr></table></figure>
<h3 id="标准化参数"><a href="#标准化参数" class="headerlink" title="标准化参数"></a>标准化参数</h3><p>结合标准化的目录及内存设置，设置标准化的参数</p>
<h2 id="详细描述mysql编译安装的过程截图安装步骤"><a href="#详细描述MySQL编译安装的过程（截图安装步骤）" class="headerlink" title="详细描述MySQL编译安装的过程（截图安装步骤）"></a>详细描述MySQL编译安装的过程（截图安装步骤）</h2><h3 id="关闭防火墙和selinux"><a href="#关闭防火墙和SELINUX" class="headerlink" title="关闭防火墙和SELINUX"></a>关闭防火墙和SELINUX</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">service iptables status</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">Table: filter</span>
<span class="line">Chain INPUT (policy ACCEPT)</span>
<span class="line">num  target     prot opt source               destination         </span>
<span class="line"><span class="number">1</span>    ACCEPT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           <span class="keyword">state</span> RELATED,ESTABLISHED </span>
<span class="line"><span class="number">2</span>    ACCEPT     icmp --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           </span>
<span class="line"><span class="number">3</span>    ACCEPT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           </span>
<span class="line"><span class="number">4</span>    ACCEPT     tcp  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           <span class="keyword">state</span> NEW tcp dpt:<span class="number">22</span> </span>
<span class="line"><span class="number">5</span>    REJECT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           reject-with icmp-host-prohibited </span>
<span class="line"></span>
<span class="line">Chain FORWARD (policy ACCEPT)</span>
<span class="line">num  target     prot opt source               destination         </span>
<span class="line"><span class="number">1</span>    REJECT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           reject-with icmp-host-prohibited </span>
<span class="line"></span>
<span class="line">Chain OUTPUT (policy ACCEPT)</span>
<span class="line">num  target     prot opt source               destination         </span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">service iptables stop</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">iptables: Setting chains to policy ACCEPT: filter          [  OK  ]</span>
<span class="line">iptables: Flushing firewall rules:                         [  OK  ]</span>
<span class="line">iptables: Unloading modules:                               [  OK  ]</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">service iptables status</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">iptables: Firewall is <span class="keyword">not</span> running.</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">chkconfig iptables off</span>
<span class="line"></span>
<span class="line">vi /etc/selinux/config</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">SELINUX=disabled</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="配置sysctlconf"><a href="#配置sysctl-conf" class="headerlink" title="配置sysctl.conf"></a>配置sysctl.conf</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看服务器内存</span></span>
<span class="line">free</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">             total       used       free     shared    buffers     cached</span>
<span class="line">Mem:       <span class="number">8174352</span>     <span class="number">616628</span>    <span class="number">7557724</span>        <span class="number">172</span>     <span class="number">151904</span>     <span class="number">253892</span></span>
<span class="line">-<span class="regexp">/+ buffers/cache</span>:     <span class="number">210832</span>    <span class="number">7963520</span></span>
<span class="line">Swap:     <span class="number">16531452</span>          <span class="number">0</span>   <span class="number">16531452</span></span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"><span class="comment"># 修改</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"><span class="comment"># kernel.shmmax算法：修改为物理内容的50%、60%</span></span>
<span class="line"><span class="comment"># 8G:kernel.shmmax = (8G*1024*1024*1024*1024)*50% = 4398046511104</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使配置立即生效</span></span>
<span class="line">sysctl -p</span>
</pre></td></tr></table></figure>
<h3 id="检查是否已安装mysql"><a href="#检查是否已安装MySQL" class="headerlink" title="检查是否已安装MySQL"></a>检查是否已安装MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rpm -qa | <span class="keyword">grep</span> mysql</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">mysql-libs-<span class="number">5.1</span>.<span class="number">73</span>-<span class="number">7</span>.el6.x86_64</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除mysql-libs-5.1.73-7.el6.x86_64包</span></span>
<span class="line">rpm -e --nodeps mysql-libs-<span class="number">5.1</span>.<span class="number">73</span>-<span class="number">7</span>.el6.x86_64</span>
</pre></td></tr></table></figure>
<h3 id="下载mysql源码"><a href="#下载MySQL源码" class="headerlink" title="下载MySQL源码"></a>下载MySQL源码</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">Download MySQL Community Server  https:<span class="regexp">//dev</span>.mysql.com/downloads/mysql/<span class="number">5.6</span>.html<span class="comment">#downloads</span></span>
<span class="line">Select Version: <span class="number">5.6</span>.<span class="number">35</span> -&gt; Select Platform: Source Code</span>
<span class="line">-&gt; 选择【Generic Linux (Architecture Independent), Compressed TAR Archive】下载 </span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置yum源，安装lrzsz(代替ftp上传和下载的工具)</span></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line"><span class="keyword">mkdir</span> /media/cdrom</span>
<span class="line">mount /dev/cdrom /media/cdrom</span>
<span class="line"></span>
<span class="line">cp -rf /media/cdrom/* <span class="regexp">/media/disk</span></span>
<span class="line">umount /media/cdrom</span>
<span class="line"></span>
<span class="line">cp /etc/yum.repos.d/public-yum-ol6.repo /etc/yum.repos.d/public-yum-ol6.repo.bak</span>
<span class="line">vi /etc/yum.repos.d/public-yum-ol6.repo</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">name=Oracle Linux $releasever Latest ($basearch)</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span><span class="regexp">/Server</span>
<span class="line">gpgcheck=0</span>
<span class="line">enabled=1</span>
<span class="line">#------------------------------------------------</span>
<span class="line"></span>
<span class="line">yum -y install lrzsz</span>
<span class="line"></span>
<span class="line"># 上传到服务器的/u</span>01目录下</span>
<span class="line"><span class="keyword">mkdir</span> /u01</span>
<span class="line">cd /u01</span>
<span class="line">rz</span>
<span class="line"></span>
<span class="line"><span class="comment"># 选择mysql源码包，上传</span></span>
<span class="line">rz waiting to receive.</span>
<span class="line">Starting zmodem transfer.  Press Ctrl+C to cancel.</span>
<span class="line">Transferring mysql-<span class="number">5.6</span>.<span class="number">35</span>.tar.gz...</span>
<span class="line">  <span class="number">100</span>%   <span class="number">31413</span> KB    <span class="number">15706</span> KB/sec    <span class="number">00</span>:<span class="number">00</span>:<span class="number">02</span>       <span class="number">0</span> Errors </span>
<span class="line"></span>
<span class="line">ll /u01/mysql*</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">32167628</span> Jan <span class="number">17</span> <span class="number">11</span>:<span class="number">16</span> /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span>.tar.gz</span>
</pre></td></tr></table></figure>
<h3 id="添加mysql用户和组"><a href="#添加MySQL用户和组" class="headerlink" title="添加MySQL用户和组"></a>添加MySQL用户和组</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">groupadd -g <span class="number">501</span> mysql</span>
<span class="line">useradd -u <span class="number">501</span> mysql -g mysql</span>
<span class="line">echo <span class="string">"mysql123"</span> | passwd --stdin mysql</span>
<span class="line"></span>
<span class="line">id mysql</span>
<span class="line">uid=<span class="number">501</span>(mysql) gid=<span class="number">501</span>(mysql) groups=<span class="number">501</span>(mysql)</span>
</pre></td></tr></table></figure>
<h3 id="配mysql环境变量"><a href="#配MySQL环境变量" class="headerlink" title="配MySQL环境变量"></a>配MySQL环境变量</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /home/mysql/.bash_profile</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">PATH=$PATH:$HOME/bin:<span class="regexp">/u01/my</span>3306/bin</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="创建目录及授权"><a href="#创建目录及授权" class="headerlink" title="创建目录及授权"></a>创建目录及授权</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/data</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/<span class="keyword">log</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/<span class="keyword">log</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/run</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/tmp</span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01/my3306</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01/my3306</span>
</pre></td></tr></table></figure>
<h3 id="解压mysql56"><a href="#解压mysql5-6" class="headerlink" title="解压mysql5.6"></a>解压mysql5.6</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /u01</span>
<span class="line">tar xvpf mysql-5.6.35.tar.gz</span>
</pre></td></tr></table></figure>
<h3 id="安装cmake及相关依赖包"><a href="#安装cmake及相关依赖包" class="headerlink" title="安装cmake及相关依赖包"></a>安装cmake及相关依赖包</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y  cmake gcc gcc-c++ ncurses-devel bison zlib libxml openssl</span>
</pre></td></tr></table></figure>
<h3 id="编译并安装"><a href="#编译并安装" class="headerlink" title="编译并安装"></a>编译并安装</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line"></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/u01/my</span>3306 \</span>
<span class="line">-DINSTALL_DATADIR=<span class="regexp">/u01/my</span>3306/data  \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DEXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=<span class="number">1</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DMYSQL_UNIX_ADDR=<span class="regexp">/u01/my</span>3306/run/mysql.sock \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/etc \</span>
<span class="line">-DWITH_READLINE=on</span>
<span class="line"></span>
<span class="line"># 第一次CMAKE出现错误提示</span>
<span class="line">#---------------------------------------------------------------------------------------------</span>
<span class="line">CMake Error: The following variables are used in this project, but they are set to NOTFOUND.</span>
<span class="line">Please set them or make sure they are set and tested correctly in the CMake files:</span>
<span class="line">OPENSSL_INCLUDE_DIR</span>
<span class="line">   used as include directory in directory /u</span>01/mysql-<span class="number">5.6</span>.<span class="number">35</span>/CMakeFiles/CMakeTmp</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#安装openssl-devel包</span></span>
<span class="line">yum -<span class="keyword">y</span> install openssl-devel</span>
<span class="line"></span>
<span class="line"><span class="comment">#重新cmake需要删除当前目录下CMakeCache.txt，然后再重新执行</span></span>
<span class="line">rm -rf CMakeCache.txt</span>
<span class="line"></span>
<span class="line"><span class="comment">#编译并安装</span></span>
<span class="line">make</span>
<span class="line">make install</span>
</pre></td></tr></table></figure>
<h3 id="mysql参数配置"><a href="#MySQL参数配置" class="headerlink" title="MySQL参数配置"></a>MySQL参数配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/my3306</span>
<span class="line">vi my.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/my</span>3306/mysql.sock</span>
<span class="line"></span>
<span class="line">[mysql]</span>
<span class="line">pid_file=<span class="regexp">/u01/my</span>3306/run/mysqld.pid</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">1</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/u01/my</span>3306</span>
<span class="line">datadir=<span class="regexp">/u01/my</span>3306/data</span>
<span class="line">max_allowed_packet=<span class="number">1</span>g</span>
<span class="line">max_connections=<span class="number">3000</span></span>
<span class="line">max_user_connections=<span class="number">2800</span></span>
<span class="line">open_files_limit=<span class="number">65535</span></span>
<span class="line">pid_file=<span class="regexp">/u01/my</span>3306/run/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">101</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/my</span>3306/run/mysql.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/my</span>3306/tmp</span>
<span class="line"></span>
<span class="line"><span class="comment">#binlog</span></span>
<span class="line">log_bin=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/error.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/slow.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/relaylog</span>
<span class="line">relay_log_index=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/relay.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/relay-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/my</span>3306/tmp</span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment">#innodb</span></span>
<span class="line">innodb_data_home_dir=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/iblog</span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_format=Barracuda</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/my</span>3306/data</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译后重新修改目录权限</span></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01/my3306</span>
</pre></td></tr></table></figure>
<h3 id="初始化mysql脚本"><a href="#初始化MySQL脚本" class="headerlink" title="初始化MySQL脚本"></a>初始化MySQL脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">cd /u01/my3306/scripts</span>
<span class="line">./mysql_install_db --defaults-file=/u01/my3306/my.cnf \</span>
<span class="line">--datadir=/u01/my3306/data --basedir=/u01/my3306 --user=mysql</span>
</pre></td></tr></table></figure>
<h3 id="启动mysql"><a href="#启动MySQL" class="headerlink" title="启动MySQL"></a>启动MySQL</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/u01/my3306/bin/mysqld_safe --defaults-file=/u01/my3306/my.cnf --user=mysql &amp;</span>
</pre></td></tr></table></figure>
<h3 id="登录mysql"><a href="#登录MySQL" class="headerlink" title="登录MySQL"></a>登录MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">mysql -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -uroot</span>
<span class="line"></span>
<span class="line">Welcome to the MySQL monitor.  Commands end with ; <span class="keyword">or</span> \g.</span>
<span class="line">Your MySQL connection id is <span class="number">2</span></span>
<span class="line">Server version: <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> Source distribution</span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2016</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span>
<span class="line"></span>
<span class="line">Oracle is a registered trademark of Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span>
<span class="line">affiliates. Other names may be trademarks of their respective</span>
<span class="line">owners.</span>
<span class="line"></span>
<span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> to clear the current input statement.</span>
<span class="line"></span>
<span class="line">mysql&gt; show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">+--------------------+</span>
<span class="line"><span class="number">4</span> rows in set (<span class="number">0</span>.<span class="number">01</span> sec)</span>
</pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-01 MySQL 高级DBA职业规划]]></title>
      <url>/2017/01/26/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="什么是mvcc有什么作用"><a href="#什么是MVCC？有什么作用？" class="headerlink" title="什么是MVCC？有什么作用？"></a>什么是MVCC？有什么作用？</h2><p>MVCC是Multiversion Concurrency Control的缩写，中文的意思是多版本并发控制。<br>目前多数DB都采用了这一技术，比如Oracle，PostgreSQL等，但各自的实现机制不尽相同，MVCC没有一个统一的实现标准。<br>MVCC能有效降低锁的开销，虽然不同数据库实现MVCC的机制有所有同，但大都实现了非阻塞的读操作，写操作也只锁定必要的行。</p>
<a id="more"></a>
<h2 id="acid中的i是怎么实现在的"><a href="#ACID中的I是怎么实现在的？" class="headerlink" title="ACID中的I是怎么实现在的？"></a>ACID中的I是怎么实现在的？</h2><ul>
<li>A: 原子性 Atomicity</li>
<li>C: 一致性 Consistency</li>
<li>I: 隔离性 Isolation</li>
<li>D: 持久性 Durability</li>
</ul>
<p><code>I</code>的实现需要对事务进行并发控制，使事务在并发环境中相互隔离，一个事务的执行不能被其他事务干扰。也就是说，不同的事务并发操纵相同的数据时，每个事务都有各自完整的数据空间，一个事务内部的操作及使用的数据对其他并发事务是隔离的，一个事务所做的修改在终提交以前，对其他事务是不可见的。</p>
<h2 id="2pc在数据库中是怎么来实现的"><a href="#2PC在数据库中是怎么来实现的？" class="headerlink" title="2PC在数据库中是怎么来实现的？"></a>2PC在数据库中是怎么来实现的？</h2><p>2PC是Two Phase Commitment Protocol的缩写，中文的意思是两阶段提交协议，用于保证属于多个数据分片上的操作的原子性。这些数据分片可能分布在不同的服务器上，2PC协议保证多台服务器上的操作要么全部成功，要么全部失败。 以ORACLE数据库为例，2PC的实现步骤如下：</p>
<h3 id="阶段一提交事务请求投票阶段"><a href="#阶段一：提交事务请求（投票阶段）" class="headerlink" title="阶段一：提交事务请求（投票阶段）"></a>阶段一：提交事务请求（投票阶段）</h3><ol>
<li><p><strong>事务询问</strong><br>协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应</p>
</li>
<li><p><strong>执行事务</strong><br>各参与者节点执行事务操作，并将Undo和Redo信息计入事务日志中</p>
</li>
<li><p><strong>各参与者向协调者反馈事务询问的响应</strong><br>如果参与者成功执行了事务操作，那么就反馈给协调者Yes响应，表示事务可以执行；<br>如果参与者没有成功执行事务，那么就反馈给协调者No响应，表示事务不可以执行。</p>
</li>
</ol>
<h3 id="阶段二执行事务提交执行阶段"><a href="#阶段二：执行事务提交（执行阶段）" class="headerlink" title="阶段二：执行事务提交（执行阶段）"></a>阶段二：执行事务提交（执行阶段）</h3><h4 id="执行事务提交"><a href="#执行事务提交" class="headerlink" title="执行事务提交"></a>执行事务提交</h4><p>如果所有参与者的反馈都是Yes响应，那么  </p>
<ol>
<li><p><strong>发送提交请求</strong><br>协调者向所有参与者节点发出Commit请求</p>
</li>
<li><p><strong>事务提交</strong><br>参与者接收到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源</p>
</li>
<li><p><strong>反馈事务提交结果</strong><br>参与者在完成事务提交之后，向协调者发送ACK信息</p>
</li>
<li><p><strong>完成事务</strong><br>协调者接收到所有参与者反馈的ACK消息后，完成事务</p>
</li>
</ol>
<h4 id="中断事务"><a href="#中断事务" class="headerlink" title="中断事务"></a>中断事务</h4><p>任何一个参与者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务。</p>
<ol>
<li><p><strong>发送回滚请求</strong><br>协调者向所有参与者节点发出Rollback请求</p>
</li>
<li><p><strong>事务回滚</strong><br>参与者接收到rollback请求后，会利用其在阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放整个事务执行期间占用的资源</p>
</li>
<li><p><strong>反馈事务回滚结果</strong><br>参与者在完成事务回滚之后，向协调者发送ACK信息</p>
</li>
<li><p><strong>中断事务</strong><br>协调者接收到所有参与者反馈的ACK信息后，完成事务中断</p>
</li>
</ol>
<h2 id="简单讲讲capbasepaxos算法"><a href="#简单讲讲CAP-base-paxos算法。" class="headerlink" title="简单讲讲CAP/base/paxos算法。"></a>简单讲讲CAP/base/paxos算法。</h2><h3 id="cap定理"><a href="#CAP定理" class="headerlink" title="CAP定理"></a>CAP定理</h3><p>一个分布式系统不可能同时满足一致性(C: Consistency)、可用性(A: Availibility)和分区容错性(P: Partition tolerance)这三个基本需求，最多只能同时满足其中的两项。<br>其中分区容错性是一个最基本的要求，是一个分布式系统必然需要面对和解决的问题。系统架构设计的主要精力应放在根据业务特点在C（一致性）和A（可用性）之间寻求平衡。</p>
<ul>
<li><strong>一致性</strong><br>在分布式环境中，一致性是指数据在多个副本之间是否能够保持一致的特性。<br>CAP定理应用中的放弃一致性，是指放弃数据的强一致性，而保留数据的最终一致性。这样的系统无法保证数据保持实时的一致性，但是能够承诺的是，数据最终会达到一个一致的状态。具体多久能够达到数据一致取决于系统的设计，主要包括数据副本在不同节点之间的复制时间长短。</li>
</ul>
<ul>
<li><strong>可用性</strong><br>系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。<br>CAP定理应用中的放弃可用性，是指一旦系统遇到网络分区或其他故障时，受到影响的服务需要等待一定的时间，在等待期间系统无法对外提供正常的服务，即不可用。</li>
</ul>
<ul>
<li><strong>分区容错性</strong><br>分区容错性约束了一个分布式系统需要具有如下特性：分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。<br>对于一个分布式系统而言，分区容错性是一个最基本的要求，CAP定理应用中的放弃分区容错性，一种较为简单的做法是将所有的数据（或者仅仅是那些与事务相关的数据）都放在一个分布式节点上，这样就不会碰到由于网络分区带来的负面影响，但放弃P的同时，也就意味着放弃了系统的可扩展性。</li>
</ul>
<h3 id="base理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><p>BASE是Basically Available(基本可用)、 Soft state(软状态) 和Eventually consistent(最终一致性)三个短语的简写。 BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性(Strong Consistency)，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性(Eventually consistent)。</p>
<ul>
<li><strong>基本可用</strong><br>基本可用是指分布式系统在出现不可预知故障时，允许损失部分可用性，如响应时间上的损失，部分非关键功能上的损失。  </li>
</ul>
<ul>
<li><strong>软状态</strong><br>软状态和是指允许系统中的数据存在中间的状态，并认为该中间状态存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。  </li>
</ul>
<ul>
<li><strong>最终一致性</strong><br>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。BASE理论面向的是大型高可用可扩展的分布式系统，和传统事务的ACID强一致性相反，BASE是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。<br>在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的，因此在具体的分布式系统架构设计过程中，ACID特性与BASE理论往往会结合一起使用。  </li>
</ul>
<h3 id="paxos帕克索斯算法"><a href="#Paxos（帕克索斯）算法" class="headerlink" title="Paxos（帕克索斯）算法"></a>Paxos（帕克索斯）算法</h3><p>Paxos是基于消息传递且具有高度容错性的一致性算法。<br>算法要解决的问题就是如何在可能发生的宕机或网络异常的分布式系统中，快速且正确地在集群内部对某个数据的值达成一致，并且保证不论发生以上任何异常，都不会破坏整个系统的一致性。<br>Paxos算法引入了“过半”的理念，通俗的讲就是少数服从多数据的原则。同时，Paxos算法支持分布式节点角色之间的轮换，这极大的避免了分布式单点的出现，因此Paxos算法解决了无限期等待问题，也解决了“脑残”问题，是目前来说最优秀的分布式一致性协议之一。</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hexo+github搭建个人博客]]></title>
      <url>/2017/01/19/tools/hexo+github%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
      <content type="html"><![CDATA[<h2 id="前言我的博客之旅"><a href="#前言：我的博客之旅" class="headerlink" title="前言：我的博客之旅"></a>前言：我的博客之旅</h2><p>我用<code>wordpress</code>写过一段时间博客，因租用的外国空间访问速度不理想，放弃！<br>我用<code>vimwiki</code>写过一段时间博客，因其配置、更新博客比较麻烦，且生成的html也需要存放到租用的空间上才能共享，放弃！<br>我在类似CSDN免费空间上也写过一段时间博客，因没有客户端工具，在线编辑功能受限，且本地不能保存备份博客，放弃！<br>这两年我一直用有道云笔记写博客，其本地编辑功能比较强大，有易用的分类目录和标签功能，单条博客也易于分享，但缺乏一个整体对外的窗口，文章中的代码也无法实现高亮显示，不够美观！<br>2017年初，偶然的机会知道了hexo，因有较强的markdown和git功底，决定开启hexo写博之旅。</p>
<blockquote>
<p><strong>hexo是什么?</strong><br>hexo是一款基于Node.js的静态博客框架。 hexo官网地址：<a href="https://hexo.io" target="_blank" rel="external">https://hexo.io</a></p>
</blockquote>
<a id="more"></a>
<h2 id="为什么选择hexo"><a href="#为什么选择Hexo" class="headerlink" title="为什么选择Hexo"></a>为什么选择Hexo</h2><p>目前比较流行的静态博客框架有<a href="http://jekyllrb.com/" target="_blank" rel="external">Jekyll</a>，Hexo，Simple，Octopress，Pelican以及Lo·gecho等。 这些静态博客框架各有各的好处，之所以选择Hexo，最主要的原因如下：</p>
<ol>
<li>Hexo基于Node.js实现，在Windows上安装Node.js环境简单；而其他的静态博客框架如Jekyll基于Ruby实现，不建议在Windows下搭建的。</li>
<li>Hexo有本地WEB服务器，能实现本地预览，并直接发布到WEB容器(github)中实现同步；而Jekyll没有本地服务器，无法实现本地博文预览。</li>
<li>Hexo主题丰富，基本直接就可以用，不需要太多的修改。</li>
<li>支持Markdown语法。</li>
</ol>
<h2 id="搭建本地博客"><a href="#搭建本地博客" class="headerlink" title="搭建本地博客"></a>搭建本地博客</h2><h3 id="下载并安装git和nodejs"><a href="#下载并安装git和Node-js" class="headerlink" title="下载并安装git和Node.js"></a>下载并安装git和Node.js</h3><p>从以下地址下载所需的Windows版安装包，使用默认设置安装：</p>
<ul>
<li>Node.js: <a href="https://nodejs.org" target="_blank" rel="external">https://nodejs.org</a></li>
<li>git: <a href="https://git-scm.com" target="_blank" rel="external">https://git-scm.com</a></li>
</ul>
<p>安装成功后，可通过以下命令查看安装版本：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ node -v</span>
<span class="line">v6.9.4</span>
<span class="line"></span>
<span class="line">$ git --version</span>
<span class="line">git version 2.11.1.windows.1</span>
</pre></td></tr></table></figure></p>
<h3 id="配置git-bash样式可选"><a href="#配置Git-Bash样式（可选）" class="headerlink" title="配置Git Bash样式（可选）"></a>配置Git Bash样式（可选）</h3><p>新建<code>D:\08_dbanote</code>目录做为博客根目录，进入目录，右键选择Git Bash Here<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-here.jpg" alt="git-bash-here.jpg"></p>
<p>在弹出的窗口上右键选择Options，设置窗口样式<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-01.png" alt="git-bash-01.jpg"></p>
<p>设置显示字体<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-02.jpg" alt="git-bash-02.jpg"></p>
<p>设置窗口大小(需重新开启Git Bash方可生效)<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-03.jpg" alt="git-bash-03.jpg"></p>
<p>设置鼠标右健直接粘贴<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-04.jpg" alt="git-bash-04.jpg"></p>
<h3 id="安装淘宝的cnpm源"><a href="#安装淘宝的cnpm源" class="headerlink" title="安装淘宝的cnpm源"></a>安装淘宝的cnpm源</h3><p>访问国外源速度较慢，建议安装淘宝的cnpm源，以后使用<code>cnpm</code>命令代替<code>npm</code><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span>
</pre></td></tr></table></figure></p>
<h3 id="安装hexo-g-是全局化安装"><a href="#安装hexo-g-是全局化安装" class="headerlink" title="安装hexo (-g 是全局化安装)"></a>安装hexo (-g 是全局化安装)</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-cli -g</span>
</pre></td></tr></table></figure>
<h3 id="初始化hexo博客"><a href="#初始化hexo博客" class="headerlink" title="初始化hexo博客"></a>初始化hexo博客</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 确保当前目录为博客根目录</span></span>
<span class="line">cd D:\08_dbanote</span>
<span class="line">hexo init</span>
<span class="line">cnpm install</span>
</pre></td></tr></table></figure>
<h3 id="安装git部署包"><a href="#安装git部署包" class="headerlink" title="安装git部署包"></a>安装git部署包</h3><p>作用：通过<code>hexo d</code>这一条命令，将博客部署到git服务器上，如github<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-deployer-git --save</span>
</pre></td></tr></table></figure></p>
<h3 id="生成博客静态文件"><a href="#生成博客静态文件" class="headerlink" title="生成博客静态文件"></a>生成博客静态文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo g</span>
</pre></td></tr></table></figure>
<h3 id="启动本地服务器"><a href="#启动本地服务器" class="headerlink" title="启动本地服务器"></a>启动本地服务器</h3><p>确保4000端口没有被占用<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在windows命令行下执行</span></span>
<span class="line">netstat -ano | findstr <span class="string">"4000"</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">16360</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">53443</span>        ESTABLISHED     <span class="number">16360</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">63485</span>        CLOSE_WAIT      <span class="number">16360</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">53443</span>        <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         ESTABLISHED     <span class="number">14256</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">63485</span>        <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         FIN_WAIT_2      <span class="number">14256</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 4000端口被占用，查找进程号对应的程序</span></span>
<span class="line">tasklist | findstr <span class="string">"16360"</span></span>
<span class="line">FoxitProtect.exe             <span class="number">16360</span> Services                   <span class="number">0</span>     <span class="number">11</span>,<span class="number">628</span> K</span>
<span class="line"></span>
<span class="line"><span class="comment"># 结束该进程</span></span>
<span class="line">taskkill /f /t /im FoxitProtect.exe</span>
</pre></td></tr></table></figure></p>
<p>启动本地服务器<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo <span class="keyword">s</span></span>
<span class="line"><span class="comment">#---------------------------------------------------------------------</span></span>
<span class="line">INFO  Start processing</span>
<span class="line">INFO  Hexo is running at http:<span class="regexp">//localhost</span>:<span class="number">4000</span>/. Press Ctrl+C to stop.</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h3 id="本地预览博客"><a href="#本地预览博客" class="headerlink" title="本地预览博客"></a>本地预览博客</h3><p>打开浏览器，输入<a href="http://localhost:4000" target="_blank" rel="external">http://localhost:4000</a><br><img src="http://oligvdnzp.bkt.clouddn.com/hexo_init.png" alt="hexo_init.png"></p>
<h3 id="配置博客网站基本信息"><a href="#配置博客网站基本信息" class="headerlink" title="配置博客网站基本信息"></a>配置博客网站基本信息</h3><p>编辑修改根目录下的<code>_config.yml</code>文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 站点基本信息修改</span></span>
<span class="line"><span class="comment"># Site</span></span>
<span class="line">title: 一个DBA的工作学习笔记</span>
<span class="line">subtitle: 欲事之无繁，则必劳于始而逸于终</span>
<span class="line">author: 刘雅君</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置网站url</span></span>
<span class="line"><span class="comment"># URL</span></span>
<span class="line">url: http:<span class="regexp">//dbanote</span>.github.io</span>
<span class="line"></span>
<span class="line"><span class="comment"># 取消代码段行号显示</span></span>
<span class="line"><span class="comment"># Writing</span></span>
<span class="line">highlight:</span>
<span class="line">  enable: true</span>
<span class="line">  line_number: false</span>
</pre></td></tr></table></figure></p>
<h2 id="部署远程博客"><a href="#部署远程博客" class="headerlink" title="部署远程博客"></a>部署远程博客</h2><h3 id="注册github账号"><a href="#注册Github账号" class="headerlink" title="注册Github账号"></a>注册Github账号</h3><p>因为是托管到<a href="https://github.com/" target="_blank" rel="external">Github</a>上，所以第一步需要注册一个账号。这里我新注册了一个dbanote的帐号，步骤很简单，这里不做赘述。</p>
<h3 id="建立和用户名对应的仓库"><a href="#建立和用户名对应的仓库" class="headerlink" title="建立和用户名对应的仓库"></a>建立和用户名对应的仓库</h3><p>建立和用户名相对应的仓库，这是什么意思呢？以我的例子来说，我的用户名是dbanote,那么我的博客仓库就必须是dbanote.github.io。<br><img src="http://oligvdnzp.bkt.clouddn.com/github_01.png" alt="创建新仓库"><br><img src="http://oligvdnzp.bkt.clouddn.com/github_02.png" alt="创建新仓库"></p>
<h3 id="配置ssh公钥"><a href="#配置SSH公钥" class="headerlink" title="配置SSH公钥"></a>配置SSH公钥</h3><p>远程代码是基于SSH的，所以需要SSH的相关配置。方法是现在本地生成SSH公钥，然后添加到Github上面。打开<code>git bash</code>，具体的操作如下：</p>
<h4 id="1-设置你的邮箱和用户名"><a href="#1-设置你的邮箱和用户名" class="headerlink" title="1. 设置你的邮箱和用户名"></a>1. 设置你的邮箱和用户名</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">git config --global user.name <span class="string">"dbanote"</span></span>
<span class="line">git config --global user.email <span class="string">"15004618839@139.com"</span></span>
</pre></td></tr></table></figure>
<h4 id="2-生成密钥设置密码输入的密码不显示也可以不设置按三次回车密码为空"><a href="#2-生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）" class="headerlink" title="2. 生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）"></a>2. 生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"15004618839@139.com"</span></span>
</pre></td></tr></table></figure>
<p>上述的命令成功后，会得到<code>id_rsa</code>和<code>id_rsa.pub</code>两个文件，一般在<code>C:\Users\&lt;用户名&gt;\.ssh</code>文件夹里，没有的话，就用Everything搜一下。</p>
<h4 id="3-把ssh密钥添加到github上"><a href="#3-把SSH密钥添加到Github上" class="headerlink" title="3. 把SSH密钥添加到Github上"></a>3. 把SSH密钥添加到Github上</h4><p>登陆<code>Github</code>后，点击<code>settings</code>，然后进入<code>SSH keys</code>，把<code>id_rsa.pub</code>文件里内容添加进去就好了。 测试配置是否正确<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ ssh -T git@github.com</span>
<span class="line">Hi dbanote! You’ve successfully authenticated, but GitHub does <span class="keyword">not</span> provide shell access.</span>
</pre></td></tr></table></figure></p>
<h3 id="部署远程博客"><a href="#部署远程博客-1" class="headerlink" title="部署远程博客"></a>部署远程博客</h3><h4 id="1-编辑修改根目录下的_configyml文件"><a href="#1-编辑修改根目录下的-config-yml文件" class="headerlink" title="1. 编辑修改根目录下的_config.yml文件"></a>1. 编辑修改根目录下的<code>_config.yml</code>文件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置部署到github(https方式出现错误，使用ssh方式成功)</span></span>
<span class="line"><span class="comment"># Deployment</span></span>
<span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span>
<span class="line">deploy:</span>
<span class="line">  type: git</span>
<span class="line">  repository: git@github.com:dbanote/dbanote.github.io.git</span>
<span class="line">  branch: master</span>
</pre></td></tr></table></figure>
<h4 id="2-部署远程博客输入以下命令"><a href="#2-部署远程博客，输入以下命令" class="headerlink" title="2. 部署远程博客，输入以下命令"></a>2. 部署远程博客，输入以下命令</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成静态页</span></span>
<span class="line">hexo g</span>
<span class="line"></span>
<span class="line"><span class="comment"># 部署到github上</span></span>
<span class="line">hexo d</span>
</pre></td></tr></table></figure>
<p>部署好了后，在浏览器地址栏中输入你的仓库名来访问，我的是<a href="http://dbanote.github.io" target="_blank" rel="external">dbanote.github.io</a>。注意一点，第一次部署的话，可能需要等待一会（一般不到10分钟就好了）才能生效，以后每次部署就可以直接访问。到这里基本的博客就搭建好了。</p>
<h2 id="tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ol>
<li>注意一定要验证Github的验证邮件。</li>
<li><p>出现其他任何的问题，先删除博客目录下的<code>db.json</code>文件，然后清理再部署远程博客，操作时输入以下的命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo clean</span>
<span class="line">hexo d -g</span>
</pre></td></tr></table></figure>
</li>
<li><p>Hexo的基本命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo g = hexo generate  <span class="comment">#生成</span></span>
<span class="line">hexo <span class="keyword">s</span> = hexo server  <span class="comment">#启动本地预览</span></span>
<span class="line">hexo d = hexo deploy  <span class="comment">#远程部署</span></span>
<span class="line">hexo n <span class="string">"文章标题"</span> = hexo new <span class="string">"文章标题"</span>  <span class="comment">#新建一篇博文</span></span>
<span class="line"></span>
<span class="line">hexo <span class="keyword">s</span> -g  <span class="comment">#等同先输入hexo g，再输入hexo s</span></span>
<span class="line">hexo d -g  <span class="comment">#等同先输入hexo g，再输入hexo d</span></span>
</pre></td></tr></table></figure></li>
</ol>
]]></content>
    </entry>
    
  
  
</search>
